<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Agentåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="/eth-logo.svg" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1680px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
            max-width: 1680px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
            vertical-align: -4px;
            background: none;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        /* åŠ è½½å ä½ï¼šå­—ä½“å°ä¸”æ·¡é»„è‰² */
        .metric-value.loading-inline {
            font-size: 1.2em;
            color: #f6e58d;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* é¡¶éƒ¨å³ä¾§è¯Šæ–­é¢æ¿æŒ‰é’® */
        .inspect-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        /* ç‹¬ç«‹æ°”æ³¡é€æ˜æŒ‰é’®ï¼ˆä¸ä¾èµ– .btnï¼‰ */
        .bubble-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 16px;border-radius:12px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.06);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,.35);font-weight:600;letter-spacing:.2px;cursor:pointer;outline:none;transition:transform .2s ease, box-shadow .3s ease, background .3s ease, border-color .3s ease, color .3s ease;box-shadow:inset 0 1px 0 rgba(255,255,255,.2), 0 4px 16px rgba(46,126,255,.18);}
        .bubble-btn .label{position:relative;z-index:2}
        .bubble-btn .ring{position:absolute;inset:-2px;border-radius:inherit;padding:1px;background:conic-gradient(from 0deg,#79c0ff,#a78bfa,#60a5fa,#79c0ff);mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.9;transition:opacity .3s ease, filter .3s ease;filter:blur(.5px);}
        .bubble-btn::before{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(120% 60% at 30% 10%, rgba(255,255,255,.45), rgba(255,255,255,.1) 60%, transparent 70%), radial-gradient(120% 80% at 70% 120%, rgba(59,130,246,.25), transparent 60%);z-index:1;}
        .bubble-btn::after{content:"";position:absolute;left:10px;top:6px;width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.85);filter:blur(1px);opacity:.9;z-index:2;}
        .bubble-btn:hover{transform:translateY(-2px);box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 8px 24px rgba(46,126,255,.25);background:rgba(255,255,255,.08);color:#e2e8f0;}
        .bubble-btn:active{transform:translateY(0);box-shadow:inset 0 2px 6px rgba(0,0,0,.25), 0 4px 12px rgba(46,126,255,.25);}
        .bubble-btn:focus-visible{outline:2px solid rgba(125,211,252,.6);outline-offset:2px}
        .bubble-btn.disabled, .bubble-btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;}
        .bubble-btn .ring{animation:spin 3.8s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* ç°æš—ç¦ç”¨æ€ */
        .btn:disabled, .btn.disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%) !important;
            box-shadow: none !important;
            transform: none !important;
            cursor: not-allowed;
            color: #ffffff !important;
            opacity: 1 !important;
        }
        .btn-success:disabled, .btn-danger:disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%) !important;
        }
        
        .signal-display {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
            transition: width 0.3s;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .footer p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* æ–°å¢ï¼šæ¨èå¡ç‰‡æ ·å¼ */
        .trading-recommendation {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #eef2f7;
        }
        .trading-recommendation .row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 14px;
            color: #555;
        }
        .trading-recommendation .key { color: #7f8c8d; }
        .trading-recommendation .val { color: #2c3e50; font-weight: 600; }
        .trading-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* æ¨èå†å²æ ·å¼ */
        .recommendation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .recommendation-controls select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            color: #ffffff;
        }
        
        .recommendation-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .recommendation-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* æ¨èè¡¨æ ¼æ ·å¼ */
        .recommendation-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .recommendation-table th,
        .recommendation-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .recommendation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .recommendation-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .recommendation-row.pending {
            background-color: #fff3cd;
        }
        
        .recommendation-row.active {
            background-color: #d1ecf1;
        }
        
        .recommendation-row.closed {
            background-color: #d4edda;
        }
        
        .recommendation-row.expired {
            background-color: #f8d7da;
        }
        
        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-badge.long {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-badge.short {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-badge.hold {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge.active {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-badge.closed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* æ–°å¢ï¼šå‡ºåœºåŸå› å°å¾½æ ‡ */
        .reason-badge {
            display: inline-block;
            margin-left: 6px;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            color: #374151;
            background: #eef2ff;
            border: 1px solid #e5e7eb;
            vertical-align: middle;
            line-height: 1;
        }
        
        .pnl-value.positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .pnl-value.negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .recommendation-item.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .recommendation-item.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .recommendation-item.stopped {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .recommendation-action {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .recommendation-action.LONG {
            background: #dcfce7;
            color: #166534;
        }
        
        .recommendation-action.SHORT {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .recommendation-action.HOLD {
            background: #f3f4f6;
            color: #374151;
        }
        
        .recommendation-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .recommendation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 13px;
        }
        
        .recommendation-detail {
            display: flex;
            justify-content: space-between;
        }
        
        .recommendation-detail .label {
            color: #6b7280;
        }
        
        .recommendation-detail .value {
            font-weight: 500;
        }
        
        .recommendation-pnl {
            font-weight: 600;
        }
        
        .recommendation-pnl.positive {
            color: #10b981;
        }
        
        .recommendation-pnl.negative {
            color: #ef4444;
        }
        
        .recommendation-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* æ–°å¢ï¼šè¡Œæƒ…å¡ç‰‡å†…è”çŠ¶æ€æç¤º */
        .inline-status { display: inline-block; font-size: 12px; color: #7f8c8d; margin-top: 8px; }
        .inline-status.ok { color: #27ae60; }
        .inline-status.warn { color: #f39c12; }
        .inline-status.err { color: #e74c3c; }
        .card h2 .inline-status { margin-left: auto; margin-top: 0; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                gap: 15px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
        /* åˆ†é¡µæ ·å¼ */
        .pagination{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin:8px 0 16px}
        .pagination .page-btn,.pagination .page-number{padding:6px 10px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:13px}
        .pagination .page-number.active{background:#3498db;color:#fff;border-color:#3498db}
        .pagination .page-btn[disabled]{opacity:.5;cursor:not-allowed}
        .pagination .page-info{margin-left:8px;color:#6b7280;font-size:12px}
        /* FGI åŠåœ†ä»ªè¡¨ç›˜æ ·å¼ */
        .section-sep{height:1px;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(148,163,184,.35) 15%,rgba(148,163,184,.35) 85%,rgba(255,255,255,0));margin:10px 0 12px}
        .fgi-header{font-size:14px;color:#6b7280;letter-spacing:.4px;margin:-2px 0 2px}
        .fgi-gauge{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px 0 2px}
        .fgi-gauge svg{width:100%;max-width:420px;height:200px;overflow:visible}
        .fgi-track{fill:none;stroke:#e5e7eb;stroke-width:14;opacity:.45}
        .fgi-arc{fill:none;stroke-width:14;stroke-linecap:butt;opacity:1;transition:opacity .3s ease;stroke-dasharray:18 82}
        /* äº”ç­‰åˆ†+ç©ºç™½åˆ†éš”ï¼šæ¯æ®µ18% + 2%é—´éš”ï¼Œèµ·ç‚¹åˆ†åˆ«ä¸º 0/20/40/60/80 */
        #arc-red{stroke-dashoffset:0}
         #arc-orange{stroke-dashoffset:-20.5}
         #arc-yellow{stroke-dashoffset:-41}
         #arc-green{stroke-dashoffset:-61.5}
         #arc-darkgreen{stroke-dashoffset:-82}
        .fgi-dot{filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));transition:cx .5s cubic-bezier(.22,1,.36,1), cy .5s cubic-bezier(.22,1,.36,1);fill:#fff;stroke:#0f172a;stroke-width:3}
        .fgi-value{font-size:40px;font-weight:800;color:#111827;margin-top:-10px;text-shadow:0 1px 1px rgba(0,0,0,.07)}
        .fgi-label{font-size:13px;color:#6b7280;margin-top:4px}
        .fgi-legend{font-size:12px;color:#9ca3af;margin-top:2px}
        
        /* æ¡ä»¶å‚æ•°æŒ‰é’®æ ·å¼ */
        .conditions-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .conditions-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .conditions-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="inspect-fab">
        <button class="bubble-btn" onclick="openInspect()"><span class="label">æ•°æ®ä¸æŒ‡æ ‡è¯Šæ–­é¢æ¿</span><span class="ring"></span></button>
    </div>
    <div class="container">
        <div class="header">
            <h1 style="display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="/eth-logo.svg" alt="ETH" width="36" height="36" style="transform: translateY(4px);"/>
                 ETH Agentåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ
             </h1>
            <p>åŸºäºæœºå™¨å­¦ä¹ çš„AI Agenté‡åŒ–äº¤æ˜“ç­–ç•¥åˆ†æå¹³å°</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç­–ç•¥å¼•æ“</span>
                </div>
                 <div class="status-item">
                    <div class="status-dot"></div>
                    <span>Kronosæ¨¡å‹</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>MLåˆ†æ</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>é£é™©ç®¡ç†</span>
                </div>
            </div>
        </div>
        <!-- ç§»é™¤äº¤æ˜“æˆæœ¬ä¿¡æ¯ -->
        <div id="costInfo" style="display:none"></div>
        <div class="main-grid">
            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <h2><span class="card-icon">ğŸ’¹</span>å¸‚åœºæ•°æ® <span id="marketInlineStatus" class="inline-status warn"></span></h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentPrice">--</div>
                        <div class="metric-label">å½“å‰ä»·æ ¼</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="priceChange">--</div>
                        <div class="metric-label">ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volume">--</div>
                        <div class="metric-label">24hæˆäº¤é¢(æŒ‰å¼ æŠ˜ç®—, USDT)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volatility">--</div>
                        <div class="metric-label">æŒ¯å¹…</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="lowHigh24h">--</div>
                        <div class="metric-label">24hæœ€ä½/æœ€é«˜</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="fundingRate">--</div>
                        <div class="metric-label">èµ„é‡‘è´¹ç‡(8h)</div>
                    </div>
                </div>
                <div class="section-sep"></div>
                <div class="fgi-header">ææƒ§è´ªå©ªæŒ‡æ•°</div>
                <div class="fgi-gauge" id="fgiGauge">
                    <svg viewBox="0 0 200 100" preserveAspectRatio="xMidYMid meet">
                        <path class="fgi-track" d="M10,100 A90,90 0 0 1 190,100"/>
                        <path class="fgi-arc" id="arc-red" d="M10,100 A90,90 0 0 1 190,100" stroke="#b91c1c" pathLength="100"/>
                         <path class="fgi-arc" id="arc-orange" d="M10,100 A90,90 0 0 1 190,100" stroke="#ef4444" pathLength="100"/>
                         <path class="fgi-arc" id="arc-yellow" d="M10,100 A90,90 0 0 1 190,100" stroke="#facc15" pathLength="100"/>
                         <path class="fgi-arc" id="arc-green" d="M10,100 A90,90 0 0 1 190,100" stroke="#10b981" pathLength="100"/>
                         <path class="fgi-arc" id="arc-darkgreen" d="M10,100 A90,90 0 0 1 190,100" stroke="#065f46" pathLength="100" style="stroke-dasharray:18.05 81.95"/>
                        <circle id="fgiDot" class="fgi-dot" cx="100" cy="100" r="8" />
                    </svg>
                    <div class="fgi-value" id="fgiValue">--</div>
                    <div class="fgi-label" id="fgiLabel">ä¸­æ€§</div>
                </div>
            </div>
            <!-- å¼€å•æ¨è -->
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2><span class="card-icon" style="background:none !important;">ğŸ¯</span>å¼€å•æ¨è</h2>
                    <button class="conditions-btn" onclick="openConditionsPage()" title="æŸ¥çœ‹æ¨èæ¡ä»¶">
                        âš™ï¸ æ¡ä»¶å‚æ•°
                    </button>
                </div>
                <div class="trading-recommendation" id="tradingRecommendation">
                    <div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="recommendedAction">--</div>
                        <div class="metric-label">æ¨èæ“ä½œ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="entryPrice">--</div>
                        <div class="metric-label">å…¥åœºä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="recommendedLeverage">--</div>
                        <div class="metric-label">æ¨èæ æ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSizeRecommend">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <div class="trading-buttons">
                    <button id="btnLong" class="btn btn-success" onclick="openLongPosition()">ğŸ“ˆ åšå¤š (LONG)</button>
                    <button id="btnShort" class="btn btn-danger" onclick="openShortPosition()">ğŸ“‰ åšç©º (SHORT)</button>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    å»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·æ³¨æ„é£é™©æ§åˆ¶
                </div>
            </div>

            <!-- æ¨èå†å² -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“‹</span>æ¨èå†å² <span id="recommendationInlineStatus" class="inline-status warn"></span></h2>
                
                <!-- ç­›é€‰å’Œæ’åºæ§ä»¶ -->
                <div class="recommendation-controls">
                    <select id="statusFilter" onchange="filterRecommendations()">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="ACTIVE">è¿›è¡Œä¸­</option>
                        <option value="CLOSED">å·²å¹³ä»“</option>
                    </select>
                    
                    <select id="sortBy" onchange="sortRecommendations()">
                        <option value="created_at">æŒ‰æ—¶é—´æ’åº</option>
                        <option value="pnl_percent">æŒ‰æ”¶ç›Šæ’åº</option>
                        <option value="confidence_score">æŒ‰ç½®ä¿¡åº¦æ’åº</option>
                    </select>
                    
                    <select id="sortOrder" onchange="sortRecommendations()">
                        <option value="desc">é™åº</option>
                        <option value="asc">å‡åº</option>
                    </select>
                    
                    <button class="btn btn-sm" onclick="refreshRecommendations()">åˆ·æ–°</button>
                    <button id="deleteSelectedBtn" class="btn btn-sm btn-danger" onclick="deleteSelectedRecommendations()" disabled>åˆ é™¤æ‰€é€‰(0)</button>
                </div>
                
                <div class="recommendation-table-container">
                    <table class="recommendation-table" id="recommendationTable">
                        <thead>
                            <tr>
                                <th style="width:36px;text-align:center"><input type="checkbox" id="selectAllRecs" onclick="toggleSelectAll(this)"/></th>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>å…¥åœºä»·</th>
                                <th>æ æ†</th>
                                <th>æ­¢ç›ˆ</th>
                                <th>æ­¢æŸ</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>&nbsp;&nbsp;çŠ¶æ€</th>
                                <th>å¹³ä»“ä»·</th>
                                <th>æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody id="recommendationTableBody">
                            <tr>
                                <td colspan="11" class="loading">æ­£åœ¨åŠ è½½æ¨èè®°å½•...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="recommendationPagination" class="pagination"></div>
                <div id="timeInsights" class="time-insights"></div>
                <div class="recommendation-stats" id="recommendationStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRecommendations">--</span>
                        <span class="stat-label">æ€»æ¨èæ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRecommendations">--</span>
                        <span class="stat-label">æ´»è·ƒä¸­</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="winRateRecommendations">--</span>
                        <span class="stat-label">èƒœç‡</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgPnlRecommendations">--</span>
                        <span class="stat-label">å¹³å‡æ”¶ç›Š</span>
                    </div>
                </div>
            </div>
            
            <!-- å®æ—¶ç­–ç•¥åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“Š</span>å®æ—¶ç­–ç•¥åˆ†æ</h2>
                <div id="currentSignal" class="signal-display">
                    <div class="loading">æ­£åœ¨è·å–æœ€æ–°ä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="signalStrength">--</div>
                        <div class="metric-label">ä¿¡å·å¼ºåº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="confidence">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshSignal()">ğŸ”„ åˆ·æ–°ä¿¡å·</button>
            </div>
            
            <!-- ç­–ç•¥æ€§èƒ½ -->
            <div class="card">
                <h2 style="display:flex;align-items:center;justify-content:space-between;gap:12px">
                    <span style="display:inline-flex;align-items:center;gap:8px"><span class="card-icon" style="background:none;width:auto;height:auto;line-height:1;font-size:20px">ğŸ“ˆ</span><span>ç­–ç•¥æ€§èƒ½</span></span>
                    <button class="bubble-btn" onclick="window.open('/backtest-report-latest.html','_blank')" title="æŸ¥çœ‹å›æµ‹æ€§èƒ½æŠ¥å‘Š">
                        <span class="ring" aria-hidden="true"></span>
                        <span class="label">æŸ¥çœ‹æŠ¥å‘Š</span>
                    </button>
                </h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="totalReturn">--</div>
                        <div class="metric-label">æ€»æ”¶ç›Šç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">--</div>
                        <div class="metric-label">èƒœç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">--</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">--</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                </div>
                <div class="order-progress-header" style="display:flex;align-items:center;justify-content:space-between;margin-top:10px">
  <div class="metric-label" style="margin:0">ç­–ç•¥å•è¿›åº¦</div>
</div>
<div id="perfOrderProgressList" class="order-progress-list" style="display:flex;flex-direction:column;gap:8px;margin-top:6px"></div>
            </div>

            <!-- æ»‘ç‚¹åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“Š</span>æ»‘ç‚¹åˆ†æ <span id="slippageInlineStatus" class="inline-status warn"></span><button id="refreshSlippageBtn" title="ä»…åˆ·æ–°æ»‘ç‚¹" style="margin-left:8px;font-size:12px;padding:4px 8px;border:1px solid #e5e7eb;border-radius:6px;background:#fff;color:#374151;cursor:pointer">åˆ·æ–°</button></h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="avgSlippage">--</div>
                        <div class="metric-label">å¹³å‡æ»‘ç‚¹</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxSlippage">--</div>
                        <div class="metric-label">æœ€å¤§æ»‘ç‚¹</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="slippageThreshold">--</div>
                        <div class="metric-label">å½“å‰é˜ˆå€¼</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="slippageTrend">--</div>
                        <div class="metric-label">æ»‘ç‚¹è¶‹åŠ¿</div>
                    </div>
                </div>
                
                <!-- æ»‘ç‚¹å›¾è¡¨å®¹å™¨ -->
                <div class="chart-container" style="margin: 20px 0; height: 200px; position: relative;">
                    <canvas id="slippageChart" width="400" height="200"></canvas>
                </div>
                
                <!-- é˜ˆå€¼è°ƒæ•´çŠ¶æ€ -->
                <div class="threshold-status" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; font-size: 14px;">
                    <div style="display: flex; align-items: center; gap: 8px; justify-content: flex-start; flex-wrap: wrap;">
                        <span>è‡ªåŠ¨é˜ˆå€¼è°ƒæ•´:</span>
                        <span id="autoAdjustmentStatus" style="font-weight: 600; color: #166534; background:#ecfdf5; border:1px solid #bbf7d0; padding:2px 6px; border-radius:6px;">å¯ç”¨</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        æœ€åè°ƒæ•´: <span id="lastAdjustmentTime">--</span>
                    </div>
                </div>
                

            </div>
            
            <!-- é£é™©ç®¡ç† --><!-- åˆ é™¤ -->
            
            <!-- å®æ—¶ç­–ç•¥åˆ†æ --><!-- åˆ é™¤ -->
            
            <!-- å›æµ‹åˆ†æ --><!-- åˆ é™¤ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ›¡ï¸</span>é£é™©ç®¡ç†</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">--</div>
                        <div class="metric-label">é£é™©è¯„åˆ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSize">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="stopLoss">--</div>
                        <div class="metric-label">æ­¢æŸä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="takeProfit">--</div>
                        <div class="metric-label">æ­¢ç›ˆä»·ä½</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="viewRiskManagement()">âš™ï¸ é£é™©è®¾ç½®</button>
            </div>

            <!-- å›æµ‹åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ”¬</span>å›æµ‹åˆ†æ</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value">å†å²éªŒè¯</div>
                        <div class="metric-label">ç­–ç•¥æœ‰æ•ˆæ€§</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">å¤šç»´åˆ†æ</div>
                        <div class="metric-label">æ€§èƒ½è¯„ä¼°</div>
                    </div>
                </div>
                <a href="/backtest" class="btn"><img src="/eth-logo.svg" alt="ETH" width="16" height="16" style="vertical-align:-3px;margin-right:6px"/> å¼€å§‹å›æµ‹</a>
                <button class="btn btn-success" onclick="viewBacktestHistory()">ğŸ“‹ å†å²è®°å½•</button>
            </div>
        </div>
        
        <div class="footer">
            <p>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ - åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“å¹³å°</p>
            <div class="footer-links">
                <a href="/api/strategy/status">APIçŠ¶æ€</a>
                <a href="/api/risk/status">é£é™©ç®¡ç†</a>
                <a href="/backtest">å›æµ‹åˆ†æ</a>
                <a href="/api/config">ç³»ç»Ÿé…ç½®</a>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åˆå§‹åŒ–åçš„UIè°ƒæ•´ï¼šåˆ é™¤ä¸‰ä¸ªæ¿å—å¹¶é‡æ’é¡ºåº
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const grid = document.querySelector('.main-grid');
                if (!grid) return;
                const getCardByTitle = (title) => {
                    const cards = Array.from(grid.querySelectorAll('.card'));
                    return cards.find(c => {
                        const h = c.querySelector('h2');
                        return h && h.textContent && h.textContent.includes(title);
                    });
                };
                // åˆ é™¤ä¸éœ€è¦çš„ä¸‰ä¸ªæ¿å—
                ['é£é™©ç®¡ç†','å®æ—¶ç­–ç•¥åˆ†æ','å›æµ‹åˆ†æ'].forEach(t => {
                    const el = getCardByTitle(t);
                    if (el && el.parentElement === grid) el.remove();
                });
                // ç¡®ä¿â€œç­–ç•¥æ€§èƒ½â€åœ¨å‰ï¼Œâ€œæ¨èå†å²â€åœ¨å…¶å
                const perf = getCardByTitle('ç­–ç•¥æ€§èƒ½');
                const rec = getCardByTitle('æ¨èå†å²');
                if (grid && perf && rec && rec.previousElementSibling !== perf) {
                    grid.insertBefore(rec, perf.nextSibling);
                }
            } catch (e) {
                console.warn('UI auto adjust failed:', e);
            }
        });
        let updateInterval;
        window.__historyLoading = false;
        window.__historyPending = false;
        let lastMarketOk = false;
        let lastMarketUpdate = 0;

        // å†™æ“ä½œåï¼šæ‹¦æˆª fetchï¼Œé’ˆå¯¹å…³é”®å†™æ¥å£ï¼ˆ/api/recommendationsã€/api/strategy/start|stop ç­‰ï¼‰
        // åœ¨è¯·æ±‚æˆåŠŸåè§¦å‘ä¸€æ¬¡â€œç«‹å³åˆ·æ–°â€ï¼ˆå¸¦å»æŠ–ï¼Œé¿å…æ‰¹é‡åˆ é™¤è§¦å‘å¤šæ¬¡ï¼‰
        (function(){
            const _origFetch = window.fetch.bind(window);
            let _refreshTimer = null;
            function scheduleImmediateRefresh(){
                if (_refreshTimer) clearTimeout(_refreshTimer);
                _refreshTimer = setTimeout(async () => {
                    try {
                        await loadRecommendationHistory(true);
                        await updateRecommendationStats();
                    } catch (e) {
                        console.warn('å³æ—¶åˆ·æ–°å¤±è´¥ï¼š', e);
                    }
                }, 150); // 150ms å»æŠ–
            }
            function shouldTriggerImmediateRefresh(url, method){
                // ç»Ÿä¸€ä¸ºå¤§å†™æ–¹æ³•
                const m = String(method || 'GET').toUpperCase();
                // æ¨èç›¸å…³ï¼šæ–°å¢/ä¿®æ”¹/åˆ é™¤/å…³é—­
                if ((m === 'POST' || m === 'PUT' || m === 'DELETE') && /\/api\/recommendations(\b|\/)/.test(url)) return true;
                // ç­–ç•¥å¯åœï¼šå¯èƒ½å½±å“åç»­æ¨èç”Ÿæˆï¼Œåˆ·æ–°åˆ—è¡¨/ç»Ÿè®¡æ›´ç›´è§‚
                if (m === 'POST' && /\/api\/strategy\/(start|stop)(\b|\/)/.test(url)) return true;
                return false;
            }
            window.fetch = async function(input, init){
                const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
                const method = (init && init.method) || (typeof input === 'object' && input && input.method) || 'GET';
                const res = await _origFetch(input, init);
                try {
                    if (res && res.ok && shouldTriggerImmediateRefresh(url, method)) scheduleImmediateRefresh();
                } catch (_) { /* ignore */ }
                return res;
            };
        })();

        // å·¥å…·å‡½æ•°ï¼šæ‰“å¼€è¯Šæ–­é¡µ
        function openInspect() {
            window.open('/inspect.html','_blank');
        }

        // æ•°å­—æ ¼å¼åŒ–ï¼ˆUSDTï¼‰
        function formatUSDT(val) {
            if (typeof val !== 'number' || !isFinite(val)) return 'â€”';
            const abs = Math.abs(val);
            if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'B USDT';
            if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'M USDT';
            if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'K USDT';
            return val.toFixed(2) + ' USDT';
        }

        // æ—¶é—´æ ¼å¼åŒ– HH:MM:SS
        function fmtTime(ts) {
            const d = new Date(ts);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        
        // è¯·æ±‚å·¥å…·ï¼šæ”¯æŒè¶…æ—¶ä¸æŒ‡æ•°é€€é¿é‡è¯•
        async function requestJsonWithRetry(url, options = {}, cfg = { retries: 2, timeoutMs: 5000, backoffMs: 600 }) {
            let attempt = 0;
            let lastErr;
            while (attempt <= (cfg.retries ?? 0)) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), cfg.timeoutMs ?? 5000);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    lastErr = e;
                    // æ›´æ–°å†…è”çŠ¶æ€ä¸ºé‡è¯•ä¸­
                    const st = document.getElementById('marketInlineStatus');
                    if (st) {
                        st.className = 'inline-status warn';
                        st.textContent = 'è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•...';
                    }
                    if (attempt === (cfg.retries ?? 0)) break;
                    const delay = (cfg.backoffMs ?? 600) * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
                attempt++;
            }
            throw lastErr;
        }
        
        // åŸºäºåˆçº¦ä¿¡æ¯çš„å›é€€æ¸²æŸ“ï¼ˆå½“ /api/market/ticker å¤±è´¥æ—¶ï¼‰
        function updateDomWithMarketFallback(contract) {
            try {
                const priceEl = document.getElementById('currentPrice');
                const changeElLegacy = document.getElementById('priceChange');
                const volumeEl = document.getElementById('volume');
                const volEl = document.getElementById('volatility');
                const lowHighEl = document.getElementById('lowHigh24h');
                const fundingEl = document.getElementById('fundingRate');
                const mark = Number(contract && contract.markPrice);
                if (priceEl) {
                    if (Number.isFinite(mark)) {
                        priceEl.textContent = '$' + mark.toFixed(2);
                    } else {
                        priceEl.textContent = '--';
                    }
                }
                if (changeElLegacy) {
                    const pct24h = Number(contract && contract.priceChangePercent24h);
                    if (Number.isFinite(pct24h)) {
                        changeElLegacy.textContent = pct24h.toFixed(2) + '%';
                        changeElLegacy.style.color = pct24h >= 0 ? '#10b981' : '#ef4444';
                    } else {
                        changeElLegacy.textContent = 'â€”';
                        changeElLegacy.style.color = '#6b7280';
                    }
                }
                if (volumeEl) {
                    const t = Number(contract && contract.turnover24h);
                    if (Number.isFinite(t)) {
                        volumeEl.textContent = formatUSDT(t);
                    } else {
                        volumeEl.textContent = 'â€”';
                    }
                }
                if (volEl) {
                    // æ— é«˜ä½ä»·ä¿¡æ¯ï¼Œæ— æ³•è®¡ç®—æŒ¯å¹…ï¼Œç½®ä¸ºå ä½
                    volEl.textContent = 'â€”';
                    volEl.classList.remove('loading-inline');
                }
                if (lowHighEl) {
                    lowHighEl.textContent = '--';
                }
                if (fundingEl) {
                    const fr = Number(contract && contract.fundingRate);
                    fundingEl.textContent = (Number.isFinite(fr)) ? (fr * 100).toFixed(4) + '%' : '--';
                }
            } catch (e) {
                console.warn('å›é€€æ¸²æŸ“å¤±è´¥:', e);
            }
        }
        
        // FGI æ¸²æŸ“ï¼šæ ¹æ®æ•°å€¼åœ¨åŠåœ†ä¸Šå®šä½æŒ‡ç¤ºç‚¹ï¼Œå¹¶æ›´æ–°æ–‡æ¡ˆï¼ˆå«åŠ¨ç”»ä¸åˆ†æ®µé«˜äº®ï¼‰
        function renderFGI(value, label) {
            try {
                const pointer = document.getElementById('fgiDot');
                const valEl = document.getElementById('fgiValue');
                const labEl = document.getElementById('fgiLabel');
                if (!pointer || !valEl || !labEl) return;
                if (typeof value !== 'number' || !isFinite(value)) {
                    valEl.textContent = '--';
                    labEl.textContent = 'ææƒ§è´ªå©ªæŒ‡æ•°';
                    return;
                }
                const v = Math.max(0, Math.min(100, value));
                valEl.textContent = String(Math.round(v));
                // é˜ˆå€¼åˆ†ç±»ï¼š0-20 æåº¦ææƒ§ï¼Œ20-40 ææƒ§ï¼Œ40-60 ä¸­æ€§ï¼Œ60-80 è´ªå©ªï¼Œ80-100 æåº¦è´ªå©ªï¼ˆå·¦é—­å³å¼€ï¼Œæœ€åä¸€æ¡£å« 100ï¼‰
                const classify = (n) => (n < 20 ? 'æåº¦ææƒ§' : n < 40 ? 'ææƒ§' : n < 60 ? 'ä¸­æ€§' : n < 80 ? 'è´ªå©ª' : 'æåº¦è´ªå©ª');
                // ç»Ÿä¸€ä»¥æ•°å€¼é˜ˆå€¼æ˜ å°„ä¸ºå‡†ï¼Œé¿å…æ¥å£æ ‡ç­¾è¦†ç›–é€ æˆé”™åˆ¤ï¼ˆä¾‹å¦‚ 44 åº”æ˜¾ç¤ºâ€œä¸­æ€§â€ï¼‰
                labEl.textContent = classify(v);
                // åŠåœ†æ˜ å°„ï¼š0 -> Ï€, 100 -> 0
                const angle = Math.PI * (1 - v / 100);
                const r = 90;
                const cx = 100 + r * Math.cos(angle);
                const cy = 100 - r * Math.sin(angle);
                pointer.setAttribute('cx', cx.toFixed(2));
                pointer.setAttribute('cy', cy.toFixed(2));

                // ä¿æŒæ‰€æœ‰é¢œè‰²æ®µå›ºå®šæ˜¾ç¤ºï¼Œå–æ¶ˆåŠ¨æ€é«˜äº®ï¼Œä»…ç§»åŠ¨æŒ‡ç¤ºç‚¹
                // æŒ‡ç¤ºç‚¹æ ·å¼å·²é€šè¿‡ CSS å®šä¹‰ï¼Œè¿™é‡Œä¸ä¿®æ”¹é¢œè‰²
            } catch (e) {
                console.warn('æ¸²æŸ“FGIå¤±è´¥:', e);
            }
        }
        
        // åŠ è½½ FGI æ•°æ®ï¼ˆä½¿ç”¨æœ¬åœ°è¶…æ—¶æ§åˆ¶ï¼Œé¿å…å¤ç”¨å¸‚åœºæ•°æ®çš„å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadFGI() {
            const ctrl = new AbortController();
            const timer = setTimeout(() => ctrl.abort(), 8000);
            try {
                const res = await fetch('/api/sentiment/fgi', { signal: ctrl.signal, cache: 'no-store' });
                clearTimeout(timer);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const payload = await res.json();
                const d = payload?.data ?? payload;
                const val = typeof d?.value === 'number' ? d.value : Number(d?.value);
                const label = d?.value_classification || d?.classification || null;
                renderFGI(val, label);
            } catch (err) {
                clearTimeout(timer);
                console.warn('åŠ è½½FGIå¤±è´¥:', err);
                renderFGI(NaN, null);
            }
        }
        
        // åŠ è½½æ»‘ç‚¹æ•°æ®
        async function loadSlippageData() {
            const statusEl = document.getElementById('slippageInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨åŠ è½½...';
            }
            
            try {
                // è·å–æ»‘ç‚¹ç»Ÿè®¡
                const statsRes = await fetch('/api/slippage/statistics', { cache: 'no-store' });
                if (!statsRes.ok) throw new Error('HTTP ' + statsRes.status);
                const statsData = await statsRes.json();
                const stats = statsData?.data || statsData || {};
                
                // è·å–æ»‘ç‚¹é˜ˆå€¼
                const thresholdsRes = await fetch('/api/slippage/thresholds', { cache: 'no-store' });
                if (!thresholdsRes.ok) throw new Error('HTTP ' + thresholdsRes.status);
                const thresholdsData = await thresholdsRes.json();
                const thresholds = thresholdsData?.data || thresholdsData || {};
                
                // è·å–æ»‘ç‚¹åˆ†æå†å²ï¼ˆæœ€è¿‘50æ¡ï¼‰
                const analysisRes = await fetch('/api/slippage/analysis?limit=50', { cache: 'no-store' });
                if (!analysisRes.ok) throw new Error('HTTP ' + analysisRes.status);
                const analysisData = await analysisRes.json();
                const analysisHistory = analysisData?.data || analysisData || [];
                
                // æ›´æ–°æ˜¾ç¤ºæ•°æ®
                updateSlippageDisplay(stats, thresholds, analysisHistory);
                
                if (statusEl) {
                    statusEl.className = 'inline-status ok';
                    statusEl.textContent = '';
                }
                
                // 3ç§’åæ¢å¤çŠ¶æ€
                setTimeout(() => {
                    if (statusEl) {
                        statusEl.className = 'inline-status';
                        statusEl.textContent = '';
                    }
                }, 3000);
                
            } catch (err) {
                console.warn('åŠ è½½æ»‘ç‚¹æ•°æ®å¤±è´¥:', err);
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.textContent = 'åŠ è½½å¤±è´¥';
                }
            }
        }
        
        // æ›´æ–°æ»‘ç‚¹æ˜¾ç¤º
        function updateSlippageDisplay(stats, thresholds, analysisHistory) {
            try {
                // æ›´æ–°åŸºæœ¬æŒ‡æ ‡ï¼ˆç»Ÿä¸€è½¬æ¢ä¸ºç™¾åˆ†æ¯”å°æ•°ï¼š0.0047 è¡¨ç¤º 0.47%ï¼‰
                const avgBps = (typeof stats?.avg_slippage_bps === 'number') ? stats.avg_slippage_bps
                              : (typeof stats?.average_slippage_bps === 'number') ? stats.average_slippage_bps
                              : null;
                const avgSlippageRaw = (avgBps != null && isFinite(avgBps))
                    ? (avgBps / 10000)
                    : ((typeof stats?.average_slippage === 'number') ? stats.average_slippage
                        : ((typeof stats?.avg_slippage === 'number') ? stats.avg_slippage : 0));
                
                const maxBps = (typeof stats?.max_slippage_bps === 'number') ? stats.max_slippage_bps : null;
                const maxSlippageRaw = (maxBps != null && isFinite(maxBps))
                    ? (maxBps / 10000)
                    : ((typeof stats?.max_slippage === 'number') ? stats.max_slippage : 0);
                
                // å…¼å®¹åç«¯ new API: data.current_thresholds.ev_threshold ä¸ºå°æ•°é˜ˆå€¼
                const evThr = (typeof thresholds?.current_thresholds?.ev_threshold === 'number')
                    ? thresholds.current_thresholds.ev_threshold
                    : (typeof thresholds?.ev_threshold === 'number') ? thresholds.ev_threshold
                    : null;

                const thBps = (typeof thresholds?.threshold_bps === 'number') ? thresholds.threshold_bps
                             : (typeof thresholds?.buy_threshold_bps === 'number') ? thresholds.buy_threshold_bps
                             : (typeof thresholds?.sell_threshold_bps === 'number') ? thresholds.sell_threshold_bps
                             : (typeof stats?.suggested_threshold_bps === 'number') ? stats.suggested_threshold_bps
                             : null;
                const thresholdRaw = (thBps != null && isFinite(thBps))
                    ? (thBps / 10000)
                    : (evThr != null && isFinite(evThr)) ? evThr
                    : ((typeof thresholds?.buy_threshold === 'number') ? thresholds.buy_threshold
                        : ((typeof thresholds?.sell_threshold === 'number') ? thresholds.sell_threshold : 0));
                
                // Fallbackï¼šè‹¥ç»Ÿè®¡/é˜ˆå€¼ä¸º 0 æˆ–ç¼ºå¤±ï¼Œåˆ™æ ¹æ®åˆ†æå†å²æ¨å¯¼
                const toFraction = (val, isBps) => (typeof val === 'number' && isFinite(val)) ? (isBps ? val / 10000 : val) : 0;
                const getNum = (obj, keys) => {
                    for (const k of keys) {
                        const v = obj && obj[k];
                        if (typeof v === 'number' && isFinite(v)) return v;
                    }
                    return null;
                };
                const fromAnalysis = (() => {
                    if (!Array.isArray(analysisHistory) || analysisHistory.length === 0) return { avg: 0, max: 0, thr: 0 };
                    const recent = analysisHistory.slice(-20);
                    const slippages = [];
                    const thresholdsArr = [];
                    for (const item of recent) {
                        const sBps = getNum(item, ['slippage_bps', 'avg_slippage_bps']);
                        const s = toFraction(sBps != null ? sBps : (getNum(item, ['slippage', 'avg_slippage']) || 0), sBps != null);
                        slippages.push(s);
                        const tBps = getNum(item, ['threshold_bps', 'suggested_threshold_bps']);
                        const t = toFraction(tBps != null ? tBps : (getNum(item, ['threshold']) || 0), tBps != null);
                        if (t > 0) thresholdsArr.push(t);
                    }
                    const avg = slippages.length ? slippages.reduce((a,b)=>a+b,0)/slippages.length : 0;
                    const max = slippages.length ? Math.max(...slippages) : 0;
                    const thr = thresholdsArr.length ? thresholdsArr[thresholdsArr.length-1] : 0;
                    return { avg, max, thr };
                })();
                
                const avgToShow = (isFinite(avgSlippageRaw) && avgSlippageRaw > 0) ? avgSlippageRaw : fromAnalysis.avg;
                const maxToShow = (isFinite(maxSlippageRaw) && maxSlippageRaw > 0) ? maxSlippageRaw : fromAnalysis.max;
                const thrToShow = (isFinite(thresholdRaw) && thresholdRaw > 0) ? thresholdRaw : fromAnalysis.thr;
                const thrDisplay = (isFinite(thresholdRaw) && thresholdRaw > 0) || (isFinite(fromAnalysis.thr) && fromAnalysis.thr > 0)
                    ? formatPercentage(thrToShow)
                    : '--';
                
                document.getElementById('avgSlippage').textContent = isFinite(avgToShow) ? formatPercentage(avgToShow) : '--';
                document.getElementById('maxSlippage').textContent = isFinite(maxToShow) ? formatPercentage(maxToShow) : '--';
                document.getElementById('slippageThreshold').textContent = thrDisplay;
                
                // è®¡ç®—æ»‘ç‚¹è¶‹åŠ¿
                const trend = calculateSlippageTrend(analysisHistory);
                document.getElementById('slippageTrend').textContent = trend.text;
                document.getElementById('slippageTrend').style.color = trend.color;
                
                // æ›´æ–°é˜ˆå€¼è°ƒæ•´çŠ¶æ€
                const autoAdjustment = thresholds?.auto_adjustment !== false;
                document.getElementById('autoAdjustmentStatus').textContent = autoAdjustment ? 'å¯ç”¨' : 'ç¦ç”¨';
                document.getElementById('autoAdjustmentStatus').style.color = autoAdjustment ? '#27ae60' : '#e74c3c';
                
                // æœ€åè°ƒæ•´æ—¶é—´
                const lastAdjustment = thresholds?.last_adjustment_time || thresholds?.last_updated || stats?.last_updated;
                document.getElementById('lastAdjustmentTime').textContent = lastAdjustment ? 
                    new Date(lastAdjustment).toLocaleString('zh-CN') : '--';
                
                // ç»˜åˆ¶å›¾è¡¨
                drawSlippageChart(analysisHistory);
                
            } catch (err) {
                console.warn('æ›´æ–°æ»‘ç‚¹æ˜¾ç¤ºå¤±è´¥:', err);
            }
        }
        
        // è®¡ç®—æ»‘ç‚¹è¶‹åŠ¿
        function calculateSlippageTrend(analysisHistory) {
            if (!Array.isArray(analysisHistory) || analysisHistory.length < 2) {
                return { text: 'æ•°æ®ä¸è¶³', color: '#999' };
            }
            
            try {
                // ç»Ÿä¸€å–å€¼ä¸ºâ€œå°æ•°å½¢å¼çš„ç™¾åˆ†æ¯”â€ï¼ˆå¦‚ 0.0047 è¡¨ç¤º 0.47%ï¼‰
                const toFraction = (item) => {
                    const bps = (typeof item?.slippage_bps === 'number') ? item.slippage_bps
                              : (typeof item?.avg_slippage_bps === 'number') ? item.avg_slippage_bps
                              : null;
                    if (bps != null && isFinite(bps)) return bps / 10000; // bps -> fraction
                    const frac = (typeof item?.slippage === 'number') ? item.slippage
                               : (typeof item?.avg_slippage === 'number') ? item.avg_slippage
                               : 0;
                    return (isFinite(frac) ? frac : 0);
                };
                
                const fracSeries = analysisHistory.map(toFraction);
                const recent = fracSeries.slice(-10); // æœ€è¿‘10æ¡
                const older = fracSeries.slice(-20, -10); // å‰10æ¡
                
                const avg = (arr) => arr.reduce((s, v) => s + (isFinite(v) ? v : 0), 0) / (arr.length || 1);
                const recentAvg = avg(recent);
                const olderAvg = avg(older);
                
                const change = recentAvg - olderAvg;
                const changePercent = olderAvg > 0 ? (change / olderAvg) * 100 : 0;
                
                if (Math.abs(changePercent) < 5) {
                    return { text: 'ç¨³å®š', color: '#f39c12' };
                } else if (changePercent > 5) {
                    return { text: `ä¸Šå‡ ${changePercent.toFixed(1)}%`, color: '#e74c3c' };
                } else {
                    return { text: `ä¸‹é™ ${Math.abs(changePercent).toFixed(1)}%`, color: '#27ae60' };
                }
            } catch (err) {
                return { text: 'è®¡ç®—å¤±è´¥', color: '#999' };
            }
        }
        
        // ç»˜åˆ¶æ»‘ç‚¹å›¾è¡¨
        function drawSlippageChart(analysisHistory) {
            try {
                const canvas = document.getElementById('slippageChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                const width = canvas.width;
                const height = canvas.height;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, width, height);
                
                if (!Array.isArray(analysisHistory) || analysisHistory.length === 0) {
                    ctx.fillStyle = '#999';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('æš‚æ— æ•°æ®', width / 2, height / 2);
                    return;
                }
                
                // ç»Ÿä¸€å°†æ•°æ®è½¬æ¢ä¸ºâ€œå°æ•°å½¢å¼çš„ç™¾åˆ†æ¯”â€ï¼ˆå¦‚ 0.0047 è¡¨ç¤º 0.47%ï¼‰
                const toFraction = (val, isBps) => {
                    if (typeof val !== 'number' || !isFinite(val)) return 0;
                    return isBps ? val / 10000 : val;
                };
                const getNum = (obj, keys) => {
                    for (const k of keys) {
                        const v = obj && obj[k];
                        if (typeof v === 'number' && isFinite(v)) return v;
                    }
                    return null;
                };
                
                const data = analysisHistory.slice(-30).map(item => {
                    const t = new Date(item.timestamp || item.created_at || Date.now());
                    const slippageBps = getNum(item, ['slippage_bps', 'avg_slippage_bps']);
                    const slippageFrac = toFraction(slippageBps != null ? slippageBps : getNum(item, ['slippage', 'avg_slippage']) || 0, slippageBps != null);
                    const thresholdBps = getNum(item, ['threshold_bps', 'suggested_threshold_bps']);
                    const thresholdFrac = toFraction(thresholdBps != null ? thresholdBps : getNum(item, ['threshold']) || 0, thresholdBps != null);
                    return { time: t, slippage: slippageFrac, threshold: thresholdFrac };
                });
                
                // è®¡ç®—è¾¹ç•Œ
                const maxSlippage = Math.max(...data.map(d => Math.max(d.slippage, d.threshold)));
                const minSlippage = Math.min(...data.map(d => Math.min(d.slippage, d.threshold)));
                const padding = 0.001; // 0.1% è¾¹è·ï¼ˆä»¥ fraction è®¡ï¼‰
                let maxValue = (isFinite(maxSlippage) ? maxSlippage : 0) + padding;
                let minValue = Math.max(0, (isFinite(minSlippage) ? minSlippage : 0) - padding);
                if (maxValue - minValue < 1e-6) { // é˜²æ­¢é™¤é›¶
                    maxValue += 0.001;
                    minValue = Math.max(0, minValue - 0.001);
                }
                
                // ç»˜åˆ¶ç½‘æ ¼
                ctx.strokeStyle = '#e0e0e0';
                ctx.lineWidth = 1;
                
                // æ°´å¹³ç½‘æ ¼çº¿
                for (let i = 0; i <= 4; i++) {
                    const y = (height - 40) * (i / 4) + 20;
                    ctx.beginPath();
                    ctx.moveTo(40, y);
                    ctx.lineTo(width - 20, y);
                    ctx.stroke();
                    
                    // Yè½´æ ‡ç­¾
                    const value = maxValue - (maxValue - minValue) * (i / 4);
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'right';
                    ctx.fillText(formatPercentage(value), 35, y + 3);
                }
                
                // ç»˜åˆ¶æ»‘ç‚¹çº¿
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 2;
                ctx.beginPath();
                
                data.forEach((point, index) => {
                    const x = 40 + (width - 60) * (index / Math.max(1, (data.length - 1)));
                    const y = height - 20 - (point.slippage - minValue) / (maxValue - minValue) * (height - 40);
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
                
                // ç»˜åˆ¶é˜ˆå€¼çº¿
                if (data.some(d => d.threshold > 0)) {
                    ctx.strokeStyle = '#e74c3c';
                    ctx.lineWidth = 1;
                    ctx.setLineDash([5, 5]);
                    
                    const avgThreshold = data.reduce((sum, d) => sum + d.threshold, 0) / data.length;
                    const y = height - 20 - (avgThreshold - minValue) / (maxValue - minValue) * (height - 40);
                    
                    ctx.beginPath();
                    ctx.moveTo(40, y);
                    ctx.lineTo(width - 20, y);
                    ctx.stroke();
                    
                    ctx.setLineDash([]);
                    
                    // é˜ˆå€¼æ ‡ç­¾
                    ctx.fillStyle = '#e74c3c';
                    ctx.font = '10px Arial';
                    ctx.textAlign = 'left';
                    ctx.fillText('é˜ˆå€¼', width - 50, y - 2);
                }
                
            } catch (err) {
                console.warn('ç»˜åˆ¶æ»‘ç‚¹å›¾è¡¨å¤±è´¥:', err);
            }
        }
        
        // æ ¼å¼åŒ–ç™¾åˆ†æ¯”
        function formatPercentage(value) {
            if (typeof value !== 'number' || !isFinite(value)) return '--';
            return (value * 100).toFixed(3) + '%';
        }
        

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // åŠ è½½å„ç±»æ•°æ®
            loadMarketData();
            loadSystemStatus();
            loadLatestSignal();
            loadPerformanceData();
            loadTradeRecommendation();
            loadRecommendationHistory();
            loadFGI();
            loadSlippageData();
            renderTradingCosts();
            
            // æ–°å¢ï¼šé¦–å±å…œåº•æ¸²æŸ“â€œç­–ç•¥å•è¿›åº¦â€ï¼Œé¿å…ç”¨æˆ·åˆ·æ–°åçŸ­æ—¶é—´å†…çœ‹ä¸åˆ°
            setTimeout(async () => {
                try {
                    const listEl = document.getElementById('perfOrderProgressList');
                    if (listEl && !listEl.innerHTML.trim()) {
                        const cfg = await ensureAppConfig();
                        const fallbackAnalysis = { signal: { type: 'HOLD', strength: 0, confidence: 0.5 } };
                        renderOrderProgressFromAnalysis(fallbackAnalysis, cfg);
                    }
                } catch (_) {}
            }, 200);
            
            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
            updateInterval = setInterval(() => {
                loadLatestSignal();
                loadMarketData();
                updateUptime();
                loadTradeRecommendation();
                loadRecommendationHistory(true);
                loadFGI();
                // æ»‘ç‚¹åˆ·æ–°æ”¹ä¸ºç‹¬ç«‹é«˜é¢‘å®šæ—¶å™¨
            }, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡

            // ç‹¬ç«‹ï¼šæ»‘ç‚¹æ¯10ç§’åˆ·æ–°ä¸€æ¬¡
            if (window.__slippageTimer) clearInterval(window.__slippageTimer);
            window.__slippageTimer = setInterval(() => {
                try { loadSlippageData(); } catch (e) { /* ignore */ }
            }, 10000);

            // ä»…åˆ·æ–°æ»‘ç‚¹æŒ‰é’®
            const rsBtn = document.getElementById('refreshSlippageBtn');
            if (rsBtn) rsBtn.addEventListener('click', () => {
                try { loadSlippageData(); } catch (e) { /* ignore */ }
            });
        };
        
        // é¢„å–ä¸€æ¬¡é…ç½®ï¼Œä¾›è¿›åº¦é˜ˆå€¼è®¡ç®—
        ensureAppConfig().catch(()=>{});
        
        // æ‹‰å–ç³»ç»Ÿé…ç½®ï¼ˆé˜ˆå€¼/åˆ†æå‘¨æœŸï¼‰
        async function ensureAppConfig() {
            if (window.__appConfig && window.__appConfig.strategy) return window.__appConfig;
            try {
                const res = await fetch('/api/config');
                const payload = await res.json();
                const cfg = payload?.data || payload || {};
                window.__appConfig = cfg;
                return cfg;
            } catch (e) {
                console.warn('æ‹‰å–é…ç½®å¤±è´¥, ä½¿ç”¨é»˜è®¤é˜ˆå€¼', e);
                const fallback = { strategy: { signalThreshold: 0.5, analysisInterval: 30000, signalCooldownMs: 1800000 } };
                window.__appConfig = fallback;
                return fallback;
            }
        }
        
        function renderTradingCosts() {
            try {
                ensureAppConfig().then(cfg => {
                    const el = document.getElementById('costInfo');
                    if (!el) return;
                    const c = Number(cfg?.commission);
                    const s = Number(cfg?.slippage);
                    const fmt = v => isFinite(v) ? (((v*100) < 0.1 ? (v*100).toFixed(3) : (v*100).toFixed(2)) + '%') : '--';
                    // ä¸å†æ˜¾ç¤ºäº¤æ˜“æˆæœ¬ä¿¡æ¯
                    el.textContent = '';
                }).catch(()=>{});
            } catch (_) {}
        }
        
        // æ›´æ–° Kronos å‚ä¸çŠ¶æ€ï¼ˆè¯»å–é…ç½®ä¸æœ€æ–°åˆ†æï¼Œè®¡ç®—æ–¹å‘ã€ç½®ä¿¡åº¦ä¸èåˆå æ¯”ï¼‰
        function updateKronosStatus(analysis) {
            try {
                const container = document.getElementById('kronosStatus');
                // å¼‚æ­¥è¯»å–é…ç½®ï¼ˆä¸é˜»å¡ä¸»æµç¨‹ï¼‰
                ensureAppConfig().then(cfg => {
                    const kronosCfg = cfg?.strategy?.kronos || {};
                    const enabled = !!kronosCfg.enabled;

                    // æ›´æ–°çŠ¶æ€æ â€œKronosæ¨¡å‹â€çš„å°åœ†ç‚¹é¢œè‰²
                    try {
                        const items = document.querySelectorAll('.status-bar .status-item');
                        items.forEach(el => {
                            const span = el.querySelector('span');
                            if (span && span.textContent && span.textContent.includes('Kronos')) {
                                const dot = el.querySelector('.status-dot');
                                if (dot) dot.style.background = enabled ? '#27ae60' : '#9ca3af';
                            }
                        });
                    } catch (_) {}

                    if (!container) return;
                    if (!enabled) {
                        container.innerHTML = '<span style="color:#6b7280">Kronos å·²å…³é—­</span>';
                        return;
                    }

                    // å…¼å®¹å¤šç§å“åº”ç»“æ„ï¼šä¼˜å…ˆ signal.metadata.kronosï¼Œå…¶æ¬¡ analysis.metadata.kronos
                    const sig = analysis?.signal || analysis || {};
                    const metaK = sig?.metadata?.kronos || analysis?.metadata?.kronos || null;

                    if (!metaK) {
                        container.innerHTML = '<span style="color:#9ca3af">Kronos æ— æœ€è¿‘ç»“æœ</span>';
                        return;
                    }

                    const clamp01 = v => Math.max(0, Math.min(1, Number(v) || 0));
                    const longS = clamp01(metaK.score_long);
                    const shortS = clamp01(metaK.score_short);
                    const conf = clamp01(metaK.confidence ?? 0.5);
                    const directional = longS - shortS; // [-1, 1]
                    const dirText = directional > 0.05 ? 'å¤š' : (directional < -0.05 ? 'ç©º' : 'ä¸­æ€§');
                    const dirPct = Math.abs(directional) * 100;

                    // æ˜¾ç¤ºèåˆæƒé‡ï¼šä¼˜å…ˆå–é…ç½®ä¸­çš„ alpha/alphaMin/alphaMaxï¼Œå…¶æ¬¡ç”¨ç½®ä¿¡åº¦ä½œä¸ºåŠ¨æ€Î±
                    let alpha = typeof kronosCfg.alpha === 'number' ? clamp01(kronosCfg.alpha) : conf;
                    const minA = typeof kronosCfg.alphaMin === 'number' ? clamp01(kronosCfg.alphaMin) : 0.3;
                    const maxA = typeof kronosCfg.alphaMax === 'number' ? clamp01(kronosCfg.alphaMax) : 0.8;
                    alpha = Math.max(minA, Math.min(maxA, alpha));

                    container.innerHTML = `
                        <div style="font-size:12px;color:#374151;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                            <span>æ¨¡å‹ï¼šå·²å¯ç”¨</span>
                            <span>å€¾å‘ï¼š${dirText} ${dirPct.toFixed(1)}%</span>
                            <span>ç½®ä¿¡åº¦ï¼š${(conf * 100).toFixed(1)}%</span>
                            <span>èåˆæƒé‡Î±ï¼š${(alpha * 100).toFixed(0)}%</span>
                        </div>`;
                }).catch(_ => {
                    if (container) container.innerHTML = '<span style="color:#9ca3af">Kronos çŠ¶æ€ä¸å¯ç”¨</span>';
                });
            } catch (_) {}
        }
        
        // æ ¹æ®æœ€æ–°åˆ†ææ¸²æŸ“â€œç­–ç•¥å•è¿›åº¦â€
        function renderOrderProgressFromAnalysis(analysis, cfg) {
            try {
                const listEl = document.getElementById('perfOrderProgressList');
                if (!listEl) return;
                const s = analysis?.signal || {};
                const rec = analysis?.recommendation || {};
                // å¼ºåº¦å½’ä¸€åŒ–
                let combined = 0;
                if (typeof s.strength === 'number') {
                    combined = Math.max(0, Math.min(1, s.strength));
                } else if (s.strength && typeof s.strength.combined === 'number') {
                    combined = s.strength.combined > 1 ? s.strength.combined / 100 : s.strength.combined;
                    combined = Math.max(0, Math.min(1, combined));
                }
                // ç½®ä¿¡åº¦
                let confidence = null;
                if (typeof s.confidence === 'number') confidence = s.confidence;
                else if (s.strength && typeof s.strength.confidence === 'number') confidence = s.strength.confidence;
                else if (typeof rec.confidence === 'number') confidence = rec.confidence;
                // é˜ˆå€¼å½’ä¸€åŒ–ï¼šåç«¯å¯èƒ½è¿”å› 0-1 æˆ– 0-100ï¼›åŒæ—¶é¿å… 0 å¯¼è‡´è¿›åº¦è¢«æ¸…é›¶
                let thresholdRaw = cfg?.strategy?.signalThreshold;
                let threshold = Number(thresholdRaw);
                if (!isFinite(threshold)) threshold = 0.5; // é»˜è®¤ 50%
                if (threshold > 1) threshold = threshold / 100; // ç™¾åˆ†æ¯”è½¬å°æ•°
                threshold = Math.max(0.05, Math.min(1, threshold)); // è‡³å°‘ 5%ï¼Œé¿å… 0%
                // æŠŠæ˜¾ç¤ºä»â€œç›¸å¯¹é˜ˆå€¼â€æ”¹ä¸ºâ€œç»å¯¹å¼ºåº¦â€ï¼Œé¿å…å¼ºåº¦65%ä½†æ˜¾ç¤º100%çš„è¯¯å¯¼
                const strengthPct = Math.round(Math.max(0, Math.min(1, combined)) * 100);
                const intervalMs = Number(cfg?.strategy?.analysisInterval ?? 30000);
                // ETA åŸºäºé˜ˆå€¼ï¼ˆå¦‚æ— é˜ˆå€¼åˆ™æ˜¾ç¤º 'â€”'ï¼‰
                let etaText = '--';
                if (threshold != null && threshold > 0) {
                    if (combined >= threshold) {
                        etaText = 'å·²è¾¾é˜ˆå€¼ï¼Œéšæ—¶å¯èƒ½å‡ºå•';
                    } else {
                        const speed = Math.max(0.01, (confidence ?? 0.6) * 0.08);
                        const remaining = Math.max(0, threshold - combined);
                        const cycles = Math.ceil(remaining / speed);
                        const etaMs = cycles * intervalMs;
                        const m = Math.floor(etaMs / 60000);
                        const sLeft = Math.round((etaMs % 60000) / 1000);
                        etaText = (m > 0 ? (m + 'åˆ†') : '') + sLeft + 'ç§’';
                    }
                } else {
                    etaText = 'â€”';
                }
                const t = String(s.type || s.signal || rec.action || '').toUpperCase();
                const side = (t.includes('SELL') || t.includes('SHORT')) ? 'åšç©º' : (t.includes('BUY') || t.includes('LONG')) ? 'åšå¤š' : 'è§‚æœ›';
                const title = `å½“å‰ä¿¡å· ${side}`;
                const detail = `å¼ºåº¦ ${(combined*100).toFixed(1)}% Â· ç½®ä¿¡åº¦ ${confidence!=null? (confidence*100).toFixed(0)+'%':'--'} Â· é˜ˆå€¼ ${threshold!=null? (threshold*100).toFixed(0)+'%':'â€”'}`;
                const barHtml = `
                    <div id="orderProgressItem" class="order-progress-item" style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                            <div style="font-weight:600;color:#111827">${title}</div>
                            <div id="orderProgressEta" style="font-size:12px;color:#6b7280">é¢„è®¡è¾¾æ ‡: ${etaText}</div>
                        </div>
                        <div class="progress" style="background:#e5e7eb;border-radius:6px;height:10px;position:relative;overflow:hidden">
                            <div id="orderProgressFill" class="progress-fill" style="height:100%;width:${strengthPct}%;background:linear-gradient(90deg,#34d399,#10b981);transition:width .4s ease"></div>
                            ${threshold!=null? `<div style="position:absolute;left:${Math.min(100, threshold*100)}%;top:0;bottom:0;width:2px;background:#fbbf24"></div>` : ''}
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#6b7280;margin-top:4px">
                            <span>${detail}</span>
                            <span id="orderProgressPct">${strengthPct}%</span>
                        </div>
                    </div>`;
                // é¿å…åˆ·æ–°æ—¶æ¸…ç©ºæ•´ä¸ªå®¹å™¨ï¼šå…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ analysisProgressItem
                let analysisItem = document.getElementById('analysisProgressItem');
                if (!analysisItem) {
                    // ä»…è®¾ç½®ç­–ç•¥å•è¿›åº¦ HTMLï¼Œå¹¶åˆ›å»ºå®æ—¶åˆ†æè¿›åº¦å®¹å™¨
                    listEl.innerHTML = barHtml + '<div id="analysisProgressItem" style="margin-top:8px"></div>';
                } else {
                    // å·²å­˜åœ¨å®æ—¶åˆ†æè¿›åº¦å®¹å™¨ï¼Œä»…æ›´æ–°ç­–ç•¥å•è¿›åº¦éƒ¨åˆ†
                    const orderItem = document.getElementById('orderProgressItem');
                    if (orderItem) {
                        orderItem.outerHTML = barHtml;
                    } else {
                        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œåˆ™æ’å…¥åˆ° analysisProgressItem å‰é¢
                        analysisItem.insertAdjacentHTML('beforebegin', barHtml);
                    }
                }
                // æ–°å¢ï¼šç­–ç•¥å•ç”Ÿæˆè¿›åº¦ï¼ˆéå†·å´æœŸï¼‰çš„æ¯ç§’åŠ¨æ€åˆ·æ–°
                try {
                    if (window.__orderProgressTimer) { clearInterval(window.__orderProgressTimer); }
                    const etaEl = document.getElementById('orderProgressEta');
                    const fillEl = document.getElementById('orderProgressFill');
                    const pctEl  = document.getElementById('orderProgressPct');
                    const intervalMsLocal = Number(intervalMs);
                    const thresholdLocal = (typeof threshold === 'number' && threshold > 0) ? threshold : null;
                    const confidenceLocal = (confidence != null ? Number(confidence) : 0.6);
                    const baseCombined = Number(combined);
                    const t0 = Date.now();
                    const speed = Math.max(0.01, confidenceLocal * 0.08); // æ¯ä¸ªåˆ†æå‘¨æœŸçš„æœŸæœ›æå‡é‡
                    function updateOrderProgress(){
                        const elapsed = Date.now() - t0;
                        const combinedPred = Math.min(1, baseCombined + (elapsed / intervalMsLocal) * speed);
                        const widthPct = Math.round(Math.max(0, Math.min(1, combinedPred)) * 100);
                        if (fillEl) fillEl.style.width = widthPct + '%';
                        if (pctEl) pctEl.textContent = widthPct + '%';
                        if (etaEl) {
                            if (thresholdLocal == null) {
                                etaEl.textContent = 'é¢„è®¡è¾¾æ ‡: â€”';
                            } else if (combinedPred >= thresholdLocal) {
                                etaEl.textContent = 'å·²è¾¾é˜ˆå€¼ï¼Œéšæ—¶å¯èƒ½å‡ºå•';
                            } else {
                                const remaining = Math.max(0, thresholdLocal - combinedPred);
                                const cycles = Math.ceil(remaining / speed);
                                const etaMs2 = cycles * intervalMsLocal;
                                const m = Math.floor(etaMs2 / 60000);
                                const sLeft = Math.round((etaMs2 % 60000) / 1000);
                                etaEl.textContent = 'é¢„è®¡è¾¾æ ‡: ' + (m > 0 ? (m + 'åˆ†') : '') + sLeft + 'ç§’';
                            }
                        }
                        if (thresholdLocal != null && combinedPred >= thresholdLocal) {
                            clearInterval(window.__orderProgressTimer);
                        }
                    }
                    window.__orderProgressTimer = setInterval(updateOrderProgress, 1000);
                    updateOrderProgress();
                } catch(__e) { /* å¿½ç•¥å•æ¬¡åˆ·æ–°å¤±è´¥ */ }
            } catch (e) { console.warn('renderOrderProgressFromAnalysis error:', e); }
        }
        
        // é˜¶æ®µåç§°æ˜ å°„ï¼ˆå¦‚éœ€è°ƒæ•´å¯ä¿®æ”¹æ­¤å¤„ä¸­æ–‡æ–‡æ¡ˆï¼‰
        const stageLabels = { 1:'æ•°æ®æ‹‰å–', 2:'ä¿¡å·æ£€æµ‹', 3:'å›æµ‹', 4:'é£æ§', 5:'ä¸‹å‘æ¨è' };

        // æ–°å¢ï¼šæ¸²æŸ“â€œå®æ—¶åˆ†æè¿›åº¦â€ï¼ˆSocket æ¨é€ï¼‰ - å¢å¼ºç‰ˆ
        function renderRealtimeAnalysisProgress(progress){
            try {
                const listEl = document.getElementById('perfOrderProgressList');
                if (!listEl) return;
                let holder = document.getElementById('analysisProgressItem');
                if (!holder) {
                    holder = document.createElement('div');
                    holder.id = 'analysisProgressItem';
                    holder.style.marginTop = '8px';
                    listEl.prepend(holder);
                }

                const isConnected = !!(window.__analysisSocket && window.__analysisSocket.connected);

                // æ— è¿›åº¦ï¼šæ˜¾ç¤ºå ä½ + è¿æ¥çŠ¶æ€
                if (!progress) {
                    const connectionStatus = isConnected ? 'å·²è¿æ¥' : 'æ–­çº¿';
                    const statusColor = isConnected ? '#22c55e' : '#ef4444';
                    holder.innerHTML = `
                        <div class="order-progress-item" style="background:#fafbfc;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px;text-align:center">
                            <div style="color:#64748b;font-size:14px;margin-bottom:8px">æš‚æ— åˆ†æä»»åŠ¡</div>
                            <div style="display:flex;align-items:center;justify-content:center;gap:6px">
                                <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${statusColor}"></span>
                                <span style="font-size:12px;color:#64748b">å®æ—¶è¿æ¥: ${connectionStatus}</span>
                                ${!isConnected ? '<a href="#" onclick="window.__analysisSocket?.connect?.();return false;" style="color:#3b82f6;margin-left:6px">é‡è¿</a>' : ''}
                            </div>
                        </div>`;
                    return;
                }

                const p = typeof progress.percent === 'number' ? Math.max(0, Math.min(1, progress.percent)) : 0;
                const pct = Math.round(p * 100);
                const VISUAL_TOTAL = 5; // å›ºå®šä¸º5æ®µ
                const rawStep = Number.isFinite(progress.step) ? progress.step : 0;
                const step = Math.max(0, Math.min(VISUAL_TOTAL, rawStep));
                const total = VISUAL_TOTAL;
                const label = stageLabels[step] || (progress && progress.label ? String(progress.label) : 'ç­‰å¾…ä¸‹ä¸€æ¬¡åˆ†æ');
                const startedAt = Number.isFinite(progress.startedAt) ? progress.startedAt : null;
                const updatedAt = Number.isFinite(progress.updatedAt) ? progress.updatedAt : null;
                const timeUsed = startedAt ? (()=>{ const ms=Math.max(0, Date.now()-startedAt); const m=Math.floor(ms/60000); const s=Math.round((ms%60000)/1000); return `${m>0? m+'åˆ†':''}${s}ç§’`; })() : '--';
                const lastUpd = updatedAt ? (()=>{ const diff=Math.max(0, Date.now()-updatedAt); const s=Math.floor(diff/1000); if (s<60) return `${s}så‰`; const m=Math.floor(s/60); if (m<60) return `${m}åˆ†é’Ÿå‰`; const h=Math.floor(m/60); return `${h}å°æ—¶å‰`; })() : '--';
                const etaText = (()=>{ if(!startedAt || p<=0 || p>=1) return 'â€”'; const elapsed=Date.now()-startedAt; const remain=Math.max(0, Math.round(elapsed*(1/p-1))); const m=Math.floor(remain/60000); const s=Math.round((remain%60000)/1000); return `${m>0? m+'åˆ†':''}${s}ç§’å`; })();

                const statusText = p>=1 ? 'åˆ†æå®Œæˆ' : `é˜¶æ®µ ${label} (${Math.min(step,5)}/5)`;
                const fillStyle = p>=1 ? 'linear-gradient(90deg,#10b981,#059669)' : (pct>=90 ? 'linear-gradient(90deg,#34d399,#10b981)' : 'linear-gradient(90deg,#a78bfa,#7c3aed)');

                // é˜¶æ®µåˆ»åº¦ + é¡¶éƒ¨ä¸­æ–‡æ ‡ç­¾ï¼ˆå‡åŒ€åˆ†å¸ƒï¼ši/(total-1)ï¼›é¦–å°¾é¿å…è´´è¾¹ï¼‰
                const ticks = (total && total>1) ? Array.from({length: total}, (_, i)=>{
                    const stageNum = i+1;
                    const stageName = stageLabels[stageNum] || `é˜¶æ®µ${stageNum}`;
                    const isActive = step >= stageNum;
                    const isFirst = stageNum === 1;
                    const isLast = stageNum === total;
                    const left = ((i/(total-1))*100).toFixed(2);
                    // é¦–å°¾æ ‡ç­¾ä½ç§»ç­–ç•¥ï¼š
                    // - ç¬¬1ä¸ªï¼štranslateX(0) + ç«–çº¿è´´å·¦
                    // - æœ€å1ä¸ªï¼štranslateX(-100%) + ç«–çº¿è´´å³ï¼ˆä¿è¯è¾¹ç•Œå†…å¯è§ï¼‰
                    const labelTransform = isLast ? 'translateX(-100%)' : (isFirst ? 'translateX(0)' : 'translateX(-50%)');
                    const lineMargin = isLast ? 'margin-left:auto;margin-right:0' : (isFirst ? 'margin-left:0;margin-right:auto' : 'margin:0 auto');
                    return `
                        <div class="stage-tick" style="position:absolute;left:${left}%;top:-22px;transform:${labelTransform};cursor:help" title="${stageName}">
                            <div style="font-size:10px;color:${isActive?'#059669':'#9ca3af'};font-weight:600;margin-bottom:2px;white-space:nowrap;">${stageName}</div>
                            <div style="width:1px;height:18px;background:${isActive?'#10b981':'#d1d5db'};${lineMargin};display:${isFirst?'none':'block'}"></div>
                        </div>`;
                }).join('') : '';

                // å®Œæˆå‹¾å·åŠ¨ç”»
                const completionIcon = p>=1 ? `
                    <div style="position:absolute;left:calc(${pct}% - 9px);top:-2px;width:18px;height:18px;border-radius:50%;background:#10b981;display:flex;align-items:center;justify-content:center;animation:checkmark .6s ease-in-out">
                        <svg width="10" height="8" viewBox="0 0 10 8" fill="none">
                            <path d="M1 4L4 7L9 1" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <style>
                        @keyframes checkmark { 0%{ transform:scale(0) rotate(-180deg); opacity:0 } 50%{ transform:scale(1.2) rotate(-90deg); opacity:1 } 100%{ transform:scale(1) rotate(0); opacity:1 } }
                    </style>
                ` : `<div style="position:absolute;left:calc(${pct}%);top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#fff;border:2px solid ${p>=1?'#10b981':(pct>=90?'#34d399':'#a78bfa')};box-shadow:0 1px 2px rgba(0,0,0,.12)"></div>`;

                holder.innerHTML = `
                    <div class="order-progress-item" style="background:#f9fbff;border:1px solid #e6eaf0;border-radius:12px;padding:12px 14px;box-shadow:0 1px 2px rgba(0,0,0,.04), 0 4px 10px rgba(17,24,39,.06);position:relative">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                            <div style="font-weight:700;color:#0f172a;letter-spacing:.2px">ç­–ç•¥å•è¿›å±•</div>
                            <div style="display:flex;gap:8px;align-items:center">
                                <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${isConnected?'#22c55e':'#ef4444'}"></span>
                                <div style="font-size:12px;color:#64748b">${statusText} Â· é¢„è®¡${etaText}å®Œæˆ</div>
                            </div>
                        </div>
                        <div class="progress" style="background:#e9edf3;border-radius:8px;height:14px;position:relative;overflow:visible;margin:24px 0 8px 0">
                            ${ticks}
                            <div style="background:#e9edf3;border-radius:8px;height:14px;position:relative;overflow:hidden">
                                <div class="progress-fill" style="height:100%;width:${pct}%;background:${fillStyle};transition:width .45s cubic-bezier(.4,0,.2,1);${p>=1 ? 'border-radius:8px' : 'border-radius:0 8px 8px 0'}"></div>
                                <div style="position:absolute;right:-2px;top:-18px;font-size:10px;color:#6b7280;">å‡ºå•</div>
                                <div style="position:absolute;left:100%;top:0;bottom:0;width:2px;background:#d7dce3"></div>
                            </div>
                            ${completionIcon}
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:12px;color:#6b7280;margin-top:8px">
                            <span>å·²ç”¨ ${timeUsed} Â· ä¸Šæ¬¡æ›´æ–° ${lastUpd} Â· <span style="color:${isConnected?'#22c55e':'#ef4444'}">${isConnected?'å·²è¿æ¥':'æ–­çº¿'}</span>${!isConnected ? ' <a href="#" onclick="window.__analysisSocket?.connect?.();return false;" style="color:#3b82f6">é‡è¿</a>' : ''}</span>
                            <span style="font-variant-numeric:tabular-nums">${pct}% Â· é˜¶æ®µ ${Math.min(step,5)}/5</span>
                        </div>
                    </div>`;

                if (p >= 1 && !window.__completionAnimationTriggered) {
                    window.__completionAnimationTriggered = true;
                    setTimeout(() => {
                        const progressEl = holder.querySelector('.progress');
                        if (progressEl) {
                            progressEl.style.opacity = '0.85';
                            progressEl.style.transition = 'opacity 1s ease-out';
                        }
                        setTimeout(() => { window.__completionAnimationTriggered = false; }, 10000);
                    }, 3000);
                }
            } catch (e) {
                console.warn('renderRealtimeAnalysisProgress error:', e);
            }
        }

        // æ–°å¢ï¼šSocket.IO æ¨é€æ›¿ä»£è½®è¯¢ï¼ˆå«æ–­çº¿é‡è¿æç¤ºï¼‰
        (function initAnalysisProgressSocket(){
            try {
                function ensureRenderPlaceholder(){ try { renderRealtimeAnalysisProgress(null); } catch {} }
                ensureRenderPlaceholder();
                if (!window.io) {
                    const s = document.createElement('script');
                    s.src = '/socket.io/socket.io.js';
                    s.onload = () => { try { initSocketLogic(); } catch (e) { console.warn('initSocketLogic error:', e); } };
                    s.onerror = () => { console.warn('åŠ è½½ socket.io å®¢æˆ·ç«¯å¤±è´¥'); };
                    document.head.appendChild(s);
                } else {
                    initSocketLogic();
                }
                function initSocketLogic(){
                    try {
                        const socket = window.__analysisSocket || io();
                        window.__analysisSocket = socket;
                        socket.on('connect', () => { try { socket.emit('subscribe-updates'); } catch {} try { renderRealtimeAnalysisProgress(null); } catch {} });
                        socket.on('disconnect', () => { try { renderRealtimeAnalysisProgress(null); } catch {} });
                        socket.on('reconnect_attempt', () => { try { renderRealtimeAnalysisProgress(null); } catch {} });
                        socket.on('reconnect', () => { try { renderRealtimeAnalysisProgress(null); } catch {} });
                        socket.on('connect_error', () => { try { renderRealtimeAnalysisProgress(null); } catch {} });
                        socket.on('analysis-progress', (payload) => { renderRealtimeAnalysisProgress(payload); });
                    } catch (e) { console.warn('socket logic error:', e); }
                }
            } catch (e) { console.warn('initAnalysisProgressSocket error:', e); }
        })();
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/strategy/status');
                const data = await response.json();
                
                if (data.success) {
                    const el = document.getElementById('systemStatus');
                    if (el) {
                        el.textContent = data.data.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœ€æ–°ä¿¡å·
        async function loadLatestSignal() {
            try {
                const response = await fetch('/api/strategy/analysis');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const s = data.data.signal || {};
                    const type = s.type || s.signal || (data.recommendation && data.recommendation.action) || 'â€”';
                    
                    // å…¼å®¹å¤šç§å¼ºåº¦ç»“æ„ï¼šæ•°å€¼(0-1)æˆ–å¯¹è±¡{ combined:0-100 }
                    let strengthVal = 0;
                    if (typeof s.strength === 'number') {
                        strengthVal = s.strength;
                    } else if (s.strength && typeof s.strength.combined === 'number') {
                        strengthVal = s.strength.combined;
                    }
                    if (strengthVal > 1) strengthVal = strengthVal / 100; // å½’ä¸€åŒ–åˆ°[0,1]
                    
                    // å…¼å®¹å¤šæ¥æºçš„ç½®ä¿¡åº¦
                    let confidence = null;
                    if (typeof s.confidence === 'number') {
                        confidence = s.confidence;
                    } else if (s.strength && typeof s.strength.confidence === 'number') {
                        confidence = s.strength.confidence;
                    } else if (data.recommendation && typeof data.recommendation.confidence === 'number') {
                        confidence = data.recommendation.confidence;
                    }
                    
                    // ä»·æ ¼ï¼šä¼˜å…ˆä½¿ç”¨ signal.price -> targetPrice -> market.price -> æ”¯æ’‘ä½
                    let price = null;
                    if (typeof s.price === 'number') {
                        price = s.price;
                    } else if (typeof s.targetPrice === 'number') {
                        price = s.targetPrice;
                    } else if (data.data.market && typeof data.data.market.price === 'number') {
                        price = data.data.market.price;
                    } else if (data.data.marketAnalysis && typeof data.data.marketAnalysis.support === 'number') {
                        price = data.data.marketAnalysis.support;
                    }
                    
                    const signalDiv = document.getElementById('currentSignal');
                    const strengthPct = isFinite(strengthVal) ? (strengthVal * 100) : 0;
                    const priceText = typeof price === 'number' ? price.toFixed(2) : '--';
                    const confText = typeof confidence === 'number' ? (confidence * 100).toFixed(1) + '%' : '--';
                    
                    if (signalDiv) {
                        signalDiv.innerHTML = `
                            <div class="signal-strength">
                                <strong>${type}</strong>
                                <div class="strength-bar">
                                    <div class="strength-fill" style="width: ${Math.max(0, Math.min(100, strengthPct))}%"></div>
                                </div>
                                <span>${isFinite(strengthPct) ? strengthPct.toFixed(1) : '--'}%</span>
                            </div>
                            <p>ä»·æ ¼: $${priceText} | ç½®ä¿¡åº¦: ${confText}</p>
                            <div id="kronosStatus" class="kronos-status" style="margin-top: 8px;"></div>
                        `;
                    }
                    
                    const _strengthEl = document.getElementById('signalStrength');
                    if (_strengthEl) _strengthEl.textContent = isFinite(strengthPct) ? strengthPct.toFixed(1) + '%' : '--';
                    const _confEl = document.getElementById('confidence');
                    if (_confEl) _confEl.textContent = confText;
                    
                    // æ›´æ–° Kronos å‚ä¸çŠ¶æ€
                    updateKronosStatus(data.data);

                    // æ›´æ–°â€œç­–ç•¥æ€§èƒ½â€ä¸­çš„ Kronos åˆ†æ•°æ¨¡å—ï¼ˆéé˜»å¡ï¼‰
                    try { updateKronosPerfCard(data.data); } catch (_) {}
                        
                    // æ›´æ–°é£é™©ç®¡ç†æ•°æ®ï¼ˆå¸¦å¥å£®æ€§æ£€æŸ¥ï¼‰
                    if (data.data.riskManagement) {
                        const risk = data.data.riskManagement;
                        const _riskScoreEl = document.getElementById('riskScore');
                        if (typeof risk.riskScore === 'number' && _riskScoreEl) _riskScoreEl.textContent = risk.riskScore.toFixed(1);
                        const _posEl = document.getElementById('positionSize');
                        if (_posEl) _posEl.textContent = confText;
                        const _stopLossEl = document.getElementById('stopLoss');
                        if (typeof risk.stopLoss === 'number' && _stopLossEl) _stopLossEl.textContent = '$' + risk.stopLoss.toFixed(2);
                        const _takeProfitEl = document.getElementById('takeProfit');
                        if (typeof risk.takeProfit === 'number' && _takeProfitEl) _takeProfitEl.textContent = '$' + risk.takeProfit.toFixed(2);
                    }
                    
                    
                    // æ¸²æŸ“â€œç­–ç•¥å•è¿›åº¦â€ï¼ˆä½¿ç”¨æœ€æ–°åˆ†æç»“æœ + é…ç½®é˜ˆå€¼ï¼‰
                    try {
                        const cfg = await ensureAppConfig();
                        renderOrderProgressFromAnalysis(data.data, cfg);
                    } catch (e) {
                        console.warn('æ¸²æŸ“ç­–ç•¥å•è¿›åº¦å¤±è´¥:', e);
                    }
                } else {
                    const el = document.getElementById('currentSignal');
                    if (el) el.innerHTML = 
                        '<div class="loading">æš‚æ— ä¿¡å·æ•°æ®</div>';
                    // æ–°å¢ï¼šåœ¨ç¼ºå°‘åˆ†ææ•°æ®æ—¶ä¹Ÿæ¸²æŸ“â€œç­–ç•¥å•è¿›åº¦â€çš„å›é€€UI
                    try {
                        const cfg = await ensureAppConfig();
                        const fallbackAnalysis = { signal: { type: 'HOLD', strength: 0, confidence: 0.5 } };
                        renderOrderProgressFromAnalysis(fallbackAnalysis, cfg);
                        try { updateKronosPerfCard(fallbackAnalysis); } catch (_) {}
                    } catch (_) {}
                }
            } catch (error) {
                console.error('åŠ è½½ä¿¡å·å¤±è´¥:', error);
                const el = document.getElementById('currentSignal');
                if (el) el.innerHTML = 
                    '<div class="error">ä¿¡å·åŠ è½½å¤±è´¥</div>';
                // å…œåº•ï¼šè¿·ä½ ä¿¡å·æ˜¾ç¤ºä¸ºè§‚æœ› 0%
                try { updateInlineSignalMini('HOLD', 0); } catch (_) {}
                // æ–°å¢ï¼šè¯·æ±‚å¤±è´¥æ—¶ä¹Ÿæ¸²æŸ“å›é€€è¿›åº¦ï¼Œè®©ç”¨æˆ·èƒ½çœ‹åˆ°â€œæ¨èå•ç”Ÿæˆè¿›åº¦æ¡â€
                try {
                    const cfg = await ensureAppConfig();
                    const fallbackAnalysis = { signal: { type: 'HOLD', strength: 0, confidence: 0.5 } };
                    renderOrderProgressFromAnalysis(fallbackAnalysis, cfg);
                    try { updateKronosPerfCard(fallbackAnalysis); } catch (_) {}
                } catch (_) {}
            }
        }
        
        // åœ¨â€œç­–ç•¥æ€§èƒ½â€å¡ç‰‡ä¸­åŠ¨æ€å±•ç¤º Kronos æ¨¡å‹åˆ†æ•°ï¼ˆéé˜»å¡ï¼Œå¸¦å…œåº•ï¼‰
        function updateKronosPerfCard(analysis) {
            try {
                ensureAppConfig().then(cfg => {
                    const kronosCfg = cfg?.strategy?.kronos || {};
                    const enabled = !!kronosCfg.enabled;

                    const listEl = document.getElementById('perfOrderProgressList');
                    if (!listEl || !listEl.parentElement) return;

                    let perfK = document.getElementById('kronosPerfContainer');
                    if (!perfK) {
                        perfK = document.createElement('div');
                        perfK.id = 'kronosPerfContainer';
                        perfK.style.marginTop = '8px';
                        perfK.style.border = '1px solid #e5e7eb';
                        perfK.style.borderRadius = '8px';
                        perfK.style.padding = '8px 10px';
                        listEl.parentElement.insertBefore(perfK, listEl);
                    }

                    const renderNeutral = (statusText) => {
                        perfK.innerHTML = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">'
                          + '<div style="font-weight:600;color:#111827">Kronos æ¨¡å‹åˆ†æ•°</div>'
                          + '<div style="font-size:12px;color:#6b7280">' + (statusText || 'ä¸­æ€§ Â· ç½®ä¿¡åº¦ --') + '</div>'
                          + '</div>'
                          + '<div style="height:8px;border-radius:999px;background:linear-gradient(90deg,#ef4444,#d1d5db,#10b981);position:relative;overflow:hidden">'
                          + '<div style="position:absolute;left:50%;transform:translateX(-50%);top:-4px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #111827;opacity:.5"></div>'
                          + '</div>';
                    };

                    if (!enabled) { renderNeutral('å·²å…³é—­'); return; }

                    const sig = analysis?.signal || analysis || {};
                    const metaK = sig?.metadata?.kronos || analysis?.metadata?.kronos || null;
                    if (!metaK) { renderNeutral('æ— æœ€è¿‘ç»“æœ'); return; }

                    const clamp01 = v => Math.max(0, Math.min(1, Number(v) || 0));
                    const longS = clamp01(metaK.score_long);
                    const shortS = clamp01(metaK.score_short);
                    const conf = clamp01(metaK.confidence ?? 0.5);
                    const directional = longS - shortS;
                    const tiltPct = Math.round((directional + 1) * 50);
                    const dirText = directional > 0.05 ? 'åå¤š' : (directional < -0.05 ? 'åç©º' : 'ä¸­æ€§');

                    // åˆ†æ®µæ¡æ¯”ä¾‹ï¼šç©ºå¤´(çº¢)=shortSï¼Œä¸­æ€§=1-(longS+shortS)ï¼Œå¤šå¤´(ç»¿)=longS
                    let sR = shortS, sG = longS, sN = 1 - shortS - longS;
                    if (sN < 0) {
                        const sum = sR + sG;
                        if (sum > 0) { sR = sR / sum; sG = sG / sum; sN = 0; }
                        else { sR = 0; sG = 0; sN = 1; }
                    }
                    const redPct = (sR * 100).toFixed(2);
                    const neutralPct = (sN * 100).toFixed(2);
                    const greenPct = (sG * 100).toFixed(2);

                    perfK.innerHTML =
                        '<div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-bottom:6px">'
                        + '<div style="font-weight:600;color:#111827">Kronos æ¨¡å‹åˆ†æ•°</div>'
                        + '<div style="display:flex;gap:10px;font-size:12px;color:#374151">'
                        + '<span>å¤šå¤´ ' + Math.round(longS * 100) + '</span>'
                        + '<span>ç©ºå¤´ ' + Math.round(shortS * 100) + '</span>'
                        + '<span>ç½®ä¿¡åº¦ ' + Math.round(conf * 100) + '%</span>'
                        + '<span>å€¾å‘ ' + dirText + '</span>'
                        + '</div>'
                        + '</div>'
                        + '<div style="height:8px;border-radius:999px;background:#e5e7eb;position:relative;overflow:hidden">'
                        +   '<div style="display:flex;height:100%;width:100%">'
                        +     '<div style="width:' + redPct + '%;background:#ef4444"></div>'
                        +     '<div style="width:' + neutralPct + '%;background:#d1d5db"></div>'
                        +     '<div style="width:' + greenPct + '%;background:#10b981"></div>'
                        +   '</div>'
                        + '<div style="position:absolute;left:' + tiltPct + '%;transform:translateX(-50%);top:-4px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid #111827"></div>'
                        + '</div>';
                }).catch(_ => {});
            } catch (_) {}
        }

        // åŠ è½½æ€§èƒ½æ•°æ®
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/strategy/performance');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const perf = data.data;
                    
                    // å®‰å…¨åœ°æ›´æ–°æ€»æ”¶ç›Šç‡
                    const totalReturnEl = document.getElementById('totalReturn');
                    if (totalReturnEl) {
                        totalReturnEl.textContent = typeof perf.totalPnlPercent === 'number' 
                            ? (perf.totalPnlPercent).toFixed(2) + '%' 
                            : '0.00%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°èƒœç‡
                    const winRateEl = document.getElementById('winRate');
                    if (winRateEl) {
                        winRateEl.textContent = typeof perf.winRate === 'number' 
                            ? (perf.winRate * 100).toFixed(1) + '%' 
                            : '0.0%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°å¤æ™®æ¯”ç‡
                    const sharpeRatioEl = document.getElementById('sharpeRatio');
                    if (sharpeRatioEl) {
                        sharpeRatioEl.textContent = typeof perf.sharpeRatio === 'number' 
                            ? perf.sharpeRatio.toFixed(2) 
                            : '0.00';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°æœ€å¤§å›æ’¤
                    const maxDrawdownEl = document.getElementById('maxDrawdown');
                    if (maxDrawdownEl) {
                        maxDrawdownEl.textContent = typeof perf.maxDrawdown === 'number' 
                            ? (perf.maxDrawdown * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¸‚åœºæ•°æ®ï¼ˆå¢åŠ é‡è¯•ä¸è¶…æ—¶å¤„ç† + å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            // const changeEl = document.querySelector('#market-change'); // å·²ç§»é™¤
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const lowHighEl = document.getElementById('lowHigh24h');
            const fundingEl = document.getElementById('fundingRate');
            const statusEl = document.getElementById('marketInlineStatus');
            
            // é¦–å…ˆå°è¯•ä½¿ç”¨ç¼“å­˜æ•°æ®
            const cachedData = localStorage.getItem('marketDataCache');
            const cacheTimestamp = localStorage.getItem('marketDataCacheTime');
            const now = Date.now();
            
            // å¦‚æœç¼“å­˜æ•°æ®å­˜åœ¨ä¸”æœªè¿‡æœŸï¼ˆ5åˆ†é’Ÿå†…ï¼‰ï¼Œå…ˆæ˜¾ç¤ºç¼“å­˜æ•°æ®
            if (cachedData && cacheTimestamp && (now - parseInt(cacheTimestamp)) < 5 * 60 * 1000) {
                try {
                    const cached = JSON.parse(cachedData);
                    updateMarketDataDOM(cached);
                    if (statusEl) {
                        statusEl.className = 'inline-status warn';
                        statusEl.textContent = 'ç¼“å­˜æ•°æ® Â· ' + fmtTime(parseInt(cacheTimestamp));
                    }
                } catch (e) {
                    console.warn('ç¼“å­˜æ•°æ®è§£æå¤±è´¥:', e);
                }
            }
            
            if (statusEl && !cachedData) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            
            try {
                // å¢åŠ é‡è¯•æ¬¡æ•°å’Œè¶…æ—¶æ—¶é—´ï¼Œæé«˜æˆåŠŸç‡
                const data = await requestJsonWithRetry('/api/market/ticker?symbol=ETH-USDT-SWAP', {}, { retries: 3, timeoutMs: 8000, backoffMs: 1000 });
                if (data.success && data.data) {
                    const market = data.data;
                    
                    // ç¼“å­˜æˆåŠŸè·å–çš„æ•°æ®
                    localStorage.setItem('marketDataCache', JSON.stringify(market));
                    localStorage.setItem('marketDataCacheTime', now.toString());
                    
                    updateMarketDataDOM(market);
            
                    lastMarketOk = true;
                    lastMarketUpdate = Date.now();
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = 'åœ¨çº¿ Â· ' + fmtTime(lastMarketUpdate);
                    }
                } else {
                    // APIè¿”å›æˆåŠŸä½†æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é™æ€æ•°æ®
                    throw new Error('APIè¿”å›æ•°æ®ä¸ºç©º');
                }
                // å¹¶è¡Œè¯·æ±‚èµ„é‡‘è´¹ç‡(8h)
                try {
                    const frRes = await fetch('/api/market/funding-rate?symbol=ETH-USDT-SWAP');
                    const frJson = await frRes.json();
                    const val = (typeof frJson?.data?.fundingRate === 'number') ? frJson.data.fundingRate : null;
                    if (fundingEl) {
                        fundingEl.textContent = (val === null || !isFinite(val)) ? '--' : (val * 100).toFixed(4) + '%';
                    }
                } catch (e) {
                    if (fundingEl) fundingEl.textContent = '--';
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                
                // å¦‚æœæœ‰ç¼“å­˜æ•°æ®ï¼Œç»§ç»­ä½¿ç”¨ç¼“å­˜æ•°æ®
                if (cachedData && cacheTimestamp) {
                    try {
                        const cached = JSON.parse(cachedData);
                        updateMarketDataDOM(cached);
                        if (statusEl) {
                            statusEl.className = 'inline-status warn';
                            statusEl.textContent = 'ä½¿ç”¨ç¼“å­˜ Â· ' + fmtTime(parseInt(cacheTimestamp));
                        }
                        return;
                    } catch (e) {
                        console.warn('ç¼“å­˜æ•°æ®è§£æå¤±è´¥:', e);
                    }
                }
                
                // å…ˆå°è¯•å›é€€ï¼šä½¿ç”¨åˆçº¦ä¿¡æ¯å¡«å……å…³é”®å­—æ®µ
                try {
                    const fallback = await requestJsonWithRetry('/api/market/contract?symbol=ETH-USDT-SWAP', {}, { retries: 1, timeoutMs: 2000, backoffMs: 400 });
                    if (fallback && fallback.success && fallback.data) {
                        updateDomWithMarketFallback(fallback.data);
                        lastMarketOk = true;
                        lastMarketUpdate = Date.now();
                        if (statusEl) {
                            statusEl.className = 'inline-status warn';
                            statusEl.textContent = 'åœ¨çº¿(é™çº§) Â· ' + fmtTime(lastMarketUpdate);
                        }
                        return;
                    }
                } catch (fallbackErr) {
                    console.warn('å›é€€è·å–åˆçº¦ä¿¡æ¯å¤±è´¥:', fallbackErr);
                }
                // å›é€€ä¹Ÿå¤±è´¥ï¼šä¸æ¸…ç©ºå·²æœ‰æ•°å€¼ï¼Œæç¤ºç¦»çº¿å¹¶æä¾›é‡è¯•
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.innerHTML = 'ç¦»çº¿ Â· è·å–å¤±è´¥ï¼Œ<a href="#" onclick="refreshMarketData(); return false;">ç‚¹å‡»é‡è¯•</a>' + (lastMarketUpdate ? (' Â· ä¸Šæ¬¡æ›´æ–° ' + fmtTime(lastMarketUpdate)) : '');
                }
                
                // å°è¯•ä½¿ç”¨é™æ€æ•°æ®å¡«å……å¸‚åœºæ•°æ®åŒºåŸŸ
                updateDomWithStaticMarketData();
            }
        }
        
        // æå–å¸‚åœºæ•°æ®DOMæ›´æ–°é€»è¾‘
        function updateMarketDataDOM(market) {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const lowHighEl = document.getElementById('lowHigh24h');
            
            if (typeof market.price === 'number') priceEl.textContent = '$' + market.price.toFixed(2);
            // ç»Ÿä¸€ä»…å±•ç¤º ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)
            let sodPct = null;
            if (typeof market.changeFromSodUtc8 === 'number') {
                sodPct = market.changeFromSodUtc8; // é¦–é€‰ï¼šAPIå­—æ®µ
            } else if (typeof market.sodUtc8 === 'number' && typeof market.last === 'number' && market.sodUtc8 > 0) {
                sodPct = ((market.last - market.sodUtc8) / market.sodUtc8) * 100; // å›é€€ï¼šåŸºäºsodUtc8
            }
            if (changeElLegacy) {
                if (sodPct === null || !isFinite(sodPct)) {
                    changeElLegacy.textContent = 'â€”';
                    changeElLegacy.style.color = '#6b7280';
                } else {
                    changeElLegacy.textContent = sodPct.toFixed(2) + '%';
                    changeElLegacy.style.color = sodPct >= 0 ? '#10b981' : '#ef4444';
                }
            }
            // 24hæœ€ä½/æœ€é«˜
            if (lowHighEl) {
                const h24 = Number(market.high24h);
                const l24 = Number(market.low24h);
                if (isFinite(h24) && isFinite(l24)) {
                    lowHighEl.textContent = `$${l24.toFixed(2)} / $${h24.toFixed(2)}`;
                } else {
                    lowHighEl.textContent = '--';
                }
            }
            // 24h æˆäº¤é¢(æŒ‰å¼ æŠ˜ç®—, USDT) = volume(å¼ ) Ã— price(USDT) Ã— 0.1
            const volLots = Number(market.volume);
            const px = Number(typeof market.price === 'number' ? market.price : (market.last ?? market.price));
            const turnoverUSDT = (Number.isFinite(volLots) && Number.isFinite(px)) ? (volLots * px * 0.1) : NaN;
            volumeEl.textContent = Number.isFinite(turnoverUSDT) ? formatUSDT(turnoverUSDT) : 'â€”';

            // 24h æŒ¯å¹…ï¼ˆé«˜ä½åŒºé—´/å½“å‰ä»·ï¼‰ï¼Œæ¯10åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡ï¼Œå‡å°‘ç½‘ç»œè´Ÿæ‹…
            if (typeof window.__ampVal === 'undefined') { window.__ampVal = null; window.__ampTs = 0; }
            const now = Date.now();
            const ttl = 10 * 60 * 1000; // 10åˆ†é’Ÿ
            const canUseCache = (typeof window.__ampVal === 'number' && isFinite(window.__ampVal) && (now - (window.__ampTs || 0) < ttl));

            if (canUseCache) {
                volEl.textContent = window.__ampVal.toFixed(2) + '%';
                volEl.classList.remove('loading-inline');
            } else {
                const h = Number(market.high24h);
                const l = Number(market.low24h);
                const p = Number(market.price ?? market.last);
                if (isFinite(h) && isFinite(l) && isFinite(p) && p > 0 && h >= l) {
                    const amp = Math.max(0, ((h - l) / p) * 100);
                    window.__ampVal = amp;
                    window.__ampTs = now;
                    volEl.textContent = amp.toFixed(2) + '%';
                    volEl.classList.remove('loading-inline');
                } else {
                    volEl.textContent = 'åŠ è½½ä¸­â€¦';
                    volEl.classList.add('loading-inline');
                }
            }
        }
        
        // ä½¿ç”¨é™æ€æ•°æ®æ›´æ–°å¸‚åœºæ•°æ®åŒºåŸŸ
        function updateDomWithStaticMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeSodEl = document.getElementById('marketChangeSod');
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const lowHighEl = document.getElementById('lowHigh24h');
            const fundingEl = document.getElementById('fundingRate');
            
            // ä½¿ç”¨é™æ€æ•°æ®
            if (priceEl && priceEl.textContent === '--') priceEl.textContent = '$4185.51';
            if (changeSodEl && changeSodEl.textContent === '--') {
                changeSodEl.textContent = '-0.04%';
                changeSodEl.style.color = '#ef4444';
            }
            if (volumeEl && volumeEl.textContent === '--') volumeEl.textContent = '25.5M';
            if (volEl && volEl.textContent === '--') volEl.textContent = '2.15%';
            if (lowHighEl && lowHighEl.textContent === '--') lowHighEl.textContent = '$4101.80 / $4302.70';
            if (fundingEl && fundingEl.textContent === '--') fundingEl.textContent = '0.0100%';
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            // ç®€å•çš„è¿è¡Œæ—¶é—´è®¡ç®—
            const startTime = localStorage.getItem('systemStartTime');
            if (!startTime) {
                localStorage.setItem('systemStartTime', Date.now());
                return;
            }
            
            const uptime = Date.now() - parseInt(startTime);
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            const el = document.getElementById('uptime');
            if (el) el.textContent = `${hours}h ${minutes}m`;
        }
        
        // åˆ·æ–°ä¿¡å·
        function refreshSignal() {
            loadLatestSignal();
        }
        
        // åˆ·æ–°å¸‚åœºæ•°æ®
        function refreshMarketData() {
            loadMarketData();
        }
        
        // æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
        function viewPerformance() {
            window.open('/api/strategy/performance', '_blank');
        }
        
        // æŸ¥çœ‹é£é™©ç®¡ç†
        function viewRiskManagement() {
            window.open('/api/risk/status', '_blank');
        }
        
        // æŸ¥çœ‹å›æµ‹å†å²
        function viewBacktestHistory() {
            alert('å›æµ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...');
        }
        

        // åŠ è½½å¼€å•æ¨èï¼ˆè„šæœ¬å†…ï¼‰
        async function loadTradeRecommendation() {
            const container = document.getElementById('tradingRecommendation');
            if (!container) return;
            container.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>';
            try {
                // æ”¹ä¸ºä»…ä¾èµ– /api/active-recommendations
                const res = await fetch('/api/active-recommendations');
                const payload = await res.json();
                const d = payload?.data ?? payload;
                const list = Array.isArray(d?.recommendations)
                    ? d.recommendations
                    : Array.isArray(d)
                        ? d
                        : Array.isArray(d?.list)
                            ? d.list
                            : [];

                // æ— æ´»è·ƒæ¨èï¼šé¡¶éƒ¨çº¢è‰²æ¨ªå¹…æç¤ºï¼Œæ¨èå­—æ®µç½®ç©º
                const hasActive = Array.isArray(list) && list.length > 0;
                if (!hasActive) {
                    container.innerHTML = '<div class="error">æš‚æ— æ¨èæ“ä½œ</div>';
                    const actionEl = document.getElementById('recommendedAction');
                    const entryEl = document.getElementById('entryPrice');
                    const levEl = document.getElementById('recommendedLeverage');
                    const posEl = document.getElementById('positionSizeRecommend');
                    if (actionEl) actionEl.textContent = '';
                    if (entryEl) entryEl.textContent = '';
                    if (levEl) levEl.textContent = '';
                    if (posEl) posEl.textContent = '';
                    window.__lastRecommendation = null;
                    return;
                }

                // å­˜åœ¨æ´»è·ƒæ¨èï¼šæ¸²æŸ“è¯¦ç»†ä¿¡æ¯
                const latest = list
                    .slice()
                    .sort((a, b) => {
                        // ä¼˜å…ˆæŒ‰ created_at å€’åºï¼Œå…¶æ¬¡æŒ‰ updated_at å€’åºï¼Œé˜²æ­¢æ—§å•å› å¿ƒè·³æ›´æ–°è¢«æ’åœ¨æœ€å‰
                        const ca = new Date(a?.created_at || 0).getTime();
                        const cb = new Date(b?.created_at || 0).getTime();
                        if (cb !== ca) return cb - ca;
                        const ua = new Date(a?.updated_at || 0).getTime();
                        const ub = new Date(b?.updated_at || 0).getTime();
                        return ub - ua;
                    })[0] || list[0];

                // ä½¿ç”¨ç»Ÿä¸€çš„å­—æ®µæ˜ å°„é€»è¾‘
                const action = latest?.direction || latest?.action || '';
                const entry = latest?.entry_price || latest?.current_price || null;
                const leverage = latest?.leverage || null;
                const confidence = latest?.confidence_score || latest?.confidence || null;
                const takeProfit = latest?.take_profit_price || latest?.take_profit || null;
                const stopLoss = latest?.stop_loss_price || latest?.stop_loss || null;

                // æ ¼å¼åŒ–æ˜¾ç¤º
                const actionDisplay = String(action).toUpperCase();
                const entryDisplay = (typeof entry === 'number') ? '$' + entry.toFixed(2) : '--';
                const leverageDisplay = (typeof leverage === 'number') ? leverage + 'x' : '--';
                
                let confidenceDisplay = '--';
                if (typeof confidence === 'number') {
                    const conf = confidence <= 1 ? confidence * 100 : confidence;
                    confidenceDisplay = conf.toFixed(1) + '%';
                }
                
                const tpDisplay = (typeof takeProfit === 'number') ? '$' + takeProfit.toFixed(2) : '--';
                const slDisplay = (typeof stopLoss === 'number') ? '$' + stopLoss.toFixed(2) : '--';

                container.innerHTML = `
                    <div class="row"><span class="key">æ¨èæ“ä½œ</span><span class="val">${actionDisplay}</span></div>
                    <div class="row"><span class="key">å…¥åœºä»·ä½</span><span class="val">${entryDisplay}</span></div>
                    <div class="row"><span class="key">æ¨èæ æ†</span><span class="val">${leverageDisplay}</span></div>
                    <div class="row"><span class="key">ç½®ä¿¡åº¦</span><span class="val">${confidenceDisplay}</span></div>
                    <div class="row"><span class="key">æ­¢ç›ˆ/æ­¢æŸ</span><span class="val">${tpDisplay} / ${slDisplay}</span></div>
                `;

                const actionEl = document.getElementById('recommendedAction');
                const entryEl = document.getElementById('entryPrice');
                const levEl = document.getElementById('recommendedLeverage');
                const posEl = document.getElementById('positionSizeRecommend');
                if (actionEl) actionEl.textContent = actionDisplay;
                if (entryEl) entryEl.textContent = entryDisplay;
                if (levEl) levEl.textContent = leverageDisplay;
                if (posEl) posEl.textContent = confidenceDisplay;

                window.__lastRecommendation = { 
                    action: actionDisplay, 
                    entry: entryDisplay, 
                    leverage: leverageDisplay, 
                    tp: tpDisplay, 
                    sl: slDisplay, 
                    conf: confidenceDisplay 
                };
            } catch (err) {
                console.error('åŠ è½½å¼€å•æ¨èå¤±è´¥:', err);
                container.innerHTML = '<div class="error">æ¨èåŠ è½½å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šå¼€å¤š/å¼€ç©ºæŒ‰é’®ï¼ˆæ¼”ç¤ºæç¤ºï¼‰
        function openLongPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€å¤š:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}`);
        }
        function openShortPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€ç©º:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}`);
        }
        function formatPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v || '--'); }
        function formatLev(v){ return (typeof v === 'number') ? (v + 'x') : (v || '--'); }
        
        // äº¤æ˜“æŒ‰é’®çŠ¶æ€æ§åˆ¶ï¼šNONE/LONG/SHORT
        function setTradeButtonsState(direction){
            try{
                const btnLong = document.getElementById('btnLong');
                const btnShort = document.getElementById('btnShort');
                const dir = String(direction||'NONE').toUpperCase();
                if(!btnLong || !btnShort){ return; }
                if(dir === 'LONG'){
                    btnLong.disabled = false;
                    btnShort.disabled = true;
                } else if(dir === 'SHORT'){
                    btnLong.disabled = true;
                    btnShort.disabled = false;
                } else {
                    btnLong.disabled = true;
                    btnShort.disabled = true;
                }
            }catch(e){ /* å¿½ç•¥ UI çŠ¶æ€å¼‚å¸¸ */ }
        }
        
        // æ¨èå†å²ç›¸å…³åŠŸèƒ½
        let recommendationData = [];
        let filteredRecommendations = [];
        // æ–°å¢ï¼šåˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        let pageSize = 5; // æ¢å¤æ¯é¡µ5æ¡æ•°æ®
        const selectedRecommendationIds = new Set();
        // æ¥è‡ªåç«¯çš„çœŸå®æ€»æ•°ä¸æ´»è·ƒæ•°ï¼ˆä¼˜å…ˆç”¨äºç»Ÿè®¡å±•ç¤ºï¼‰
        
        // è°ƒè¯•ï¼šæ·»åŠ å…¨å±€å˜é‡ç›‘æ§
        window.debugRecommendations = () => {
            console.log('recommendationData:', recommendationData);
            console.log('filteredRecommendations:', filteredRecommendations);
            console.log('currentPage:', currentPage);
            console.log('pageSize:', pageSize);
        };
        let serverTotalRecommendations = null;
        let serverActiveRecommendationsCount = null;
        
        // æ–°å¢ï¼šè·å–å½“å‰é¡µå¯è§æ•°æ®
        function getVisiblePageItems(){
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages; // è¶Šç•Œå®¹é”™
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const result = filteredRecommendations.slice(start, end);
            return result;
        }

        function updateDeleteButtonState() {
            const btn = document.getElementById('deleteSelectedBtn');
            if (!btn) return;
            const count = selectedRecommendationIds.size;
            btn.disabled = count === 0;
            btn.textContent = `åˆ é™¤æ‰€é€‰(${count})`;
        }
        function resetHeaderCheckbox() {
            const headerCb = document.getElementById('selectAllRecs');
            if (!headerCb) return;
            const visibleIds = getVisiblePageItems().map(r => r.id).filter(Boolean);
            if (visibleIds.length === 0) {
                headerCb.checked = false;
                headerCb.indeterminate = false;
                return;
            }
            const selectedVisible = visibleIds.filter(id => selectedRecommendationIds.has(id));
            headerCb.checked = selectedVisible.length === visibleIds.length && visibleIds.length > 0;
            headerCb.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visibleIds.length;
        }
        function toggleSelectAll(cb){
            const shouldSelect = cb?.checked;
            getVisiblePageItems().forEach(rec => {
                if (!rec?.id) return;
                if (shouldSelect) {
                    selectedRecommendationIds.add(rec.id);
                } else {
                    selectedRecommendationIds.delete(rec.id);
                }
            });
            renderRecommendationList();
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        function onRowSelectChange(id, checked){
            if (!id) return;
            if (checked) selectedRecommendationIds.add(id); else selectedRecommendationIds.delete(id);
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        
        // åŠ è½½æ¨èå†å²
        async function loadRecommendationHistory(preservePage = false) {
            const statusEl = document.getElementById('recommendationInlineStatus');
            const listEl = document.getElementById('recommendationList');
            
            // å¹¶å‘ä¿æŠ¤ï¼šè‹¥æ­£åœ¨åŠ è½½ï¼Œåˆ™ä»…è®¾ç½®å°¾éšåˆ·æ–°æ ‡è®°å¹¶è¿”å›ï¼Œé¿å… UI é—ªçƒ
            if (window.__historyLoading) { window.__historyPending = true; return; }
            window.__historyLoading = true;
            
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            
            try {
                const statusFilterVal = document.getElementById('statusFilter')?.value || 'all';
                const includeActive = (statusFilterVal === 'ACTIVE' || statusFilterVal === 'all');
                const response = await fetch(`/api/recommendations?include_active=${includeActive}`, { cache: 'no-store' });
                const data = await response.json();
                
                // å…¼å®¹ä¸åŒå“åº”ç»“æ„ï¼š
                // 1) { success: true, data: [...] }
                // 2) { success: true, data: { list: [...] , total, ... } }
                // 3) { list: [...] }
                const list = Array.isArray(data)
                  ? data
                  : Array.isArray(data?.data)
                    ? data.data
                    : Array.isArray(data?.data?.recommendations)
                      ? data.data.recommendations
                      : Array.isArray(data?.data?.list)
                        ? data.data.list
                        : Array.isArray(data?.list)
                          ? data.list
                          : [];
                // è¯»å–åç«¯æ€»æ•°ï¼ˆå¦‚æœæä¾›ï¼‰
                serverTotalRecommendations =
                  (typeof data?.data?.total === 'number') ? data.data.total :
                  (typeof data?.total === 'number') ? data.total : null;
                
                if ((data?.success === true && list) || list.length > 0) {
                    // å†å²åˆ—è¡¨å»é‡ï¼ˆå®¹é”™ï¼‰ï¼šæŒ‰â€œæ—¶é—´åˆ°ç§’ + æ ‡çš„ + æ–¹å‘(å½’ä¸€) + å…³é”®ä»·ä½(è¿‘ä¼¼)â€åˆ†ç»„ï¼Œç»„å†…ä¿ç•™æœ€æ–°/æ›´é«˜ç½®ä¿¡åº¦
                    const bySig = new Map();
                    const normDir = (d) => {
                        const x = String(d || '').toUpperCase();
                        if (x === 'BUY') return 'LONG';
                        if (x === 'SELL') return 'SHORT';
                        return x;
                    };
                    const normNum = (v) => {
                        const n = Number(v);
                        if (!isFinite(n)) return '';
                        // ä»·æ ¼å®¹å·®ï¼šä¿ç•™ä¸¤ä½å°æ•°åšåˆ†ç»„ï¼Œé¿å…å¾®å°æµ®ç‚¹å·®å¼‚é€ æˆé‡å¤
                        return (Math.round(n * 100) / 100).toFixed(2);
                    };
                    for (const r of list) {
                        const t = new Date(r?.created_at || r?.createdAt || r?.create_time || r?.timestamp || 0).getTime();
                        const tBucket = isFinite(t) ? Math.floor(t / 5000) * 5000 : 0; // 5ç§’æ¡¶
                        const sym = String(r?.symbol || '').toUpperCase();
                        const dir = normDir(r?.direction || r?.action);
                        const entry = normNum(r?.entry_price);
                        const tp = normNum(r?.take_profit_price ?? r?.take_profit);
                        const sl = normNum(r?.stop_loss_price ?? r?.stop_loss);
                        const sig = `t${tBucket}|${sym}|${dir}|e${entry}|tp${tp}|sl${sl}`;
                        const prev = bySig.get(sig);
                        if (!prev) {
                            bySig.set(sig, r);
                        } else {
                            const tPrev = new Date(prev?.created_at || prev?.createdAt || prev?.create_time || prev?.timestamp || 0).getTime();
                            const newer = t > tPrev;
                            const conf = Number(r?.confidence ?? r?.conf ?? r?.confidence_score);
                            const pconf = Number(prev?.confidence ?? prev?.conf ?? prev?.confidence_score);
                            const betterConf = isFinite(conf) && (!isFinite(pconf) || conf > pconf);
                            if (newer || (!newer && betterConf)) bySig.set(sig, r);
                        }
                    }
                    const dedup = Array.from(bySig.values());
                    recommendationData = list; // ä¸´æ—¶ç¦ç”¨å»é‡é€»è¾‘ï¼Œç›´æ¥ä½¿ç”¨åŸå§‹æ•°æ®
                    filteredRecommendations = [...recommendationData];
                    
                    // åº”ç”¨å½“å‰ç­›é€‰å’Œæ’åºï¼ˆè‡ªåŠ¨åˆ·æ–°æ—¶ä¿ç•™é¡µç ï¼‰
                    filterRecommendations(preservePage);
                    sortRecommendations(preservePage);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    await updateRecommendationStats();
                    
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        // è‹¥åç«¯æä¾› totalï¼Œåˆ™æ˜¾ç¤º totalï¼Œå¦åˆ™æ˜¾ç¤ºå½“å‰æ‰¹æ¬¡æ¡æ•°
                        const shown = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
                        statusEl.textContent = `å·²åŠ è½½ ${shown} æ¡ï¼ˆå½“å‰æ‰¹æ¬¡ ${recommendationData.length}ï¼‰`;
                    }
                    // æ¸…ç©ºå ä½å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (listEl && listEl.innerHTML && listEl.innerHTML.includes('æ­£åœ¨åŠ è½½æ¨èè®°å½•')) {
                        listEl.innerHTML = '';
                    }

                } else {
                    if (listEl) {
                        listEl.innerHTML = '<div class="error">æš‚æ— æ¨èè®°å½•</div>';
                    }
                    if (statusEl) {
                        statusEl.className = 'inline-status warn';
                        statusEl.textContent = 'æš‚æ— æ•°æ®';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¨èå†å²å¤±è´¥:', error);
                if (listEl) {
                    listEl.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.textContent = 'åŠ è½½å¤±è´¥';
                }
            } finally {
                window.__historyLoading = false;
                if (window.__historyPending) {
                    window.__historyPending = false;
                    setTimeout(() => loadRecommendationHistory(true), 80);
                }
            }
        }
        
        // æ¸²æŸ“æ¨èåˆ—è¡¨åˆ°è¡¨æ ¼ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function renderRecommendationList() {
            const tableBodyEl = document.getElementById('recommendationTableBody');
            if (!tableBodyEl) return;
            
            if (filteredRecommendations.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="11" class="loading">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¨èè®°å½•</td></tr>';
                renderPagination();
                resetHeaderCheckbox();
                return;
            }
            const pageItems = getVisiblePageItems();
            if (pageItems.length === 0) {
                currentPage = Math.max(1, currentPage - 1);
                return renderRecommendationList();
            }
            
            const html = pageItems.map(rec => {
                const dt = new Date(rec.created_at || rec.timestamp);
                const time = dt.toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
                const iso = dt.toISOString();
                const actionRaw = rec.direction || rec.action || 'HOLD';
                const action = String(actionRaw).toUpperCase();
                const status = rec.status || 'PENDING';
                const pnl = (typeof rec.pnl_percent === 'number') ? rec.pnl_percent : ((typeof rec.pnl_percentage === 'number') ? rec.pnl_percentage : null);
                const hasPnl = (typeof pnl === 'number') && Number.isFinite(pnl);
                const pnlClass = hasPnl ? (pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : '') : '';
                const confidence = rec.confidence_score || rec.confidence || 0;
                const accent = action === 'LONG' ? 'accent-long' : (action === 'SHORT' ? 'accent-short' : 'accent-hold');
                const isChecked = rec.id ? selectedRecommendationIds.has(rec.id) : false;
                
                // çŠ¶æ€æ˜¾ç¤ºæ˜ å°„
                const statusMap = {
                    'PENDING': 'å¾…ç¡®è®¤',
                    'ACTIVE': 'è¿›è¡Œä¸­',
                    'CLOSED': 'å·²å¹³ä»“',
                    'EXPIRED': 'å·²è¿‡æœŸ'
                };
                
                // å‡ºåœºåŸå› æ˜ å°„
                const reasonMap = {
                    'TIMEOUT': 'è¶…æ—¶',
                    'TAKE_PROFIT': 'æ­¢ç›ˆ',
                    'STOP_LOSS': 'æ­¢æŸ',
                    'MANUAL': 'æ‰‹åŠ¨',
                    'BREAKEVEN': 'ä¿æœ¬',
                    'LIQUIDATION': 'çˆ†ä»“'
                };
                const reasonRaw = (rec.exit_reason || '').toUpperCase();
                let statusText = statusMap[status] || status;
                let reasonBadgeHtml = '';
                if (status === 'CLOSED' || status === 'EXPIRED') {
                    if (status === 'EXPIRED') {
                        statusText = 'å·²å¹³ä»“';
                        reasonBadgeHtml = `<span class="reason-badge">è¶…æ—¶ï¼ˆå†å²ï¼‰</span>`;
                    } else {
                        // ä¼˜åŒ–ï¼šå¯¹ "æ­¢æŸ" åœ¨æ­£æ”¶ç›Šæˆ–ä¿æœ¬åŒºé—´å†…çš„åœºæ™¯åšæ›´å‹å¥½çš„è¯´æ˜
                        let reasonText = reasonMap[reasonRaw];
                        if (reasonRaw === 'STOP_LOSS') {
                            if (typeof pnl === 'number' && pnl > 0.05) {
                                reasonText = 'åŠ¨æ€æ­¢ç›ˆ';
                            } else if (typeof pnl === 'number' && Math.abs(pnl) <= 0.05) {
                                reasonText = 'ä¿æœ¬æ­¢æŸ';
                            }
                        }
                        if (reasonText) reasonBadgeHtml = `<span class="reason-badge">${reasonText}</span>`;
                    }
                }
                
                return `
                    <tr class="recommendation-row ${status.toLowerCase()} ${accent}">
                        <td style="text-align:center"><input type="checkbox" ${isChecked ? 'checked' : ''} ${rec.id ? '' : 'disabled'} onchange="onRowSelectChange('${rec.id ?? ''}', this.checked)"/></td>
                        <td title="${iso}">${time}</td>
                        <td><span class="action-badge ${action.toLowerCase()}">${action}</span></td>
                        <td>${formatPrice(rec.entry_price)}</td>
                        <td>${formatLev(rec.leverage)}</td>
                        <td>${formatPrice(rec.take_profit_price || rec.take_profit)}</td>
                        <td>${formatPrice(rec.stop_loss_price || rec.stop_loss)}</td>
                        <td>${confidence ? (confidence <= 1 ? (confidence * 100).toFixed(1) : confidence.toFixed(1)) + '%' : '--'}</td>
                        <td><span class="status-badge ${status.toLowerCase()}">${statusText}</span>${reasonBadgeHtml}</td>
                        <td>${(status === 'CLOSED' || status === 'EXPIRED') ? formatPrice(rec.exit_price) : '--'}</td>
                        <td><span class="pnl-value ${pnlClass}">${hasPnl ? (pnl > 0 ? '+' : '') + pnl.toFixed(2) + '%' : '--'}</span></td>
                    </tr>
                `;
            }).join('');
            
            tableBodyEl.innerHTML = html;
            try { renderTimeInsights(); } catch(_) {}
            renderPagination();
            resetHeaderCheckbox();
        }
        
        // æ—¶é—´æ´å¯Ÿï¼šè¿‘24å°æ—¶å°æ—¶åˆ†å¸ƒ + 5ç§’å†…èšç±»
        function renderTimeInsights(){
            const container = document.getElementById('timeInsights');
            if(!container) return;
            const source = Array.isArray(filteredRecommendations) && filteredRecommendations.length>0 ? filteredRecommendations : (Array.isArray(recommendationData)?recommendationData:[]);
            if(!Array.isArray(source) || source.length===0){ container.innerHTML=''; return; }
            const now = Date.now();
            const start = now - 24*3600*1000;
            const ts = source.map(r=> new Date(r?.created_at||r?.timestamp).getTime()).filter(t=> Number.isFinite(t) && t>0);
            const ts24 = ts.filter(t=> t>=start).sort((a,b)=>a-b);
            // 5ç§’ç°‡
            let clusters=0, maxSize=1, run=1;
            for(let i=1;i<ts24.length;i++){
                if(ts24[i]-ts24[i-1] <= 5000){ run++; } else { if(run>=2) clusters++; if(run>maxSize) maxSize=run; run=1; }
            }
            if(run>=2) clusters++; if(run>maxSize) maxSize=Math.max(maxSize, run);
            // å°æ—¶æ¡¶
            const buckets = new Array(24).fill(0);
            ts24.forEach(t=>{ const h=new Date(t).getHours(); buckets[h]++; });
            const max = Math.max(1, ...buckets);
            const cells = buckets.map((c,i)=>{
                const alpha = (0.15 + 0.85*(c/max)).toFixed(2);
                const bg = `rgba(51,102,204,${alpha})`;
                const title = `${String(i).padStart(2,'0')}:00 - ${String(i).padStart(2,'0')}:59 Â· ${c}æ¡`;
                return `<div title="${title}" style="flex:1;height:16px;margin:0 1px;border-radius:3px;background:${bg}"></div>`;
            }).join('');
            const tz = (Intl.DateTimeFormat().resolvedOptions().timeZone||'æœ¬åœ°');
            const info = `è¿‘24å°æ—¶ ${ts24.length} æ¡ Â· 5ç§’å†…èšç±» ${clusters} ç»„ï¼ˆæœ€å¤§ ${maxSize} æ¡ï¼‰`;
            container.innerHTML = `<div style="display:flex;align-items:center;justify-content:space-between;margin:8px 0 4px 0;font-size:12px;color:#6b7280"><div>${info}</div><div style="color:#9ca3af">æ—¶é—´ç²¾åº¦ï¼š5ç§’ Â· æ—¶åŒºï¼š${tz}</div></div><div style="display:flex;align-items:center;margin:4px 0">${cells}</div>`;
            const statusEl = document.getElementById('recommendationInlineStatus');
            if(statusEl){ statusEl.className='inline-status ok'; statusEl.textContent='å·²åŠ è½½ Â· 5ç§’æ—¶é—´'; }
        }
        
        // ç­›é€‰æ¨èï¼ˆå¯é€‰ï¼šä¿ç•™å½“å‰é¡µï¼‰
        function filterRecommendations(preservePage = false) {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            // å½“ç”¨æˆ·åˆ‡æ¢åˆ°â€œè¿›è¡Œä¸­â€æ—¶ï¼Œå¦‚æœå½“å‰æ•°æ®æºä¸å«æ´»è·ƒé¡¹ï¼Œåˆ™é‡æ–°æ‹‰å–ï¼ˆåŒ…å«æ´»è·ƒï¼‰
            if (statusFilter === 'ACTIVE') {
                const hasActiveInData = Array.isArray(recommendationData) && recommendationData.some(rec => rec?.status === 'ACTIVE' || rec?.status === 'PENDING');
                if (!hasActiveInData) {
                    loadRecommendationHistory(true); // loadRecommendationHistory ä¼šæ ¹æ®å½“å‰ç­›é€‰åŠ¨æ€ include_active
                    return; // ç­‰å¾…æ•°æ®åˆ·æ–°åå†æ¸²æŸ“
                }
            } else if (statusFilter === 'CLOSED') {
                // åˆ‡å›â€œå·²å¹³ä»“â€æ—¶ï¼Œä¸ºé¿å…ä¸ä¸Šæ–¹æ´»è·ƒåŒºé‡å¤ï¼Œç¡®ä¿æ•°æ®æºä¸åŒ…å«æ´»è·ƒé¡¹
                const hasActiveInData = Array.isArray(recommendationData) && recommendationData.some(rec => rec?.status === 'ACTIVE' || rec?.status === 'PENDING');
                if (hasActiveInData) {
                    loadRecommendationHistory(true); // åŠ¨æ€ include_active=falseï¼ˆå› å½“å‰ç­›é€‰ä¸º CLOSEDï¼‰
                    return; // ç­‰å¾…æ•°æ®åˆ·æ–°åå†æ¸²æŸ“
                }
            } else {
                // statusFilter === 'all'ï¼šå…è®¸æ•°æ®æºåŒ…å«æ´»è·ƒé¡¹ï¼Œä¸å†è§¦å‘äºŒæ¬¡æ‹‰å–ï¼Œé¿å…åˆ·æ–°æŠ–åŠ¨
            }
            
            if (statusFilter === 'all') {
                // å…¨éƒ¨çŠ¶æ€ï¼šå‰ç«¯ä¸è¿‡æ»¤ï¼Œæ•°æ®æºå·²åŒ…å«æ´»è·ƒé¡¹ï¼ˆè§ loadRecommendationHistory åˆ¤å®šï¼‰
                filteredRecommendations = [...recommendationData];
            } else if (statusFilter === 'ACTIVE') {
                filteredRecommendations = recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'PENDING');
            } else if (statusFilter === 'CLOSED') {
                // å°†å†å² EXPIRED æŠ˜å å½’ä¸ºå·²å¹³ä»“
                filteredRecommendations = recommendationData.filter(rec => rec.status === 'CLOSED' || rec.status === 'EXPIRED');
            } else {
                filteredRecommendations = recommendationData.filter(rec => rec.status === statusFilter);
            }
            if (!preservePage) currentPage = 1;
            renderRecommendationList();
            try { renderTimeInsights(); } catch(_) {}
        }
        
        // æ’åºæ¨èï¼ˆå¯é€‰ï¼šä¿ç•™å½“å‰é¡µï¼‰
        function sortRecommendations(preservePage = false) {
            const sortBy = document.getElementById('sortBy')?.value || 'created_at';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            
            filteredRecommendations.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'created_at':
                        aVal = new Date(a.created_at || a.timestamp);
                        bVal = new Date(b.created_at || b.timestamp);
                        break;
                    case 'pnl_percent':
                        aVal = a.pnl_percent || a.pnl_percentage || 0;
                        bVal = b.pnl_percent || b.pnl_percentage || 0;
                        break;
                    case 'confidence_score':
                        aVal = a.confidence_score || a.confidence || 0;
                        bVal = b.confidence_score || b.confidence || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            if (!preservePage) currentPage = 1;
            renderRecommendationList();
            try { renderTimeInsights(); } catch(_) {}
        }
        
        // æ–°å¢ï¼šæ¸²æŸ“åˆ†é¡µ
        function renderPagination(){
            const el = document.getElementById('recommendationPagination');
            if (!el) return;
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const maxShown = 5;
            let start = Math.max(1, currentPage - Math.floor(maxShown/2));
            let end = Math.min(totalPages, start + maxShown - 1);
            start = Math.max(1, Math.min(start, Math.max(1, end - maxShown + 1)));

            const pageNumbers = [];
            for (let p = start; p <= end; p++) {
                pageNumbers.push(`<button class="page-number ${p===currentPage?'active':''}" onclick="goToPage(${p})">${p}</button>`);
            }

            el.innerHTML = `
                <button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage<=1?'disabled':''}>ä¸Šä¸€é¡µ</button>
                ${pageNumbers.join('')}
                <button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>ä¸‹ä¸€é¡µ</button>
                <span class="page-info">å…± ${total} æ¡ Â· æ¯é¡µ ${pageSize} æ¡ Â· ç¬¬ ${currentPage}/${totalPages} é¡µ</span>
            `;
        }

        // æ–°å¢ï¼šç¿»é¡µå‡½æ•°
        function goToPage(p){
            const totalPages = Math.max(1, Math.ceil(filteredRecommendations.length / pageSize));
            currentPage = Math.min(Math.max(1, p), totalPages);
            renderRecommendationList();
        }
        window.goToPage = goToPage;
        
        // ç»Ÿä¸€å»é‡å‡½æ•°ï¼šæŒ‰å†å²åˆ—è¡¨è§„åˆ™å»é‡ï¼ˆæ—¶é—´æ¡¶+æ ‡çš„+æ–¹å‘+å…³é”®ä»·ä½ï¼‰
        function dedupRecommendationsByHistoryRule(list) {
            const bySig = new Map();
            const normDir = (d) => {
                const x = String(d || '').toUpperCase();
                if (x === 'BUY') return 'LONG';
                if (x === 'SELL') return 'SHORT';
                return x;
            };
            const normNum = (v) => {
                const n = Number(v);
                if (!isFinite(n)) return '';
                // ä»·æ ¼å®¹å·®ï¼šä¿ç•™ä¸¤ä½å°æ•°åšåˆ†ç»„ï¼Œé¿å…å¾®å°æµ®ç‚¹å·®å¼‚é€ æˆé‡å¤
                return (Math.round(n * 100) / 100).toFixed(2);
            };
            for (const r of list) {
                const t = new Date(r?.created_at || r?.createdAt || r?.create_time || r?.timestamp || 0).getTime();
                const tBucket = isFinite(t) ? Math.floor(t / 5000) * 5000 : 0; // 5ç§’æ¡¶
                const sym = String(r?.symbol || '').toUpperCase();
                const dir = normDir(r?.direction || r?.action);
                const entry = normNum(r?.entry_price);
                const tp = normNum(r?.take_profit_price ?? r?.take_profit);
                const sl = normNum(r?.stop_loss_price ?? r?.stop_loss);
                const sig = `t${tBucket}|${sym}|${dir}|e${entry}|tp${tp}|sl${sl}`;
                const prev = bySig.get(sig);
                if (!prev) {
                    bySig.set(sig, r);
                } else {
                    const tPrev = new Date(prev?.created_at || prev?.createdAt || prev?.create_time || prev?.timestamp || 0).getTime();
                    const newer = t > tPrev;
                    const conf = Number(r?.confidence ?? r?.conf ?? r?.confidence_score);
                    const pconf = Number(prev?.confidence ?? prev?.conf ?? prev?.confidence_score);
                    const betterConf = isFinite(conf) && (!isFinite(pconf) || conf > pconf);
                    if (newer || (!newer && betterConf)) bySig.set(sig, r);
                }
            }
            return Array.from(bySig.values());
        }

        // æ›´æ–°æ¨èç»Ÿè®¡ï¼ˆä½¿ç”¨åç«¯çœŸå® total/activeã€ç»¼åˆç»Ÿè®¡ä¸­çš„èƒœç‡ä¸å¹³å‡æ”¶ç›Šï¼‰
        async function updateRecommendationStats() {
            const total = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
            // å¼‚æ­¥è·å–çœŸå®æ´»è·ƒæ•°ï¼ˆå…¼å®¹ {data:{recommendations, count}} ç»“æ„ï¼‰
            let rawActiveList = [];
            try {
                const res = await fetch('/api/active-recommendations');
                if (res.ok) {
                    const act = await res.json();
                    const payload = act?.data ?? act;
                    const arr = Array.isArray(payload?.recommendations)
                        ? payload.recommendations
                        : Array.isArray(payload)
                            ? payload
                            : Array.isArray(payload?.list)
                                ? payload.list
                                : [];
                    rawActiveList = Array.isArray(arr) ? arr : [];
                    // åŸå§‹æ•°é‡ï¼ˆåç«¯è¿”å›ï¼‰
                    serverActiveRecommendationsCount = rawActiveList.length;
                }
            } catch(e) {
                console.warn('è·å–æ´»è·ƒæ¨èå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°ç»Ÿè®¡', e);
            }
            // åº”ç”¨ç»Ÿä¸€å»é‡è§„åˆ™è®¡ç®—æ´»è·ƒæ•°é‡
            const dedupActiveList = rawActiveList.length > 0 ? dedupRecommendationsByHistoryRule(rawActiveList) : [];
            const active = dedupActiveList.length > 0 
                ? dedupActiveList.length
                : recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'active').length;

            // èƒœç‡ä¸å¹³å‡æ”¶ç›Šä¼˜å…ˆè¯»å–ç»¼åˆç»Ÿè®¡æ¥å£ï¼ˆå…¨é‡å·²å¹³ä»“å£å¾„ï¼‰ï¼Œå¤±è´¥å›é€€åˆ°æœ¬åœ°æ ·æœ¬
            let winRateFromServer = null;
            let avgPnlFromServer = null;
            try {
                const res2 = await fetch('/api/statistics/overall');
                if (res2.ok) {
                    const ov = await res2.json();
                    const d = ov?.data ?? ov;
                    if (typeof d?.overall_win_rate === 'number') winRateFromServer = d.overall_win_rate;
                    if (typeof d?.overall_avg_pnl === 'number') avgPnlFromServer = d.overall_avg_pnl;
                    // è‹¥æ­¤å‰æœªè·å¾— total/activeï¼Œå¯ä»ç»Ÿè®¡æ¥å£è¡¥é½
                    if (typeof serverTotalRecommendations !== 'number' && typeof d?.total_recommendations === 'number') {
                        serverTotalRecommendations = d.total_recommendations;
                    }
                    if (typeof serverActiveRecommendationsCount !== 'number' && typeof d?.active_recommendations === 'number') {
                        serverActiveRecommendationsCount = d.active_recommendations;
                    }
                }
            } catch (e) {
                console.warn('è·å–ç»¼åˆç»Ÿè®¡å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°æ ·æœ¬ç»Ÿè®¡', e);
            }

            const completed = recommendationData.filter(rec => rec.status === 'CLOSED' || rec.status === 'completed');
            const localWinRate = completed.length > 0 ? 
                (completed.filter(rec => (rec.pnl_percent || rec.pnl_percentage || 0) > 0).length / completed.length * 100) : 0;
            const localAvgPnl = completed.length > 0 ? 
                (completed.reduce((sum, rec) => sum + (rec.pnl_percent || rec.pnl_percentage || 0), 0) / completed.length) : 0;
            const winRate = (typeof winRateFromServer === 'number') ? winRateFromServer : localWinRate;
            const avgPnl = (typeof avgPnlFromServer === 'number') ? avgPnlFromServer : localAvgPnl;
            
            document.getElementById('totalRecommendations').textContent = total;
            document.getElementById('activeRecommendations').textContent = active;
            document.getElementById('winRateRecommendations').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('avgPnlRecommendations').textContent = `${avgPnl.toFixed(2)}%`;
        }
        
        // åˆ·æ–°æ¨èå†å²ï¼ˆä¿ç•™å½“å‰é¡µï¼‰
        function refreshRecommendations() { loadRecommendationHistory(true); }
        
        // æ‰¹é‡åˆ é™¤æ‰€é€‰æ¨è
        async function deleteSelectedRecommendations(){
            const ids = Array.from(selectedRecommendationIds);
            if (ids.length === 0) return;
            if (!confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
            const statusEl = document.getElementById('recommendationInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨åˆ é™¤...';
            }
            document.getElementById('deleteSelectedBtn')?.setAttribute('disabled','true');
            // é€ä¸ªè°ƒç”¨åç«¯åˆ é™¤æ¥å£
            const results = await Promise.allSettled(ids.map(id => fetch(`/api/recommendations/${id}`, { method: 'DELETE' })));
            let ok = 0, fail = 0;
            for (const r of results) {
                if (r.status === 'fulfilled' && r.value?.ok) ok++; else fail++;
            }
            // æ¸…ç†é€‰æ‹© & åˆ·æ–°
            selectedRecommendationIds.clear();
            updateDeleteButtonState();
            await loadRecommendationHistory(true);
            // ç¡®ä¿ç»Ÿè®¡åŒæ­¥æœåŠ¡ç«¯
            await updateRecommendationStats();
            if (statusEl) {
                statusEl.className = fail === 0 ? 'inline-status ok' : 'inline-status warn';
                statusEl.textContent = fail === 0 ? 'åˆ é™¤å®Œæˆ' : `éƒ¨åˆ†åˆ é™¤å¤±è´¥ (${ok}/${ids.length})`;
            }
            if (fail > 0) {
                alert(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${ok} æ¡ï¼Œå¤±è´¥ ${fail} æ¡ã€‚`);
            }
        }
        
        // å¯åŠ¨ç­–ç•¥
        async function startStrategy() {
            try {
                const response = await fetch('/api/strategy/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å¯åŠ¨æˆåŠŸï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // åœæ­¢ç­–ç•¥
        async function stopStrategy() {
            try {
                const response = await fetch('/api/strategy/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å·²åœæ­¢ï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥åœæ­¢å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // é‡å¯ç­–ç•¥
        async function restartStrategy() {
            if (confirm('ç¡®å®šè¦é‡å¯ç­–ç•¥å—ï¼Ÿ')) {
                await stopStrategy();
                setTimeout(() => {
                    startStrategy();
                }, 2000);
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            if (window.__slippageTimer) {
                clearInterval(window.__slippageTimer);
            }
        };
    </script>
    <script>
    (function(){
      if (window.__ACTIVE_UI_PATCHED__) return; // é˜²é‡å¤æ³¨å…¥
      window.__ACTIVE_UI_PATCHED__ = true;
      if (typeof window.loadTradeRecommendation === 'function') {
        window.__legacyLoadTradeRecommendation = window.loadTradeRecommendation;
      }
      const AUTO_MS_DEFAULT = 30000;
      function ensureActiveStyles(){
        if(document.getElementById('active-styles')) return;
        const style=document.createElement('style');
        style.id='active-styles';
        style.textContent = `
        .active-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid #e8e8e8;border-radius:8px;background:#fafafa;margin-bottom:10px}
        .active-bar .left{display:flex;align-items:center;gap:8px}
        .active-bar .right{display:flex;align-items:center;gap:8px}
        .active-bar .label{color:#555}
        .active-bar .strong{font-weight:600}
        .active-bar .muted{color:#888}
        .active-bar .sep{color:#ddd}
        .active-bar .countdown{font-variant-numeric:tabular-nums;color:#333}
        .active-bar .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
        .active-bar .dot.on{background:#2ecc71}
        .active-bar .dot.off{background:#e74c3c}
        .btn.small{padding:6px 10px;font-size:12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;color:#2980b9}
.btn.small:hover{background:#f4f4f4}
        .btn.danger{border-color:#ffb4b4;color:#c0392b}
        .btn.danger:hover{background:#ffecec}
        .rec-list{display:flex;flex-direction:column;gap:16px}
        .rec-item{display:flex;align-items:stretch;justify-content:space-between;gap:16px;border:1px solid #eaeaea;border-radius:12px;padding:14px 16px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
        .rec-item .col.main{flex:1}
        .rec-item .title{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .rec-item .symbol{font-weight:600}
        .rec-item .muted{color:#888;font-size:12px}
        .rec-item .grid{display:grid;grid-template-columns:repeat(3,minmax(140px,1fr));gap:10px 14px}
        .rec-item .k{color:#666;margin-right:6px}
        .rec-item .v{font-variant-numeric:tabular-nums;line-height:1.5}
        .rec-item.skeleton{min-height:140px}
        .rec-item.skeleton .v{color:#bbb}
        .badge{padding:2px 6px;border-radius:6px;background:#eef;border:1px solid #dde;font-size:12px}
        .badge.long{background:#eafff3;border-color:#c4f2d8;color:#1e874b}
        .badge.short{background:#fff0f0;border-color:#ffd6d6;color:#b03a2e}
        .diff-blink{animation: diffFlash 1.2s ease-in-out 1}
        @keyframes diffFlash{0%{background:transparent}30%{background:#fff6cc}100%{background:transparent}}
        .empty-tip{padding:10px 12px;color:#666}
        @media (max-width: 560px){.rec-item{flex-direction:column}}
        .loading{padding:8px 10px;color:#666}
        .error{padding:8px 10px;color:#b03a2e}
        .alert{padding:10px 12px;border-radius:8px;margin:10px 0;font-size:14px}
        .alert-danger{background:#fff0f0;border:1px solid #ffd6d6;color:#b03a2e}
        `;
        document.head.appendChild(style);
      }
      function renderTopBar(count){
        const nextAt = Date.now() + (window.__AUTO_REFRESH_INTERVAL_MS||AUTO_MS_DEFAULT);
        window.__nextAutoRefreshAt = nextAt;
        return `<div class="active-bar" id="activeSignalBar">
          <div class="left">
            <span class="dot ${count>0?'on':'off'}"></span>
            <span class="label">æ´»è·ƒä¿¡å·</span>
            <span class="strong" id="activeSignalCount">${count}</span>
            <span class="sep">|</span>
            <span class="muted">ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°</span>
            <span class="countdown" id="nextRefreshCountdown">${Math.round((nextAt-Date.now())/1000)}s</span>
          </div>
          <div class="right">
            <button id="btnManualRefresh" class="btn small">åˆ·æ–°</button>
          </div>
        </div>`;
      }
      function ensureAutoRefreshTicker(){
        if (window.__autoRefreshTickTimer) clearInterval(window.__autoRefreshTickTimer);
        window.__autoRefreshTickTimer = setInterval(()=>{
          const el = document.getElementById('nextRefreshCountdown');
          if(!el||!window.__nextAutoRefreshAt) return;
          const remain=Math.max(0,Math.round((window.__nextAutoRefreshAt-Date.now())/1000));
          el.textContent = `${remain}s`;
        },1000);
      }
      function scheduleAutoRefresh(){
        const ms = window.__AUTO_REFRESH_INTERVAL_MS||AUTO_MS_DEFAULT;
        if (window.__nextRefreshTimer) clearTimeout(window.__nextRefreshTimer);
        window.__nextRefreshTimer = setTimeout(()=>{
          try { window.loadTradeRecommendation(); } catch(e){}
        }, ms);
      }
      function parseActiveList(d){
        const list = Array.isArray(d?.recommendations) ? d.recommendations : Array.isArray(d) ? d : Array.isArray(d?.list) ? d.list : [];
        return Array.isArray(list) ? list.filter(Boolean) : [];
      }
      // æ–°å¢ï¼šè§£æå†å²æ¨èåˆ—è¡¨
      function parseHistoryList(d){
        const data = d?.data ?? d;
        const arr = Array.isArray(data?.recommendations)
          ? data.recommendations
          : Array.isArray(data?.list)
            ? data.list
            : Array.isArray(data)
              ? data
              : [];
        return Array.isArray(arr) ? arr.filter(Boolean) : [];
      }
      // æ–°å¢ï¼šé¿å…ç‚¹å‡»å†å²æ—¶é—´æŠ›é”™ï¼Œæš‚ä¸å¯ç”¨é”å®šé€»è¾‘ï¼Œå§‹ç»ˆæ˜¾ç¤ºæœ€æ–°
      function lockRecommendation(id){ try{ window.scrollTo({top:0, behavior:'smooth'});}catch(e){} window.__lockedRecommendationId = null; window.loadTradeRecommendation?.(); }
      function fmtPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v ?? '--'); }
      function fmtLev(v){ return (typeof v === 'number') ? (v + 'x') : (v ?? '--'); }
      function fmtPct(v){ if (typeof v === 'number') return `${v<=1?(v*100).toFixed(1):v.toFixed(1)}%`; if (typeof v === 'string' && v.endsWith('%')) return v; return '--'; }
      function formatRelative(ts){ if (!ts) return '--'; const t = (ts instanceof Date) ? ts.getTime() : new Date(ts).getTime(); if (!Number.isFinite(t)) return '--'; const s = Math.max(0, Math.floor((Date.now()-t)/1000)); if (s<60) return `${s}så‰`; const m=Math.floor(s/60); if(m<60) return `${m}åˆ†é’Ÿå‰`; const h=Math.floor(m/60); if(h<24) return `${h}å°æ—¶å‰`; const d=Math.floor(h/24); return `${d}å¤©å‰`; }
      function clearItemTimers(){ /* removed per æ–¹æ¡ˆA: no per-item TTL countdown */ }
      function startItemCountdown(){ /* removed per æ–¹æ¡ˆA: no per-item TTL countdown */ }
      function diffHighlight(id,current){ const prev = (window.__lastActiveSnapshot||{})[id]; if(!window.__lastActiveSnapshot) window.__lastActiveSnapshot={}; window.__lastActiveSnapshot[id] = { direction: current.direction, entry_price: current.entry_price, take_profit_price: current.take_profit_price ?? current.take_profit, stop_loss_price: current.stop_loss_price ?? current.stop_loss, leverage: current.leverage, position_size: current.position_size }; if(!prev) return; ['direction','entry_price','take_profit_price','stop_loss_price','leverage','position_size'].forEach(k=>{ const pv=prev[k], cv=window.__lastActiveSnapshot[id][k]; if(String(pv)!==String(cv)){ const el=document.querySelector(`[data-field="${k}-${id}"]`); if(el){ el.classList.add('diff-blink'); setTimeout(()=>el.classList.remove('diff-blink'),1600); } } }); }

      window.loadTradeRecommendation = async function(){
        const container = document.getElementById('tradingRecommendation');
        if (!container) return;
        ensureActiveStyles();
        if (typeof window.__AUTO_REFRESH_INTERVAL_MS !== 'number') window.__AUTO_REFRESH_INTERVAL_MS = AUTO_MS_DEFAULT;
        container.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>';
        try {
          const res = await fetch('/api/active-recommendations',{cache:'no-store'});
          const payload = await res.json();
          const d = payload?.data ?? payload;
          const list = parseActiveList(d);
          const dedupList = Array.isArray(list) ? dedupRecommendationsByHistoryRule(list) : [];
          const hasActive = dedupList.length>0;
          const topBar = renderTopBar(dedupList.length);
          if(!hasActive){
            clearItemTimers(); ensureAutoRefreshTicker(); scheduleAutoRefresh();
            const a=document.getElementById('recommendedAction');
            const e=document.getElementById('entryPrice');
            const l=document.getElementById('recommendedLeverage');
            const p=document.getElementById('positionSizeRecommend');
            if(a) a.textContent=''; if(e) e.textContent=''; if(l) l.textContent=''; if(p) p.textContent=''; window.__lastRecommendation=null;
            container.innerHTML = `${topBar}<div class=\"alert alert-danger\">å½“å‰ä»·æ ¼æš‚æ— å¼€å•æ¨è</div><div class=\"rec-list\" id=\"activeSignalList\"><div class=\"rec-item skeleton\"><div class=\"col main\"><div class=\"title\"><span class=\"badge\">--</span><span class=\"symbol\">ETH-USDT-SWAP</span></div><div class=\"grid\"><div><span class=\"k\">å…¥åœº</span> <span class=\"v\">--</span></div><div><span class=\"k\">æ æ†</span> <span class=\"v\">--</span></div><div><span class=\"k\">é¢„æœŸæ”¶ç›Š</span> <span class=\"v\">--</span></div><div><span class=\"k\">æ­¢æŸ</span> <span class=\"v\">--</span></div><div><span class=\"k\">æ­¢ç›ˆ</span> <span class=\"v\">--</span></div><div><span class=\"k\">ç½®ä¿¡åº¦</span> <span class=\"v\">--</span></div></div></div></div></div>`
            try{ setTradeButtonsState('NONE'); }catch(_){ }
            const btn=document.getElementById('btnManualRefresh'); if(btn) btn.onclick=()=>{ window.loadTradeRecommendation(); };
            return;
          }
          // ä»…ä½¿ç”¨æ´»è·ƒæ¨èï¼ˆå»é‡åï¼‰ï¼Œå¹¶æŒ‰åˆ›å»ºæ—¶é—´å€’åºå–æœ€æ–°
          let sorted = dedupList.slice().sort((a,b)=>{ const ca=new Date(a?.created_at||a?.createdAt||a?.create_time||0).getTime(); const cb=new Date(b?.created_at||b?.createdAt||b?.create_time||0).getTime(); if(cb!==ca) return cb-ca; const ua=new Date(a?.updated_at||a?.updatedAt||0).getTime(); const ub=new Date(b?.updated_at||b?.updatedAt||0).getTime(); return ub-ua; });
          const itemsHtml = sorted.slice(0,1).map(rec=>{ const id=rec.id||rec._id||rec.uuid||''; const symbol=rec.symbol||'ETH-USDT-SWAP'; const direction=String(rec.direction||rec.action||'').toUpperCase(); const entry=(typeof rec.entry_price==='number')?rec.entry_price:(typeof rec.current_price==='number'?rec.current_price:null); const lev=(typeof rec.leverage==='number')?rec.leverage:null; const confRaw=(typeof rec.confidence_score==='number')?rec.confidence_score:(typeof rec.confidence==='number'?rec.confidence:null); const conf=(typeof confRaw==='number')?((confRaw<=1?confRaw*100:confRaw)):null; const tp=(typeof rec.take_profit_price==='number')?rec.take_profit_price:(typeof rec.take_profit==='number'?rec.take_profit:null); const sl=(typeof rec.stop_loss_price==='number')?rec.stop_loss_price:(typeof rec.stop_loss==='number'?rec.stop_loss:null); const cAt=rec.created_at||rec.createdAt||rec.create_time||null; const uAt=rec.updated_at||rec.updatedAt||null; const tag = direction==='LONG'?'åšå¤š':(direction==='SHORT'?'åšç©º':(direction||'--')); const baseEr=(typeof entry==='number' && typeof tp==='number')?(direction==='LONG'?((tp-entry)/entry):((entry-tp)/entry)):null; const erL=(typeof baseEr==='number')?((baseEr * (typeof lev==='number' && lev>0 ? lev : 1)) * 100):null; return `<div class=\"rec-item\" id=\"rec-${id}\"><div class=\"col main\"><div class=\"title\"><span class=\"badge ${direction==='LONG'?'long':(direction==='SHORT'?'short':'')}\">${tag}</span><span class=\"symbol\">${symbol}</span><span class=\"muted\">åˆ›å»º ${formatRelative(cAt)}</span>${uAt?`<span class=\"muted\">æ›´æ–° ${formatRelative(uAt)}</span>`:''}</div><div class=\"grid\"><div><span class=\"k\">å…¥åœº</span> <span class=\"v\" data-field=\"entry_price-${id}\">${fmtPrice(entry)}</span></div><div><span class=\"k\">æ æ†</span> <span class=\"v\" data-field=\"leverage-${id}\">${fmtLev(lev)}</span></div><div><span class=\"k\">é¢„æœŸæ”¶ç›Š</span> <span class=\"v\">${fmtPct(erL)}</span></div><div><span class=\"k\">æ­¢æŸ</span> <span class=\"v\" data-field=\"stop_loss_price-${id}\">${fmtPrice(sl)}</span></div><div><span class=\"k\">æ­¢ç›ˆ</span> <span class=\"v\" data-field=\"take_profit_price-${id}\">${fmtPrice(tp)}</span></div><div><span class=\"k\">ç½®ä¿¡åº¦</span> <span class=\"v\">${fmtPct(conf)}</span></div></div></div>`; }).join('');
          container.innerHTML = `${topBar}<div class="rec-list" id="activeSignalList">${itemsHtml}</div>`;
          const btn=document.getElementById('btnManualRefresh'); if(btn) btn.onclick=()=>{ window.loadTradeRecommendation(); window.loadRecommendationHistory?.(); window.updateRecommendationStats?.(); };
          clearItemTimers(); ensureAutoRefreshTicker(); scheduleAutoRefresh();
          // æ–¹æ¡ˆAï¼šä¸å†å±•ç¤ºåˆ°æœŸå€’è®¡æ—¶ï¼Œä»…åšå­—æ®µå˜åŒ–é«˜äº®
          sorted.slice(0,1).forEach(rec=>{ const id=rec.id||rec._id||rec.uuid||''; diffHighlight(id,rec); });
          document.querySelectorAll('[data-close-id]').forEach(el=>{ el.addEventListener('click', async()=>{ const id=el.getAttribute('data-close-id'); if(!id) return; if(el instanceof HTMLButtonElement){ el.disabled=true; el.textContent='å…³é—­ä¸­...'; } try{ const resp=await fetch(`/api/recommendations/${id}/close`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'USER_CLOSED'}) }); if(!resp.ok) throw new Error(`å…³é—­å¤±è´¥: ${resp.status}`); await window.loadTradeRecommendation(); window.updateRecommendationStats?.(); window.loadRecommendationHistory?.(); }catch(e){ alert('å…³é—­å¤±è´¥ï¼š'+(e?.message||e)); if(el instanceof HTMLButtonElement){ el.disabled=false; el.textContent='å…³é—­'; } } }); });
          // åŒæ­¥æ—§ç‰ˆå­—æ®µ
          const latest = sorted[0];
          const actionRaw=latest?.direction||latest?.action||''; const action=String(actionRaw).toUpperCase();
          const entryVal=(typeof latest?.entry_price==='number')?latest.entry_price:(typeof latest?.current_price==='number'?latest.current_price:null);
          const levVal=(typeof latest?.leverage==='number')?latest.leverage:null;
          const tpVal=(typeof latest?.take_profit_price==='number')?latest.take_profit_price:(typeof latest?.take_profit==='number'?latest.take_profit:null);
          const slVal=(typeof latest?.stop_loss_price==='number')?latest.stop_loss_price:(typeof latest?.stop_loss==='number'?latest.stop_loss:null);
          const confRaw=(typeof latest?.confidence_score==='number')?latest.confidence_score:(typeof latest?.confidence==='number'?latest.confidence:null);
          const conf=(typeof confRaw==='number')?(((confRaw<=1?confRaw*100:confRaw)).toFixed(1)+'%'):'--';
          const a=document.getElementById('recommendedAction'); const e=document.getElementById('entryPrice'); const l=document.getElementById('recommendedLeverage'); const p=document.getElementById('positionSizeRecommend');
          if(a) a.textContent=action; if(e) e.textContent=(typeof entryVal==='number')?'$'+entryVal.toFixed(2):String(entryVal??'--'); if(l) l.textContent=(typeof levVal==='number')?(levVal+'x'):'--'; if(p) p.textContent=conf;
          window.__lastRecommendation={action, entry:entryVal, leverage:levVal, tp:tpVal, sl:slVal, conf};
          try{ setTradeButtonsState(action); }catch(_){ }
        } catch(err) {
          console.error('åŠ è½½å¼€å•æ¨èå¤±è´¥:', err);
          const container = document.getElementById('tradingRecommendation');
          if (container) container.innerHTML = `${renderTopBar?.(0)||''}<div class=\"error\">æ¨èåŠ è½½å¤±è´¥</div>`;
          ensureAutoRefreshTicker(); scheduleAutoRefresh();
        }
      };
      // é¦–æ¬¡è£…è½½
      window.addEventListener('load', function(){ try{ window.loadTradeRecommendation(); }catch(e){} });

    })();

    // æ‰“å¼€æ¨èæ¡ä»¶é¡µé¢ - å…¨å±€å‡½æ•°
    function openConditionsPage() {
        window.open('/recommendation-conditions.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
    }
    </script>
</body>
</html>
