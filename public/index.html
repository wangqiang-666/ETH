<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="/eth-logo.svg" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
            vertical-align: -4px;
            background: url('/eth-logo.svg') no-repeat center/contain;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* é¡¶éƒ¨å³ä¾§è¯Šæ–­é¢æ¿æŒ‰é’® */
        .inspect-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .signal-display {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
            transition: width 0.3s;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .footer p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* æ–°å¢ï¼šæ¨èå¡ç‰‡æ ·å¼ */
        .trading-recommendation {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #eef2f7;
        }
        .trading-recommendation .row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 14px;
            color: #555;
        }
        .trading-recommendation .key { color: #7f8c8d; }
        .trading-recommendation .val { color: #2c3e50; font-weight: 600; }
        .trading-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* æ¨èå†å²æ ·å¼ */
        .recommendation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .recommendation-controls select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .recommendation-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .recommendation-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* æ¨èè¡¨æ ¼æ ·å¼ */
        .recommendation-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .recommendation-table th,
        .recommendation-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .recommendation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .recommendation-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .recommendation-row.pending {
            background-color: #fff3cd;
        }
        
        .recommendation-row.active {
            background-color: #d1ecf1;
        }
        
        .recommendation-row.closed {
            background-color: #d4edda;
        }
        
        .recommendation-row.expired {
            background-color: #f8d7da;
        }
        
        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-badge.long {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-badge.short {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-badge.hold {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge.active {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-badge.closed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .pnl-value.positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .pnl-value.negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .recommendation-item.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .recommendation-item.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .recommendation-item.stopped {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .recommendation-action {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .recommendation-action.LONG {
            background: #dcfce7;
            color: #166534;
        }
        
        .recommendation-action.SHORT {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .recommendation-action.HOLD {
            background: #f3f4f6;
            color: #374151;
        }
        
        .recommendation-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .recommendation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 13px;
        }
        
        .recommendation-detail {
            display: flex;
            justify-content: space-between;
        }
        
        .recommendation-detail .label {
            color: #6b7280;
        }
        
        .recommendation-detail .value {
            font-weight: 500;
        }
        
        .recommendation-pnl {
            font-weight: 600;
        }
        
        .recommendation-pnl.positive {
            color: #10b981;
        }
        
        .recommendation-pnl.negative {
            color: #ef4444;
        }
        
        .recommendation-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* æ–°å¢ï¼šè¡Œæƒ…å¡ç‰‡å†…è”çŠ¶æ€æç¤º */
        .inline-status { display: inline-block; font-size: 12px; color: #7f8c8d; margin-top: 8px; }
        .inline-status.ok { color: #27ae60; }
        .inline-status.warn { color: #f39c12; }
        .inline-status.err { color: #e74c3c; }
        .card h2 .inline-status { margin-left: auto; margin-top: 0; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                gap: 15px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="inspect-fab">
        <button class="btn" onclick="openInspect()">æ•°æ®ä¸æŒ‡æ ‡è¯Šæ–­é¢æ¿</button>
    </div>
    <div class="container">
        <div class="header">
            <h1 style="display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="/eth-logo.svg" alt="ETH" width="36" height="36" style="transform: translateY(4px);"/>
                 ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ
             </h1>
            <p>åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“ç­–ç•¥åˆ†æå¹³å°</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç­–ç•¥å¼•æ“</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>MLåˆ†æ</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>é£é™©ç®¡ç†</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <h2><span class="card-icon">ğŸ’¹</span>å¸‚åœºæ•°æ® <span id="marketInlineStatus" class="inline-status warn">æ­£åœ¨åˆå§‹åŒ–...</span></h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentPrice">--</div>
                        <div class="metric-label">å½“å‰ä»·æ ¼</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="priceChange">--</div>
                        <div class="metric-label">ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volume">--</div>
                        <div class="metric-label">24hæˆäº¤é¢(USDT)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volatility">--</div>
                        <div class="metric-label">æ³¢åŠ¨ç‡</div>
                    </div>
                    
                </div>
            </div>
            <!-- å¼€å•æ¨è -->
            <div class="card">
                <h2><span class="card-icon">ğŸ¯</span>å¼€å•æ¨è</h2>
                <div class="trading-recommendation" id="tradingRecommendation">
                    <div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="recommendedAction">--</div>
                        <div class="metric-label">æ¨èæ“ä½œ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="entryPrice">--</div>
                        <div class="metric-label">å…¥åœºä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="recommendedLeverage">--</div>
                        <div class="metric-label">æ¨èæ æ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSizeRecommend">--</div>
                        <div class="metric-label">å»ºè®®ä»“ä½</div>
                    </div>
                </div>
                <div class="trading-buttons">
                    <button class="btn btn-success" onclick="openLongPosition()">ğŸ“ˆ åšå¤š (LONG)</button>
                    <button class="btn btn-danger" onclick="openShortPosition()">ğŸ“‰ åšç©º (SHORT)</button>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    å»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·æ³¨æ„é£é™©æ§åˆ¶
                </div>
            </div>

            <!-- æ¨èå†å² -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“‹</span>æ¨èå†å² <span id="recommendationInlineStatus" class="inline-status warn">æ­£åœ¨åŠ è½½...</span></h2>
                
                <!-- ç­›é€‰å’Œæ’åºæ§ä»¶ -->
                <div class="recommendation-controls">
                    <select id="statusFilter" onchange="filterRecommendations()">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="PENDING">å¾…ç¡®è®¤</option>
                        <option value="ACTIVE">è¿›è¡Œä¸­</option>
                        <option value="CLOSED">å·²å¹³ä»“</option>
                        <option value="EXPIRED">å·²è¿‡æœŸ</option>
                    </select>
                    
                    <select id="sortBy" onchange="sortRecommendations()">
                        <option value="created_at">æŒ‰æ—¶é—´æ’åº</option>
                        <option value="pnl_percent">æŒ‰æ”¶ç›Šæ’åº</option>
                        <option value="confidence_score">æŒ‰ç½®ä¿¡åº¦æ’åº</option>
                    </select>
                    
                    <select id="sortOrder" onchange="sortRecommendations()">
                        <option value="desc">é™åº</option>
                        <option value="asc">å‡åº</option>
                    </select>
                    
                    <button class="btn btn-sm" onclick="refreshRecommendations()">åˆ·æ–°</button>
                    <button id="deleteSelectedBtn" class="btn btn-sm btn-danger" onclick="deleteSelectedRecommendations()" disabled>åˆ é™¤æ‰€é€‰(0)</button>
                </div>
                
                <div class="recommendation-table-container">
                    <table class="recommendation-table" id="recommendationTable">
                        <thead>
                            <tr>
                                <th style="width:36px;text-align:center"><input type="checkbox" id="selectAllRecs" onclick="toggleSelectAll(this)"/></th>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>å…¥åœºä»·</th>
                                <th>æ æ†</th>
                                <th>æ­¢ç›ˆ</th>
                                <th>æ­¢æŸ</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>çŠ¶æ€</th>
                                <th>æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody id="recommendationTableBody">
                            <tr>
                                <td colspan="10" class="loading">æ­£åœ¨åŠ è½½æ¨èè®°å½•...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="recommendation-stats" id="recommendationStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRecommendations">--</span>
                        <span class="stat-label">æ€»æ¨èæ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRecommendations">--</span>
                        <span class="stat-label">æ´»è·ƒä¸­</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="winRateRecommendations">--</span>
                        <span class="stat-label">èƒœç‡</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgPnlRecommendations">--</span>
                        <span class="stat-label">å¹³å‡æ”¶ç›Š</span>
                    </div>
                </div>
            </div>
            
            <!-- ç­–ç•¥æ€§èƒ½ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“ˆ</span>ç­–ç•¥æ€§èƒ½</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="totalReturn">--</div>
                        <div class="metric-label">æ€»æ”¶ç›Šç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">--</div>
                        <div class="metric-label">èƒœç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">--</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">--</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="viewPerformance()">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</button>
            </div>
            
            <!-- é£é™©ç®¡ç† -->
            <div class="card">
                <h2><span class="card-icon">ğŸ›¡ï¸</span>é£é™©ç®¡ç†</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">--</div>
                        <div class="metric-label">é£é™©è¯„åˆ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSize">--</div>
                        <div class="metric-label">å»ºè®®ä»“ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="stopLoss">--</div>
                        <div class="metric-label">æ­¢æŸä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="takeProfit">--</div>
                        <div class="metric-label">æ­¢ç›ˆä»·ä½</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="viewRiskManagement()">âš™ï¸ é£é™©è®¾ç½®</button>
            </div>
            
            <!-- å®æ—¶ç­–ç•¥åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“Š</span>å®æ—¶ç­–ç•¥åˆ†æ</h2>
                <div id="currentSignal" class="signal-display">
                    <div class="loading">æ­£åœ¨è·å–æœ€æ–°ä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="signalStrength">--</div>
                        <div class="metric-label">ä¿¡å·å¼ºåº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="confidence">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshSignal()">ğŸ”„ åˆ·æ–°ä¿¡å·</button>
            </div>

            <!-- å›æµ‹åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ”¬</span>å›æµ‹åˆ†æ</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value">å†å²éªŒè¯</div>
                        <div class="metric-label">ç­–ç•¥æœ‰æ•ˆæ€§</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">å¤šç»´åˆ†æ</div>
                        <div class="metric-label">æ€§èƒ½è¯„ä¼°</div>
                    </div>
                </div>
                <a href="/backtest" class="btn"><img src="/eth-logo.svg" alt="ETH" width="16" height="16" style="vertical-align:-3px;margin-right:6px"/> å¼€å§‹å›æµ‹</a>
                <button class="btn btn-success" onclick="viewBacktestHistory()">ğŸ“‹ å†å²è®°å½•</button>
            </div>
        </div>
        
        <div class="footer">
            <p>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ - åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“å¹³å°</p>
            <div class="footer-links">
                <a href="/api/strategy/status">APIçŠ¶æ€</a>
                <a href="/api/risk/status">é£é™©ç®¡ç†</a>
                <a href="/backtest">å›æµ‹åˆ†æ</a>
                <a href="/api/config">ç³»ç»Ÿé…ç½®</a>
            </div>
        </div>
    </div>
    
    <script>
        let updateInterval;
        let lastMarketOk = false;
        let lastMarketUpdate = 0;

        // å·¥å…·å‡½æ•°ï¼šæ‰“å¼€è¯Šæ–­é¡µ
        function openInspect() {
            window.open('/inspect.html','_blank');
        }

        // æ•°å­—æ ¼å¼åŒ–ï¼ˆUSDTï¼‰
        function formatUSDT(val) {
            if (typeof val !== 'number' || !isFinite(val)) return 'â€”';
            const abs = Math.abs(val);
            if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'B USDT';
            if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'M USDT';
            if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'K USDT';
            return val.toFixed(2) + ' USDT';
        }

        // æ—¶é—´æ ¼å¼åŒ– HH:MM:SS
        function fmtTime(ts) {
            const d = new Date(ts);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        
        // è¯·æ±‚å·¥å…·ï¼šæ”¯æŒè¶…æ—¶ä¸æŒ‡æ•°é€€é¿é‡è¯•
        async function requestJsonWithRetry(url, options = {}, cfg = { retries: 2, timeoutMs: 5000, backoffMs: 600 }) {
            let attempt = 0;
            let lastErr;
            while (attempt <= (cfg.retries ?? 0)) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), cfg.timeoutMs ?? 5000);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    lastErr = e;
                    // æ›´æ–°å†…è”çŠ¶æ€ä¸ºé‡è¯•ä¸­
                    const st = document.getElementById('marketInlineStatus');
                    if (st) {
                        st.className = 'inline-status warn';
                        st.textContent = 'è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•...';
                    }
                    if (attempt === (cfg.retries ?? 0)) break;
                    const delay = (cfg.backoffMs ?? 600) * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
                attempt++;
            }
            throw lastErr;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // ä¼˜å…ˆåŠ è½½â€œå¸‚åœºæ•°æ®â€ï¼Œæå‡é¦–å±æ„ŸçŸ¥é€Ÿåº¦
            loadMarketData();
            loadSystemStatus();
            loadLatestSignal();
            loadPerformanceData();
            loadTradeRecommendation();
            loadRecommendationHistory();
            
            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
            updateInterval = setInterval(() => {
                loadLatestSignal();
                loadMarketData();
                updateUptime();
                loadTradeRecommendation();
                loadRecommendationHistory();
            }, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡
        };
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€ï¼ˆå®¹é”™ï¼šå…ƒç´ ä¸å­˜åœ¨æ—¶è·³è¿‡ï¼‰
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/strategy/status');
                const data = await response.json();
                
                if (data.success) {
                    const el = document.getElementById('systemStatus');
                    if (el) {
                        el.textContent = data.data.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœ€æ–°ä¿¡å·
        async function loadLatestSignal() {
            try {
                const response = await fetch('/api/strategy/analysis');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const s = data.data.signal || {};
                    const type = s.type || s.signal || (data.recommendation && data.recommendation.action) || 'â€”';
                    
                    // å…¼å®¹å¤šç§å¼ºåº¦ç»“æ„ï¼šæ•°å€¼(0-1)æˆ–å¯¹è±¡{ combined:0-100 }
                    let strengthVal = 0;
                    if (typeof s.strength === 'number') {
                        strengthVal = s.strength;
                    } else if (s.strength && typeof s.strength.combined === 'number') {
                        strengthVal = s.strength.combined;
                    }
                    if (strengthVal > 1) strengthVal = strengthVal / 100; // å½’ä¸€åŒ–åˆ°[0,1]
                    
                    // å…¼å®¹å¤šæ¥æºçš„ç½®ä¿¡åº¦
                    let confidence = null;
                    if (typeof s.confidence === 'number') {
                        confidence = s.confidence;
                    } else if (s.strength && typeof s.strength.confidence === 'number') {
                        confidence = s.strength.confidence;
                    } else if (data.recommendation && typeof data.recommendation.confidence === 'number') {
                        confidence = data.recommendation.confidence;
                    }
                    
                    // ä»·æ ¼ï¼šä¼˜å…ˆä½¿ç”¨ signal.price -> targetPrice -> market.price -> æ”¯æ’‘ä½
                    let price = null;
                    if (typeof s.price === 'number') {
                        price = s.price;
                    } else if (typeof s.targetPrice === 'number') {
                        price = s.targetPrice;
                    } else if (data.data.market && typeof data.data.market.price === 'number') {
                        price = data.data.market.price;
                    } else if (data.data.marketAnalysis && typeof data.data.marketAnalysis.support === 'number') {
                        price = data.data.marketAnalysis.support;
                    }
                    
                    const signalDiv = document.getElementById('currentSignal');
                    const strengthPct = isFinite(strengthVal) ? (strengthVal * 100) : 0;
                    const priceText = typeof price === 'number' ? price.toFixed(2) : '--';
                    const confText = typeof confidence === 'number' ? (confidence * 100).toFixed(1) + '%' : '--';
                    
                    signalDiv.innerHTML = `
                        <div class="signal-strength">
                            <strong>${type}</strong>
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: ${Math.max(0, Math.min(100, strengthPct))}%"></div>
                            </div>
                            <span>${isFinite(strengthPct) ? strengthPct.toFixed(1) : '--'}%</span>
                        </div>
                        <p>ä»·æ ¼: $${priceText} | ç½®ä¿¡åº¦: ${confText}</p>
                    `;
                    
                    document.getElementById('signalStrength').textContent =
                        isFinite(strengthPct) ? strengthPct.toFixed(1) + '%' : '--';
                    document.getElementById('confidence').textContent = confText;
                        
                    // æ›´æ–°é£é™©ç®¡ç†æ•°æ®ï¼ˆå¸¦å¥å£®æ€§æ£€æŸ¥ï¼‰
                    if (data.data.riskManagement) {
                        const risk = data.data.riskManagement;
                        if (typeof risk.riskScore === 'number') document.getElementById('riskScore').textContent = risk.riskScore.toFixed(1);
                        if (typeof risk.positionSize === 'number') document.getElementById('positionSize').textContent = 
                            (risk.positionSize * 100).toFixed(1) + '%';
                        if (typeof risk.stopLoss === 'number') document.getElementById('stopLoss').textContent = '$' + risk.stopLoss.toFixed(2);
                        if (typeof risk.takeProfit === 'number') document.getElementById('takeProfit').textContent = '$' + risk.takeProfit.toFixed(2);
                    }
                } else {
                    document.getElementById('currentSignal').innerHTML = 
                        '<div class="loading">æš‚æ— ä¿¡å·æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¿¡å·å¤±è´¥:', error);
                document.getElementById('currentSignal').innerHTML = 
                    '<div class="error">ä¿¡å·åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // åŠ è½½æ€§èƒ½æ•°æ®
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/strategy/performance');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const perf = data.data;
                    
                    // å®‰å…¨åœ°æ›´æ–°æ€»æ”¶ç›Šç‡
                    const totalReturnEl = document.getElementById('totalReturn');
                    if (totalReturnEl) {
                        totalReturnEl.textContent = typeof perf.totalPnlPercent === 'number' 
                            ? (perf.totalPnlPercent * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°èƒœç‡
                    const winRateEl = document.getElementById('winRate');
                    if (winRateEl) {
                        winRateEl.textContent = typeof perf.winRate === 'number' 
                            ? (perf.winRate * 100).toFixed(1) + '%' 
                            : '0.0%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°å¤æ™®æ¯”ç‡
                    const sharpeRatioEl = document.getElementById('sharpeRatio');
                    if (sharpeRatioEl) {
                        sharpeRatioEl.textContent = typeof perf.sharpeRatio === 'number' 
                            ? perf.sharpeRatio.toFixed(2) 
                            : '0.00';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°æœ€å¤§å›æ’¤
                    const maxDrawdownEl = document.getElementById('maxDrawdown');
                    if (maxDrawdownEl) {
                        maxDrawdownEl.textContent = typeof perf.maxDrawdown === 'number' 
                            ? (perf.maxDrawdown * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¸‚åœºæ•°æ®ï¼ˆå¢åŠ é‡è¯•ä¸è¶…æ—¶å¤„ç† + å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            // const changeEl = document.querySelector('#market-change'); // å·²ç§»é™¤
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const statusEl = document.getElementById('marketInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            try {
                // é™ä½é¦–å±ç­‰å¾…ï¼šå°†è¶…æ—¶ä»5sé™åˆ°2.5sï¼Œé‡è¯•ä»2æ¬¡é™åˆ°1æ¬¡ï¼Œå¹¶å‡å°é€€é¿
                const data = await requestJsonWithRetry('/api/market/ticker?symbol=ETH-USDT-SWAP', {}, { retries: 1, timeoutMs: 2500, backoffMs: 500 });
                if (data.success && data.data) {
                    const market = data.data;
                    if (typeof market.price === 'number') priceEl.textContent = '$' + market.price.toFixed(2);
                    // ç»Ÿä¸€ä»…å±•ç¤º ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)
                    let sodPct = null;
                    if (typeof market.changeFromSodUtc8 === 'number') {
                        sodPct = market.changeFromSodUtc8; // é¦–é€‰ï¼šAPIå­—æ®µ
                    } else if (typeof market.sodUtc8 === 'number' && typeof market.last === 'number' && market.sodUtc8 > 0) {
                        sodPct = ((market.last - market.sodUtc8) / market.sodUtc8) * 100; // å›é€€ï¼šåŸºäºsodUtc8
                    }
                    if (changeElLegacy) {
                        if (sodPct === null || !isFinite(sodPct)) {
                            changeElLegacy.textContent = 'â€”';
                            changeElLegacy.style.color = '#6b7280';
                            changeElLegacy.title = 'ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)æš‚æ— æ•°æ®';
                        } else {
                            changeElLegacy.textContent = sodPct.toFixed(2) + '%';
                            changeElLegacy.style.color = sodPct >= 0 ? '#10b981' : '#ef4444';
                            changeElLegacy.title = 'ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)ï¼šä¼˜å…ˆä½¿ç”¨APIå­—æ®µchangeFromSodUtc8ï¼›å›é€€(last-sodUtc8)/sodUtc8ã€‚';
                        }
                    }
                    const turnoverUSDT = (typeof market.volume === 'number' && typeof market.price === 'number') ? (market.volume * market.price * 0.1) : NaN;
                    volumeEl.textContent = formatUSDT(turnoverUSDT);
                    const volText = (typeof market.volatility === 'number') ? (market.volatility * 100).toFixed(2) + '%' : 'â€”';
                    volEl.textContent = volText;
            
                    lastMarketOk = true;
                    lastMarketUpdate = Date.now();
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = 'åœ¨çº¿ Â· å·²æ›´æ–° ' + fmtTime(lastMarketUpdate);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                // ä¸æ¸…ç©ºå·²æœ‰æ•°å€¼ï¼Œæ”¹ä¸ºæç¤ºç¦»çº¿å¹¶æä¾›é‡è¯•
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.innerHTML = 'ç¦»çº¿ Â· è·å–å¤±è´¥ï¼Œ<a href="#" onclick="refreshMarketData(); return false;">ç‚¹å‡»é‡è¯•</a>' + (lastMarketUpdate ? (' Â· ä¸Šæ¬¡æ›´æ–° ' + fmtTime(lastMarketUpdate)) : '');
                }
            }
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            // ç®€å•çš„è¿è¡Œæ—¶é—´è®¡ç®—
            const startTime = localStorage.getItem('systemStartTime');
            if (!startTime) {
                localStorage.setItem('systemStartTime', Date.now());
                return;
            }
            
            const uptime = Date.now() - parseInt(startTime);
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
        }
        
        // åˆ·æ–°ä¿¡å·
        function refreshSignal() {
            loadLatestSignal();
        }
        
        // åˆ·æ–°å¸‚åœºæ•°æ®
        function refreshMarketData() {
            loadMarketData();
        }
        
        // æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
        function viewPerformance() {
            window.open('/api/strategy/performance', '_blank');
        }
        
        // æŸ¥çœ‹é£é™©ç®¡ç†
        function viewRiskManagement() {
            window.open('/api/risk/status', '_blank');
        }
        
        // æŸ¥çœ‹å›æµ‹å†å²
        function viewBacktestHistory() {
            alert('å›æµ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...');
        }
        

        // åŠ è½½å¼€å•æ¨èï¼ˆè„šæœ¬å†…ï¼‰
        async function loadTradeRecommendation() {
            const container = document.getElementById('tradingRecommendation');
            if (!container) return;
            container.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>';
            try {
                const res = await fetch('/api/strategy/analysis');
                const json = await res.json();
                if (!json.success || !json.data) {
                    container.innerHTML = '<div class="error">æš‚æ— æ¨èæ•°æ®</div>';
                    return;
                }
                const d = json.data;
                const rec = d.recommendation || {};
                const rm = d.riskManagement || {};
                const market = d.market || d.marketAnalysis || {};
                const action = rec.action || 'HOLD';
                const entry = (d.signal && d.signal.price) || market.price || market.support || '--';
                const leverage = rm.leverage || (d.signal && d.signal.metadata && d.signal.metadata.leverage) || '--';
                const posSize = (typeof rm.positionSize === 'number') ? (rm.positionSize * 100).toFixed(1) + '%' : '--';
                const tp = rm.takeProfit || (d.signal && d.signal.pricing && d.signal.pricing.takeProfit) || '--';
                const sl = rm.stopLoss || (d.signal && d.signal.pricing && d.signal.pricing.stopLoss) || '--';
                const conf = (typeof rec.confidence === 'number') ? (rec.confidence * 100).toFixed(1) + '%' : '--';
                
                container.innerHTML = `
                    <div class="row"><span class="key">æ¨èæ“ä½œ</span><span class="val">${action}</span></div>
                    <div class="row"><span class="key">å…¥åœºä»·ä½</span><span class="val">${typeof entry === 'number' ? '$' + entry.toFixed(2) : entry}</span></div>
                    <div class="row"><span class="key">æ¨èæ æ†</span><span class="val">${typeof leverage === 'number' ? leverage + 'x' : leverage}</span></div>
                    <div class="row"><span class="key">å»ºè®®ä»“ä½</span><span class="val">${posSize}</span></div>
                    <div class="row"><span class="key">æ­¢ç›ˆ/æ­¢æŸ</span><span class="val">${typeof tp === 'number' ? '$' + tp.toFixed(2) : tp} / ${typeof sl === 'number' ? '$' + sl.toFixed(2) : sl}</span></div>
                    <div class="row"><span class="key">ç½®ä¿¡åº¦</span><span class="val">${conf}</span></div>
                `;
                
                const actionEl = document.getElementById('recommendedAction');
                const entryEl = document.getElementById('entryPrice');
                const levEl = document.getElementById('recommendedLeverage');
                const posEl = document.getElementById('positionSizeRecommend');
                if (actionEl) actionEl.textContent = action;
                if (entryEl) entryEl.textContent = (typeof entry === 'number') ? '$' + entry.toFixed(2) : String(entry);
                if (levEl) levEl.textContent = (typeof leverage === 'number') ? leverage + 'x' : String(leverage);
                if (posEl) posEl.textContent = posSize;
                
                window.__lastRecommendation = { action, entry, leverage, posSize, tp, sl, conf };
            } catch (err) {
                console.error('åŠ è½½å¼€å•æ¨èå¤±è´¥:', err);
                container.innerHTML = '<div class="error">æ¨èåŠ è½½å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šå¼€å¤š/å¼€ç©ºæŒ‰é’®ï¼ˆæ¼”ç¤ºæç¤ºï¼‰
        function openLongPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€å¤š:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}\nä»“ä½: ${rec.posSize || '--'}`);
        }
        function openShortPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€ç©º:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}\nä»“ä½: ${rec.posSize || '--'}`);
        }
        function formatPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v || '--'); }
        function formatLev(v){ return (typeof v === 'number') ? (v + 'x') : (v || '--'); }
        
        // æ¨èå†å²ç›¸å…³åŠŸèƒ½
        let recommendationData = [];
        let filteredRecommendations = [];
        const selectedRecommendationIds = new Set();
        
        function updateDeleteButtonState() {
            const btn = document.getElementById('deleteSelectedBtn');
            if (!btn) return;
            const count = selectedRecommendationIds.size;
            btn.disabled = count === 0;
            btn.textContent = `åˆ é™¤æ‰€é€‰(${count})`;
        }
        function resetHeaderCheckbox() {
            const headerCb = document.getElementById('selectAllRecs');
            if (!headerCb) return;
            const visibleIds = filteredRecommendations.map(r => r.id).filter(Boolean);
            if (visibleIds.length === 0) {
                headerCb.checked = false;
                headerCb.indeterminate = false;
                return;
            }
            const selectedVisible = visibleIds.filter(id => selectedRecommendationIds.has(id));
            headerCb.checked = selectedVisible.length === visibleIds.length && visibleIds.length > 0;
            headerCb.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visibleIds.length;
        }
        function toggleSelectAll(cb){
            const shouldSelect = cb?.checked;
            filteredRecommendations.forEach(rec => {
                if (!rec?.id) return;
                if (shouldSelect) {
                    selectedRecommendationIds.add(rec.id);
                } else {
                    selectedRecommendationIds.delete(rec.id);
                }
            });
            renderRecommendationList();
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        function onRowSelectChange(id, checked){
            if (!id) return;
            if (checked) selectedRecommendationIds.add(id); else selectedRecommendationIds.delete(id);
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        
        // åŠ è½½æ¨èå†å²
        async function loadRecommendationHistory() {
            const statusEl = document.getElementById('recommendationInlineStatus');
            const listEl = document.getElementById('recommendationList');
            
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            
            try {
                const response = await fetch('/api/recommendations');
                const data = await response.json();
                
                // å…¼å®¹ä¸åŒå“åº”ç»“æ„ï¼š
                // 1) { success: true, data: [...] }
                // 2) { success: true, data: { list: [...] , total, ... } }
                // 3) { list: [...] }
                const list = Array.isArray(data)
                  ? data
                  : Array.isArray(data?.data)
                    ? data.data
                    : Array.isArray(data?.data?.recommendations)
                      ? data.data.recommendations
                      : Array.isArray(data?.data?.list)
                        ? data.data.list
                        : Array.isArray(data?.list)
                          ? data.list
                          : [];
                
                if ((data?.success === true && list) || list.length > 0) {
                    recommendationData = list;
                    filteredRecommendations = [...recommendationData];
                    
                    // åº”ç”¨å½“å‰ç­›é€‰å’Œæ’åº
                    filterRecommendations();
                    sortRecommendations();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateRecommendationStats();
                    
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = `å·²åŠ è½½ ${recommendationData.length} æ¡è®°å½•`;
                    }
                    // æ¸…ç©ºå ä½å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (listEl && listEl.innerHTML && listEl.innerHTML.includes('æ­£åœ¨åŠ è½½æ¨èè®°å½•')) {
                        listEl.innerHTML = '';
                    }
                } else {
                    if (listEl) {
                        listEl.innerHTML = '<div class="error">æš‚æ— æ¨èè®°å½•</div>';
                    }
                    if (statusEl) {
                        statusEl.className = 'inline-status warn';
                        statusEl.textContent = 'æš‚æ— æ•°æ®';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¨èå†å²å¤±è´¥:', error);
                if (listEl) {
                    listEl.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.textContent = 'åŠ è½½å¤±è´¥';
                }
            }
        }
        
        // æ¸²æŸ“æ¨èåˆ—è¡¨åˆ°è¡¨æ ¼
        function renderRecommendationList() {
            const tableBodyEl = document.getElementById('recommendationTableBody');
            if (!tableBodyEl) return;
            
            if (filteredRecommendations.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="10" class="loading">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¨èè®°å½•</td></tr>';
                resetHeaderCheckbox();
                return;
            }
            
            const html = filteredRecommendations.map(rec => {
                const time = new Date(rec.created_at || rec.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const actionRaw = rec.direction || rec.action || 'HOLD';
                const action = String(actionRaw).toUpperCase();
                const status = rec.status || 'PENDING';
                const pnl = rec.pnl_percent || rec.pnl_percentage || 0;
                const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : '';
                const confidence = rec.confidence_score || rec.confidence || 0;
                const accent = action === 'LONG' ? 'accent-long' : (action === 'SHORT' ? 'accent-short' : 'accent-hold');
                const isChecked = rec.id ? selectedRecommendationIds.has(rec.id) : false;
                
                // çŠ¶æ€æ˜¾ç¤ºæ˜ å°„
                const statusMap = {
                    'PENDING': 'å¾…ç¡®è®¤',
                    'ACTIVE': 'è¿›è¡Œä¸­',
                    'CLOSED': 'å·²å¹³ä»“',
                    'EXPIRED': 'å·²è¿‡æœŸ'
                };
                
                return `
                    <tr class="recommendation-row ${status.toLowerCase()} ${accent}">
                        <td style="text-align:center"><input type="checkbox" ${isChecked ? 'checked' : ''} ${rec.id ? '' : 'disabled'} onchange="onRowSelectChange('${rec.id ?? ''}', this.checked)"/></td>
                        <td>${time}</td>
                        <td><span class="action-badge ${action.toLowerCase()}">${action}</span></td>
                        <td>${formatPrice(rec.entry_price)}</td>
                        <td>${formatLev(rec.leverage)}</td>
                        <td>${formatPrice(rec.take_profit_price || rec.take_profit)}</td>
                        <td>${formatPrice(rec.stop_loss_price || rec.stop_loss)}</td>
                        <td>${confidence ? (confidence * 100).toFixed(1) + '%' : '--'}</td>
                        <td><span class="status-badge ${status.toLowerCase()}">${statusMap[status] || status}</span></td>
                        <td><span class="pnl-value ${pnlClass}">${pnl ? (pnl > 0 ? '+' : '') + pnl.toFixed(2) + '%' : '--'}</span></td>
                    </tr>
                `;
            }).join('');
            
            tableBodyEl.innerHTML = html;
            resetHeaderCheckbox();
        }
        
        // ç­›é€‰æ¨è
        function filterRecommendations() {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            if (statusFilter === 'all') {
                filteredRecommendations = [...recommendationData];
            } else {
                filteredRecommendations = recommendationData.filter(rec => rec.status === statusFilter);
            }
            
            renderRecommendationList();
        }
        
        // æ’åºæ¨è
        function sortRecommendations() {
            const sortBy = document.getElementById('sortBy')?.value || 'created_at';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            
            filteredRecommendations.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'created_at':
                        aVal = new Date(a.created_at || a.timestamp);
                        bVal = new Date(b.created_at || b.timestamp);
                        break;
                    case 'pnl_percent':
                        aVal = a.pnl_percent || a.pnl_percentage || 0;
                        bVal = b.pnl_percent || b.pnl_percentage || 0;
                        break;
                    case 'confidence_score':
                        aVal = a.confidence_score || a.confidence || 0;
                        bVal = b.confidence_score || b.confidence || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            
            renderRecommendationList();
        }
        
        // æ›´æ–°æ¨èç»Ÿè®¡
        function updateRecommendationStats() {
            const total = recommendationData.length;
            const active = recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'active').length;
            const completed = recommendationData.filter(rec => rec.status === 'CLOSED' || rec.status === 'completed');
            const winRate = completed.length > 0 ? 
                (completed.filter(rec => (rec.pnl_percent || rec.pnl_percentage || 0) > 0).length / completed.length * 100) : 0;
            const avgPnl = completed.length > 0 ? 
                (completed.reduce((sum, rec) => sum + (rec.pnl_percent || rec.pnl_percentage || 0), 0) / completed.length) : 0;
            
            document.getElementById('totalRecommendations').textContent = total;
            document.getElementById('activeRecommendations').textContent = active;
            document.getElementById('winRateRecommendations').textContent = winRate.toFixed(1) + '%';
            document.getElementById('avgPnlRecommendations').textContent = avgPnl.toFixed(2) + '%';
        }
        
        // åˆ·æ–°æ¨èå†å²
        function refreshRecommendations() {
            loadRecommendationHistory();
        }
        
        // æ‰¹é‡åˆ é™¤æ‰€é€‰æ¨è
        async function deleteSelectedRecommendations(){
            const ids = Array.from(selectedRecommendationIds);
            if (ids.length === 0) return;
            if (!confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
            const statusEl = document.getElementById('recommendationInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨åˆ é™¤...';
            }
            document.getElementById('deleteSelectedBtn')?.setAttribute('disabled','true');
            // é€ä¸ªè°ƒç”¨åç«¯åˆ é™¤æ¥å£
            const results = await Promise.allSettled(ids.map(id => fetch(`/api/recommendations/${id}`, { method: 'DELETE' })));
            let ok = 0, fail = 0;
            for (const r of results) {
                if (r.status === 'fulfilled' && r.value?.ok) ok++; else fail++;
            }
            // æ¸…ç†é€‰æ‹© & åˆ·æ–°
            selectedRecommendationIds.clear();
            updateDeleteButtonState();
            await loadRecommendationHistory();
            if (statusEl) {
                statusEl.className = fail === 0 ? 'inline-status ok' : 'inline-status warn';
                statusEl.textContent = fail === 0 ? 'åˆ é™¤å®Œæˆ' : `éƒ¨åˆ†åˆ é™¤å¤±è´¥ (${ok}/${ids.length})`;
            }
            if (fail > 0) {
                alert(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${ok} æ¡ï¼Œå¤±è´¥ ${fail} æ¡ã€‚`);
            }
        }
        
        // å¯åŠ¨ç­–ç•¥
        async function startStrategy() {
            try {
                const response = await fetch('/api/strategy/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å¯åŠ¨æˆåŠŸï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // åœæ­¢ç­–ç•¥
        async function stopStrategy() {
            try {
                const response = await fetch('/api/strategy/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å·²åœæ­¢ï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥åœæ­¢å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // é‡å¯ç­–ç•¥
        async function restartStrategy() {
            if (confirm('ç¡®å®šè¦é‡å¯ç­–ç•¥å—ï¼Ÿ')) {
                await stopStrategy();
                setTimeout(() => {
                    startStrategy();
                }, 2000);
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html>