<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="/eth-logo.svg" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
            vertical-align: -4px;
            background: url('/eth-logo.svg') no-repeat center/contain;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* é¡¶éƒ¨å³ä¾§è¯Šæ–­é¢æ¿æŒ‰é’® */
        .inspect-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .signal-display {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
            transition: width 0.3s;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .footer p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* æ–°å¢ï¼šè¡Œæƒ…å¡ç‰‡å†…è”çŠ¶æ€æç¤º */
        .inline-status { font-size: 12px; color: #7f8c8d; margin-top: 8px; }
        .inline-status.ok { color: #27ae60; }
        .inline-status.warn { color: #f39c12; }
        .inline-status.err { color: #e74c3c; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                gap: 15px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="inspect-fab">
        <button class="btn" onclick="openInspect()">æ•°æ®ä¸æŒ‡æ ‡è¯Šæ–­é¢æ¿</button>
    </div>
    <div class="container">
        <div class="header">
            <h1 style="display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="/eth-logo.svg" alt="ETH" width="36" height="36" style="transform: translateY(4px);"/>
                 ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ
             </h1>
            <p>åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“ç­–ç•¥åˆ†æå¹³å°</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç­–ç•¥å¼•æ“</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>MLåˆ†æ</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>é£é™©ç®¡ç†</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- å®æ—¶ç­–ç•¥åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“Š</span>å®æ—¶ç­–ç•¥åˆ†æ</h2>
                <div id="currentSignal" class="signal-display">
                    <div class="loading">æ­£åœ¨è·å–æœ€æ–°ä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="signalStrength">--</div>
                        <div class="metric-label">ä¿¡å·å¼ºåº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="confidence">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshSignal()">ğŸ”„ åˆ·æ–°ä¿¡å·</button>
            </div>
            
            <!-- ç­–ç•¥æ€§èƒ½ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“ˆ</span>ç­–ç•¥æ€§èƒ½</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="totalReturn">--</div>
                        <div class="metric-label">æ€»æ”¶ç›Šç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">--</div>
                        <div class="metric-label">èƒœç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">--</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">--</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="viewPerformance()">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</button>
            </div>
            
            <!-- é£é™©ç®¡ç† -->
            <div class="card">
                <h2><span class="card-icon">ğŸ›¡ï¸</span>é£é™©ç®¡ç†</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">--</div>
                        <div class="metric-label">é£é™©è¯„åˆ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSize">--</div>
                        <div class="metric-label">å»ºè®®ä»“ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="stopLoss">--</div>
                        <div class="metric-label">æ­¢æŸä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="takeProfit">--</div>
                        <div class="metric-label">æ­¢ç›ˆä»·ä½</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="viewRiskManagement()">âš™ï¸ é£é™©è®¾ç½®</button>
            </div>
            
            <!-- å›æµ‹åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ”¬</span>å›æµ‹åˆ†æ</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value">å†å²éªŒè¯</div>
                        <div class="metric-label">ç­–ç•¥æœ‰æ•ˆæ€§</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">å¤šç»´åˆ†æ</div>
                        <div class="metric-label">æ€§èƒ½è¯„ä¼°</div>
                    </div>
                </div>
                <a href="/backtest" class="btn"><img src="/eth-logo.svg" alt="ETH" width="16" height="16" style="vertical-align:-3px;margin-right:6px"/> å¼€å§‹å›æµ‹</a>
                <button class="btn btn-success" onclick="viewBacktestHistory()">ğŸ“‹ å†å²è®°å½•</button>
            </div>
            
            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <h2><span class="card-icon">ğŸ’¹</span>å¸‚åœºæ•°æ®</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentPrice">--</div>
                        <div class="metric-label">å½“å‰ä»·æ ¼</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="priceChange">--</div>
                        <div class="metric-label">ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volume">--</div>
                        <div class="metric-label">24hæˆäº¤é¢(USDT)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volatility">--</div>
                        <div class="metric-label">æ³¢åŠ¨ç‡</div>
                    </div>
                </div>
                <div id="marketInlineStatus" class="inline-status warn">æ­£åœ¨åˆå§‹åŒ–...</div>
                <button class="btn" onclick="refreshMarketData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
            </div>
            
            <!-- ç³»ç»Ÿæ§åˆ¶ -->
            <div class="card">
                <h2><span class="card-icon">âš™ï¸</span>ç³»ç»Ÿæ§åˆ¶</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="systemStatus">è¿è¡Œä¸­</div>
                        <div class="metric-label">ç³»ç»ŸçŠ¶æ€</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="uptime">--</div>
                        <div class="metric-label">è¿è¡Œæ—¶é—´</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="startStrategy()">â–¶ï¸ å¯åŠ¨ç­–ç•¥</button>
                <button class="btn btn-danger" onclick="stopStrategy()">â¹ï¸ åœæ­¢ç­–ç•¥</button>
                <button class="btn btn-warning" onclick="restartStrategy()">ğŸ”„ é‡å¯ç­–ç•¥</button>
            </div>
        </div>
        
        <div class="footer">
            <p>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ - åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“å¹³å°</p>
            <div class="footer-links">
                <a href="/api/strategy/status">APIçŠ¶æ€</a>
                <a href="/api/risk/status">é£é™©ç®¡ç†</a>
                <a href="/backtest">å›æµ‹åˆ†æ</a>
                <a href="/api/config">ç³»ç»Ÿé…ç½®</a>
            </div>
        </div>
    </div>
    
    <script>
        let updateInterval;
        let lastMarketOk = false;
        let lastMarketUpdate = 0;

        // å·¥å…·å‡½æ•°ï¼šæ‰“å¼€è¯Šæ–­é¡µ
        function openInspect() {
            window.open('/inspect.html','_blank');
        }

        // æ•°å­—æ ¼å¼åŒ–ï¼ˆUSDTï¼‰
        function formatUSDT(val) {
            if (typeof val !== 'number' || !isFinite(val)) return 'â€”';
            const abs = Math.abs(val);
            if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'B USDT';
            if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'M USDT';
            if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'K USDT';
            return val.toFixed(2) + ' USDT';
        }

        // æ—¶é—´æ ¼å¼åŒ– HH:MM:SS
        function fmtTime(ts) {
            const d = new Date(ts);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        
        // è¯·æ±‚å·¥å…·ï¼šæ”¯æŒè¶…æ—¶ä¸æŒ‡æ•°é€€é¿é‡è¯•
        async function requestJsonWithRetry(url, options = {}, cfg = { retries: 2, timeoutMs: 5000, backoffMs: 600 }) {
            let attempt = 0;
            let lastErr;
            while (attempt <= (cfg.retries ?? 0)) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), cfg.timeoutMs ?? 5000);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    lastErr = e;
                    // æ›´æ–°å†…è”çŠ¶æ€ä¸ºé‡è¯•ä¸­
                    const st = document.getElementById('marketInlineStatus');
                    if (st) {
                        st.className = 'inline-status warn';
                        st.textContent = 'è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•...';
                    }
                    if (attempt === (cfg.retries ?? 0)) break;
                    const delay = (cfg.backoffMs ?? 600) * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
                attempt++;
            }
            throw lastErr;
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // ä¼˜å…ˆåŠ è½½â€œå¸‚åœºæ•°æ®â€ï¼Œæå‡é¦–å±æ„ŸçŸ¥é€Ÿåº¦
            loadMarketData();
            loadSystemStatus();
            loadLatestSignal();
            loadPerformanceData();
            
            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
            updateInterval = setInterval(() => {
                loadLatestSignal();
                loadMarketData();
                updateUptime();
            }, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡
        };
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/strategy/status');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('systemStatus').textContent = 
                        data.data.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœ€æ–°ä¿¡å·
        async function loadLatestSignal() {
            try {
                const response = await fetch('/api/strategy/analysis');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const s = data.data.signal || {};
                    const type = s.type || s.signal || (data.recommendation && data.recommendation.action) || 'â€”';
                    
                    // å…¼å®¹å¤šç§å¼ºåº¦ç»“æ„ï¼šæ•°å€¼(0-1)æˆ–å¯¹è±¡{ combined:0-100 }
                    let strengthVal = 0;
                    if (typeof s.strength === 'number') {
                        strengthVal = s.strength;
                    } else if (s.strength && typeof s.strength.combined === 'number') {
                        strengthVal = s.strength.combined;
                    }
                    if (strengthVal > 1) strengthVal = strengthVal / 100; // å½’ä¸€åŒ–åˆ°[0,1]
                    
                    // å…¼å®¹å¤šæ¥æºçš„ç½®ä¿¡åº¦
                    let confidence = null;
                    if (typeof s.confidence === 'number') {
                        confidence = s.confidence;
                    } else if (s.strength && typeof s.strength.confidence === 'number') {
                        confidence = s.strength.confidence;
                    } else if (data.recommendation && typeof data.recommendation.confidence === 'number') {
                        confidence = data.recommendation.confidence;
                    }
                    
                    // ä»·æ ¼ï¼šä¼˜å…ˆä½¿ç”¨ signal.price -> targetPrice -> market.price -> æ”¯æ’‘ä½
                    let price = null;
                    if (typeof s.price === 'number') {
                        price = s.price;
                    } else if (typeof s.targetPrice === 'number') {
                        price = s.targetPrice;
                    } else if (data.data.market && typeof data.data.market.price === 'number') {
                        price = data.data.market.price;
                    } else if (data.data.marketAnalysis && typeof data.data.marketAnalysis.support === 'number') {
                        price = data.data.marketAnalysis.support;
                    }
                    
                    const signalDiv = document.getElementById('currentSignal');
                    const strengthPct = isFinite(strengthVal) ? (strengthVal * 100) : 0;
                    const priceText = typeof price === 'number' ? price.toFixed(2) : '--';
                    const confText = typeof confidence === 'number' ? (confidence * 100).toFixed(1) + '%' : '--';
                    
                    signalDiv.innerHTML = `
                        <div class="signal-strength">
                            <strong>${type}</strong>
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: ${Math.max(0, Math.min(100, strengthPct))}%"></div>
                            </div>
                            <span>${isFinite(strengthPct) ? strengthPct.toFixed(1) : '--'}%</span>
                        </div>
                        <p>ä»·æ ¼: $${priceText} | ç½®ä¿¡åº¦: ${confText}</p>
                    `;
                    
                    document.getElementById('signalStrength').textContent =
                        isFinite(strengthPct) ? strengthPct.toFixed(1) + '%' : '--';
                    document.getElementById('confidence').textContent = confText;
                        
                    // æ›´æ–°é£é™©ç®¡ç†æ•°æ®ï¼ˆå¸¦å¥å£®æ€§æ£€æŸ¥ï¼‰
                    if (data.data.riskManagement) {
                        const risk = data.data.riskManagement;
                        if (typeof risk.riskScore === 'number') document.getElementById('riskScore').textContent = risk.riskScore.toFixed(1);
                        if (typeof risk.positionSize === 'number') document.getElementById('positionSize').textContent = 
                            (risk.positionSize * 100).toFixed(1) + '%';
                        if (typeof risk.stopLoss === 'number') document.getElementById('stopLoss').textContent = '$' + risk.stopLoss.toFixed(2);
                        if (typeof risk.takeProfit === 'number') document.getElementById('takeProfit').textContent = '$' + risk.takeProfit.toFixed(2);
                    }
                } else {
                    document.getElementById('currentSignal').innerHTML = 
                        '<div class="loading">æš‚æ— ä¿¡å·æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¿¡å·å¤±è´¥:', error);
                document.getElementById('currentSignal').innerHTML = 
                    '<div class="error">ä¿¡å·åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // åŠ è½½æ€§èƒ½æ•°æ®
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/strategy/performance');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const perf = data.data;
                    document.getElementById('totalReturn').textContent = 
                        (perf.totalPnlPercent * 100).toFixed(2) + '%';
                    document.getElementById('winRate').textContent = 
                        (perf.winRate * 100).toFixed(1) + '%';
                    document.getElementById('sharpeRatio').textContent = 
                        perf.sharpeRatio.toFixed(2);
                    document.getElementById('maxDrawdown').textContent = 
                        (perf.maxDrawdown * 100).toFixed(2) + '%';
                }
            } catch (error) {
                console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¸‚åœºæ•°æ®ï¼ˆå¢åŠ é‡è¯•ä¸è¶…æ—¶å¤„ç† + å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            // const changeEl = document.querySelector('#market-change'); // å·²ç§»é™¤
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const statusEl = document.getElementById('marketInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            try {
                // é™ä½é¦–å±ç­‰å¾…ï¼šå°†è¶…æ—¶ä»5sé™åˆ°2.5sï¼Œé‡è¯•ä»2æ¬¡é™åˆ°1æ¬¡ï¼Œå¹¶å‡å°é€€é¿
                const data = await requestJsonWithRetry('/api/market/ticker', {}, { retries: 1, timeoutMs: 2500, backoffMs: 500 });
                if (data.success && data.data) {
                    const market = data.data;
                    if (typeof market.price === 'number') priceEl.textContent = '$' + market.price.toFixed(2);
                    // ç»Ÿä¸€ä»…å±•ç¤º ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)
                    let sodPct = null;
                    if (typeof market.changeFromSodUtc8 === 'number') {
                        sodPct = market.changeFromSodUtc8; // é¦–é€‰ï¼šAPIå­—æ®µ
                    } else if (typeof market.sodUtc8 === 'number' && typeof market.last === 'number' && market.sodUtc8 > 0) {
                        sodPct = ((market.last - market.sodUtc8) / market.sodUtc8) * 100; // å›é€€ï¼šåŸºäºsodUtc8
                    }
                    if (changeElLegacy) {
                        if (sodPct === null || !isFinite(sodPct)) {
                            changeElLegacy.textContent = 'â€”';
                            changeElLegacy.style.color = '#6b7280';
                            changeElLegacy.title = 'ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)æš‚æ— æ•°æ®';
                        } else {
                            changeElLegacy.textContent = sodPct.toFixed(2) + '%';
                            changeElLegacy.style.color = sodPct >= 0 ? '#10b981' : '#ef4444';
                            changeElLegacy.title = 'ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)ï¼šä¼˜å…ˆä½¿ç”¨APIå­—æ®µchangeFromSodUtc8ï¼›å›é€€(last-sodUtc8)/sodUtc8ã€‚';
                        }
                    }
                    const turnoverUSDT = (typeof market.volume === 'number' && typeof market.price === 'number') ? (market.volume * market.price * 0.1) : NaN;
                    volumeEl.textContent = formatUSDT(turnoverUSDT);
                    const volText = (typeof market.volatility === 'number') ? (market.volatility * 100).toFixed(2) + '%' : 'â€”';
                    volEl.textContent = volText;
            
                    lastMarketOk = true;
                    lastMarketUpdate = Date.now();
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = 'åœ¨çº¿ Â· å·²æ›´æ–° ' + fmtTime(lastMarketUpdate);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                // ä¸æ¸…ç©ºå·²æœ‰æ•°å€¼ï¼Œæ”¹ä¸ºæç¤ºç¦»çº¿å¹¶æä¾›é‡è¯•
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.innerHTML = 'ç¦»çº¿ Â· è·å–å¤±è´¥ï¼Œ<a href="#" onclick="refreshMarketData(); return false;">ç‚¹å‡»é‡è¯•</a>' + (lastMarketUpdate ? (' Â· ä¸Šæ¬¡æ›´æ–° ' + fmtTime(lastMarketUpdate)) : '');
                }
            }
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            // ç®€å•çš„è¿è¡Œæ—¶é—´è®¡ç®—
            const startTime = localStorage.getItem('systemStartTime');
            if (!startTime) {
                localStorage.setItem('systemStartTime', Date.now());
                return;
            }
            
            const uptime = Date.now() - parseInt(startTime);
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`;
        }
        
        // åˆ·æ–°ä¿¡å·
        function refreshSignal() {
            loadLatestSignal();
        }
        
        // åˆ·æ–°å¸‚åœºæ•°æ®
        function refreshMarketData() {
            loadMarketData();
        }
        
        // æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
        function viewPerformance() {
            window.open('/api/strategy/performance', '_blank');
        }
        
        // æŸ¥çœ‹é£é™©ç®¡ç†
        function viewRiskManagement() {
            window.open('/api/risk/status', '_blank');
        }
        
        // æŸ¥çœ‹å›æµ‹å†å²
        function viewBacktestHistory() {
            alert('å›æµ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...');
        }
        
        // å¯åŠ¨ç­–ç•¥
        async function startStrategy() {
            try {
                const response = await fetch('/api/strategy/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å¯åŠ¨æˆåŠŸï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // åœæ­¢ç­–ç•¥
        async function stopStrategy() {
            try {
                const response = await fetch('/api/strategy/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å·²åœæ­¢ï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥åœæ­¢å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // é‡å¯ç­–ç•¥
        async function restartStrategy() {
            if (confirm('ç¡®å®šè¦é‡å¯ç­–ç•¥å—ï¼Ÿ')) {
                await stopStrategy();
                setTimeout(() => {
                    startStrategy();
                }, 2000);
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html>