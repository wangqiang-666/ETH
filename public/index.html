<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ</title>
    <link rel="icon" type="image/svg+xml" href="/eth-logo.svg" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1680px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
            max-width: 1680px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
            vertical-align: -4px;
            background: url('/eth-logo.svg') no-repeat center/contain;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        /* åŠ è½½å ä½ï¼šå­—ä½“å°ä¸”æ·¡é»„è‰² */
        .metric-value.loading-inline {
            font-size: 1.2em;
            color: #f6e58d;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* é¡¶éƒ¨å³ä¾§è¯Šæ–­é¢æ¿æŒ‰é’® */
        .inspect-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        /* ç‹¬ç«‹æ°”æ³¡é€æ˜æŒ‰é’®ï¼ˆä¸ä¾èµ– .btnï¼‰ */
        .bubble-btn{position:relative;display:inline-flex;align-items:center;justify-content:center;height:40px;padding:0 16px;border-radius:12px;border:1px solid rgba(255,255,255,.35);background:rgba(255,255,255,.06);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);color:#ffffff;text-shadow:0 1px 2px rgba(0,0,0,.35);font-weight:600;letter-spacing:.2px;cursor:pointer;outline:none;transition:transform .2s ease, box-shadow .3s ease, background .3s ease, border-color .3s ease;box-shadow:inset 0 1px 0 rgba(255,255,255,.2), 0 4px 16px rgba(46,126,255,.18);}
        .bubble-btn .label{position:relative;z-index:2}
        .bubble-btn .ring{position:absolute;inset:-2px;border-radius:inherit;padding:1px;background:conic-gradient(from 0deg,#79c0ff,#a78bfa,#60a5fa,#79c0ff);mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;opacity:.9;transition:opacity .3s ease, filter .3s ease;filter:blur(.5px);}
        .bubble-btn::before{content:"";position:absolute;inset:0;border-radius:inherit;background:radial-gradient(120% 60% at 30% 10%, rgba(255,255,255,.45), rgba(255,255,255,.1) 60%, transparent 70%), radial-gradient(120% 80% at 70% 120%, rgba(59,130,246,.25), transparent 60%);z-index:1;}
        .bubble-btn::after{content:"";position:absolute;left:10px;top:6px;width:10px;height:10px;border-radius:50%;background:rgba(255,255,255,.85);filter:blur(1px);opacity:.9;z-index:2;}
        .bubble-btn:hover{transform:translateY(-2px);box-shadow:inset 0 1px 0 rgba(255,255,255,.25), 0 8px 24px rgba(46,126,255,.25);background:rgba(255,255,255,.08);}
        .bubble-btn:active{transform:translateY(0);box-shadow:inset 0 2px 6px rgba(0,0,0,.25), 0 4px 12px rgba(46,126,255,.25);}
        .bubble-btn:focus-visible{outline:2px solid rgba(125,211,252,.6);outline-offset:2px}
        .bubble-btn.disabled, .bubble-btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;}
        .bubble-btn .ring{animation:spin 3.8s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg)}}

        /* ç°æš—ç¦ç”¨æ€ */
        .btn:disabled, .btn.disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%) !important;
            box-shadow: none !important;
            transform: none !important;
            cursor: not-allowed;
            color: #ffffff !important;
            opacity: 1 !important;
        }
        .btn-success:disabled, .btn-danger:disabled {
            background: linear-gradient(135deg, #bdc3c7 0%, #95a5a6 100%) !important;
        }
        
        .signal-display {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
            transition: width 0.3s;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .footer p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* æ–°å¢ï¼šæ¨èå¡ç‰‡æ ·å¼ */
        .trading-recommendation {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #eef2f7;
        }
        .trading-recommendation .row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 14px;
            color: #555;
        }
        .trading-recommendation .key { color: #7f8c8d; }
        .trading-recommendation .val { color: #2c3e50; font-weight: 600; }
        .trading-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* æ¨èå†å²æ ·å¼ */
        .recommendation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .recommendation-controls select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            color: #ffffff;
        }
        
        .recommendation-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .recommendation-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* æ¨èè¡¨æ ¼æ ·å¼ */
        .recommendation-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .recommendation-table th,
        .recommendation-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .recommendation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .recommendation-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .recommendation-row.pending {
            background-color: #fff3cd;
        }
        
        .recommendation-row.active {
            background-color: #d1ecf1;
        }
        
        .recommendation-row.closed {
            background-color: #d4edda;
        }
        
        .recommendation-row.expired {
            background-color: #f8d7da;
        }
        
        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-badge.long {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-badge.short {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-badge.hold {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge.active {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-badge.closed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .pnl-value.positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .pnl-value.negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .recommendation-item.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .recommendation-item.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .recommendation-item.stopped {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .recommendation-action {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .recommendation-action.LONG {
            background: #dcfce7;
            color: #166534;
        }
        
        .recommendation-action.SHORT {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .recommendation-action.HOLD {
            background: #f3f4f6;
            color: #374151;
        }
        
        .recommendation-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .recommendation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 13px;
        }
        
        .recommendation-detail {
            display: flex;
            justify-content: space-between;
        }
        
        .recommendation-detail .label {
            color: #6b7280;
        }
        
        .recommendation-detail .value {
            font-weight: 500;
        }
        
        .recommendation-pnl {
            font-weight: 600;
        }
        
        .recommendation-pnl.positive {
            color: #10b981;
        }
        
        .recommendation-pnl.negative {
            color: #ef4444;
        }
        
        .recommendation-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* æ–°å¢ï¼šè¡Œæƒ…å¡ç‰‡å†…è”çŠ¶æ€æç¤º */
        .inline-status { display: inline-block; font-size: 12px; color: #7f8c8d; margin-top: 8px; }
        .inline-status.ok { color: #27ae60; }
        .inline-status.warn { color: #f39c12; }
        .inline-status.err { color: #e74c3c; }
        .card h2 .inline-status { margin-left: auto; margin-top: 0; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                gap: 15px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
        /* åˆ†é¡µæ ·å¼ */
        .pagination{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin:8px 0 16px}
        .pagination .page-btn,.pagination .page-number{padding:6px 10px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:13px}
        .pagination .page-number.active{background:#3498db;color:#fff;border-color:#3498db}
        .pagination .page-btn[disabled]{opacity:.5;cursor:not-allowed}
        .pagination .page-info{margin-left:8px;color:#6b7280;font-size:12px}
        /* FGI åŠåœ†ä»ªè¡¨ç›˜æ ·å¼ */
        .section-sep{height:1px;background:linear-gradient(90deg,rgba(255,255,255,0),rgba(148,163,184,.35) 15%,rgba(148,163,184,.35) 85%,rgba(255,255,255,0));margin:10px 0 12px}
        .fgi-header{font-size:14px;color:#6b7280;letter-spacing:.4px;margin:-2px 0 2px}
        .fgi-gauge{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px 0 2px}
        .fgi-gauge svg{width:100%;max-width:420px;height:200px;overflow:visible}
        .fgi-track{fill:none;stroke:#e5e7eb;stroke-width:14;opacity:.45}
        .fgi-arc{fill:none;stroke-width:14;stroke-linecap:butt;opacity:1;transition:opacity .3s ease;stroke-dasharray:18 82}
        /* äº”ç­‰åˆ†+ç©ºç™½åˆ†éš”ï¼šæ¯æ®µ18% + 2%é—´éš”ï¼Œèµ·ç‚¹åˆ†åˆ«ä¸º 0/20/40/60/80 */
        #arc-red{stroke-dashoffset:0}
         #arc-orange{stroke-dashoffset:-20.5}
         #arc-yellow{stroke-dashoffset:-41}
         #arc-green{stroke-dashoffset:-61.5}
         #arc-darkgreen{stroke-dashoffset:-82}
        .fgi-dot{filter:drop-shadow(0 2px 4px rgba(0,0,0,.35));transition:cx .5s cubic-bezier(.22,1,.36,1), cy .5s cubic-bezier(.22,1,.36,1);fill:#fff;stroke:#0f172a;stroke-width:3}
        .fgi-value{font-size:40px;font-weight:800;color:#111827;margin-top:-10px;text-shadow:0 1px 1px rgba(0,0,0,.07)}
        .fgi-label{font-size:13px;color:#6b7280;margin-top:4px}
        .fgi-legend{font-size:12px;color:#9ca3af;margin-top:2px}
    </style>
</head>
<body>
    <div class="inspect-fab">
        <button class="bubble-btn" onclick="openInspect()"><span class="label">æ•°æ®ä¸æŒ‡æ ‡è¯Šæ–­é¢æ¿</span><span class="ring"></span></button>
    </div>
    <div class="container">
        <div class="header">
            <h1 style="display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="/eth-logo.svg" alt="ETH" width="36" height="36" style="transform: translateY(4px);"/>
                 ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ
             </h1>
            <p>åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“ç­–ç•¥åˆ†æå¹³å°</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç³»ç»Ÿè¿è¡Œä¸­</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ç­–ç•¥å¼•æ“</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>MLåˆ†æ</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>é£é™©ç®¡ç†</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- å¸‚åœºæ•°æ® -->
            <div class="card">
                <h2><span class="card-icon">ğŸ’¹</span>å¸‚åœºæ•°æ® <span id="marketInlineStatus" class="inline-status warn">æ­£åœ¨åˆå§‹åŒ–...</span></h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentPrice">--</div>
                        <div class="metric-label">å½“å‰ä»·æ ¼</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="priceChange">--</div>
                        <div class="metric-label">ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volume">--</div>
                        <div class="metric-label">24hæˆäº¤é¢(USDT)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volatility">--</div>
                        <div class="metric-label">æŒ¯å¹…</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="lowHigh24h">--</div>
                        <div class="metric-label">24hæœ€ä½/æœ€é«˜</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="fundingRate">--</div>
                        <div class="metric-label">èµ„é‡‘è´¹ç‡(8h)</div>
                    </div>
                </div>
                <div class="section-sep"></div>
                <div class="fgi-header">ææƒ§è´ªå©ªæŒ‡æ•°</div>
                <div class="fgi-gauge" id="fgiGauge">
                    <svg viewBox="0 0 200 100" preserveAspectRatio="xMidYMid meet">
                        <path class="fgi-track" d="M10,100 A90,90 0 0 1 190,100"/>
                        <path class="fgi-arc" id="arc-red" d="M10,100 A90,90 0 0 1 190,100" stroke="#b91c1c" pathLength="100"/>
                         <path class="fgi-arc" id="arc-orange" d="M10,100 A90,90 0 0 1 190,100" stroke="#ef4444" pathLength="100"/>
                         <path class="fgi-arc" id="arc-yellow" d="M10,100 A90,90 0 0 1 190,100" stroke="#facc15" pathLength="100"/>
                         <path class="fgi-arc" id="arc-green" d="M10,100 A90,90 0 0 1 190,100" stroke="#10b981" pathLength="100"/>
                         <path class="fgi-arc" id="arc-darkgreen" d="M10,100 A90,90 0 0 1 190,100" stroke="#065f46" pathLength="100" style="stroke-dasharray:18.05 81.95"/>
                        <circle id="fgiDot" class="fgi-dot" cx="100" cy="100" r="8" />
                    </svg>
                    <div class="fgi-value" id="fgiValue">--</div>
                    <div class="fgi-label" id="fgiLabel">ä¸­æ€§</div>
                </div>
            </div>
            <!-- å¼€å•æ¨è -->
            <div class="card">
                <h2><span class="card-icon">ğŸ¯</span>å¼€å•æ¨è</h2>
                <div class="trading-recommendation" id="tradingRecommendation">
                    <div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="recommendedAction">--</div>
                        <div class="metric-label">æ¨èæ“ä½œ</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="entryPrice">--</div>
                        <div class="metric-label">å…¥åœºä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="recommendedLeverage">--</div>
                        <div class="metric-label">æ¨èæ æ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSizeRecommend">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <div class="trading-buttons">
                    <button id="btnLong" class="btn btn-success" onclick="openLongPosition()">ğŸ“ˆ åšå¤š (LONG)</button>
                    <button id="btnShort" class="btn btn-danger" onclick="openShortPosition()">ğŸ“‰ åšç©º (SHORT)</button>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    å»ºè®®ä»…ä¾›å‚è€ƒï¼Œè¯·æ³¨æ„é£é™©æ§åˆ¶
                </div>
            </div>

            <!-- æ¨èå†å² -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“‹</span>æ¨èå†å² <span id="recommendationInlineStatus" class="inline-status warn">æ­£åœ¨åŠ è½½...</span></h2>
                
                <!-- ç­›é€‰å’Œæ’åºæ§ä»¶ -->
                <div class="recommendation-controls">
                    <select id="statusFilter" onchange="filterRecommendations()">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="ACTIVE">è¿›è¡Œä¸­</option>
                        <option value="CLOSED">å·²å¹³ä»“</option>
                    </select>
                    
                    <select id="sortBy" onchange="sortRecommendations()">
                        <option value="created_at">æŒ‰æ—¶é—´æ’åº</option>
                        <option value="pnl_percent">æŒ‰æ”¶ç›Šæ’åº</option>
                        <option value="confidence_score">æŒ‰ç½®ä¿¡åº¦æ’åº</option>
                    </select>
                    
                    <select id="sortOrder" onchange="sortRecommendations()">
                        <option value="desc">é™åº</option>
                        <option value="asc">å‡åº</option>
                    </select>
                    
                    <button class="btn btn-sm" onclick="refreshRecommendations()">åˆ·æ–°</button>
                    <button id="deleteSelectedBtn" class="btn btn-sm btn-danger" onclick="deleteSelectedRecommendations()" disabled>åˆ é™¤æ‰€é€‰(0)</button>
                </div>
                
                <div class="recommendation-table-container">
                    <table class="recommendation-table" id="recommendationTable">
                        <thead>
                            <tr>
                                <th style="width:36px;text-align:center"><input type="checkbox" id="selectAllRecs" onclick="toggleSelectAll(this)"/></th>
                                <th>æ—¶é—´</th>
                                <th>æ“ä½œ</th>
                                <th>å…¥åœºä»·</th>
                                <th>æ æ†</th>
                                <th>æ­¢ç›ˆ</th>
                                <th>æ­¢æŸ</th>
                                <th>ç½®ä¿¡åº¦</th>
                                <th>çŠ¶æ€</th>
                                <th>æ”¶ç›Š</th>
                            </tr>
                        </thead>
                        <tbody id="recommendationTableBody">
                            <tr>
                                <td colspan="10" class="loading">æ­£åœ¨åŠ è½½æ¨èè®°å½•...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="recommendationPagination" class="pagination"></div>
                <div class="recommendation-stats" id="recommendationStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRecommendations">--</span>
                        <span class="stat-label">æ€»æ¨èæ•°</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRecommendations">--</span>
                        <span class="stat-label">æ´»è·ƒä¸­</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="winRateRecommendations">--</span>
                        <span class="stat-label">èƒœç‡</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgPnlRecommendations">--</span>
                        <span class="stat-label">å¹³å‡æ”¶ç›Š</span>
                    </div>
                </div>
            </div>
            
            <!-- ç­–ç•¥æ€§èƒ½ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“ˆ</span>ç­–ç•¥æ€§èƒ½</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="totalReturn">--</div>
                        <div class="metric-label">æ€»æ”¶ç›Šç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">--</div>
                        <div class="metric-label">èƒœç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">--</div>
                        <div class="metric-label">å¤æ™®æ¯”ç‡</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">--</div>
                        <div class="metric-label">æœ€å¤§å›æ’¤</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="viewPerformance()">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</button>
            </div>
            
            <!-- é£é™©ç®¡ç† --><!-- åˆ é™¤ -->
            
            <!-- å®æ—¶ç­–ç•¥åˆ†æ --><!-- åˆ é™¤ -->
            
            <!-- å›æµ‹åˆ†æ --><!-- åˆ é™¤ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ›¡ï¸</span>é£é™©ç®¡ç†</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">--</div>
                        <div class="metric-label">é£é™©è¯„åˆ†</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSize">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="stopLoss">--</div>
                        <div class="metric-label">æ­¢æŸä»·ä½</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="takeProfit">--</div>
                        <div class="metric-label">æ­¢ç›ˆä»·ä½</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="viewRiskManagement()">âš™ï¸ é£é™©è®¾ç½®</button>
            </div>
            
            <!-- å®æ—¶ç­–ç•¥åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ“Š</span>å®æ—¶ç­–ç•¥åˆ†æ</h2>
                <div id="currentSignal" class="signal-display">
                    <div class="loading">æ­£åœ¨è·å–æœ€æ–°ä¿¡å·...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="signalStrength">--</div>
                        <div class="metric-label">ä¿¡å·å¼ºåº¦</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="confidence">--</div>
                        <div class="metric-label">ç½®ä¿¡åº¦</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshSignal()">ğŸ”„ åˆ·æ–°ä¿¡å·</button>
            </div>

            <!-- å›æµ‹åˆ†æ -->
            <div class="card">
                <h2><span class="card-icon">ğŸ”¬</span>å›æµ‹åˆ†æ</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value">å†å²éªŒè¯</div>
                        <div class="metric-label">ç­–ç•¥æœ‰æ•ˆæ€§</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">å¤šç»´åˆ†æ</div>
                        <div class="metric-label">æ€§èƒ½è¯„ä¼°</div>
                    </div>
                </div>
                <a href="/backtest" class="btn"><img src="/eth-logo.svg" alt="ETH" width="16" height="16" style="vertical-align:-3px;margin-right:6px"/> å¼€å§‹å›æµ‹</a>
                <button class="btn btn-success" onclick="viewBacktestHistory()">ğŸ“‹ å†å²è®°å½•</button>
            </div>
        </div>
        
        <div class="footer">
            <p>ETHåˆçº¦ç­–ç•¥åˆ†æç³»ç»Ÿ - åŸºäºæœºå™¨å­¦ä¹ çš„æ™ºèƒ½é‡åŒ–äº¤æ˜“å¹³å°</p>
            <div class="footer-links">
                <a href="/api/strategy/status">APIçŠ¶æ€</a>
                <a href="/api/risk/status">é£é™©ç®¡ç†</a>
                <a href="/backtest">å›æµ‹åˆ†æ</a>
                <a href="/api/config">ç³»ç»Ÿé…ç½®</a>
            </div>
        </div>
    </div>
    
    <script>
        // é¡µé¢åˆå§‹åŒ–åçš„UIè°ƒæ•´ï¼šåˆ é™¤ä¸‰ä¸ªæ¿å—å¹¶é‡æ’é¡ºåº
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const grid = document.querySelector('.main-grid');
                if (!grid) return;
                const getCardByTitle = (title) => {
                    const cards = Array.from(grid.querySelectorAll('.card'));
                    return cards.find(c => {
                        const h = c.querySelector('h2');
                        return h && h.textContent && h.textContent.includes(title);
                    });
                };
                // åˆ é™¤ä¸éœ€è¦çš„ä¸‰ä¸ªæ¿å—
                ['é£é™©ç®¡ç†','å®æ—¶ç­–ç•¥åˆ†æ','å›æµ‹åˆ†æ'].forEach(t => {
                    const el = getCardByTitle(t);
                    if (el && el.parentElement === grid) el.remove();
                });
                // ç¡®ä¿â€œç­–ç•¥æ€§èƒ½â€åœ¨å‰ï¼Œâ€œæ¨èå†å²â€åœ¨å…¶å
                const perf = getCardByTitle('ç­–ç•¥æ€§èƒ½');
                const rec = getCardByTitle('æ¨èå†å²');
                if (grid && perf && rec && rec.previousElementSibling !== perf) {
                    grid.insertBefore(rec, perf.nextSibling);
                }
            } catch (e) {
                console.warn('UI auto adjust failed:', e);
            }
        });
        let updateInterval;
        let lastMarketOk = false;
        let lastMarketUpdate = 0;

        // å†™æ“ä½œåï¼šæ‹¦æˆª fetchï¼Œé’ˆå¯¹å…³é”®å†™æ¥å£ï¼ˆ/api/recommendationsã€/api/strategy/start|stop ç­‰ï¼‰
        // åœ¨è¯·æ±‚æˆåŠŸåè§¦å‘ä¸€æ¬¡â€œç«‹å³åˆ·æ–°â€ï¼ˆå¸¦å»æŠ–ï¼Œé¿å…æ‰¹é‡åˆ é™¤è§¦å‘å¤šæ¬¡ï¼‰
        (function(){
            const _origFetch = window.fetch.bind(window);
            let _refreshTimer = null;
            function scheduleImmediateRefresh(){
                if (_refreshTimer) clearTimeout(_refreshTimer);
                _refreshTimer = setTimeout(async () => {
                    try {
                        await loadRecommendationHistory();
                        await updateRecommendationStats();
                    } catch (e) {
                        console.warn('å³æ—¶åˆ·æ–°å¤±è´¥ï¼š', e);
                    }
                }, 150); // 150ms å»æŠ–
            }
            function shouldTriggerImmediateRefresh(url, method){
                // ç»Ÿä¸€ä¸ºå¤§å†™æ–¹æ³•
                const m = String(method || 'GET').toUpperCase();
                // æ¨èç›¸å…³ï¼šæ–°å¢/ä¿®æ”¹/åˆ é™¤/å…³é—­
                if ((m === 'POST' || m === 'PUT' || m === 'DELETE') && /\/api\/recommendations(\b|\/)/.test(url)) return true;
                // ç­–ç•¥å¯åœï¼šå¯èƒ½å½±å“åç»­æ¨èç”Ÿæˆï¼Œåˆ·æ–°åˆ—è¡¨/ç»Ÿè®¡æ›´ç›´è§‚
                if (m === 'POST' && /\/api\/strategy\/(start|stop)(\b|\/)/.test(url)) return true;
                return false;
            }
            window.fetch = async function(input, init){
                const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
                const method = (init && init.method) || (typeof input === 'object' && input && input.method) || 'GET';
                const res = await _origFetch(input, init);
                try {
                    if (res && res.ok && shouldTriggerImmediateRefresh(url, method)) scheduleImmediateRefresh();
                } catch (_) { /* ignore */ }
                return res;
            };
        })();

        // å·¥å…·å‡½æ•°ï¼šæ‰“å¼€è¯Šæ–­é¡µ
        function openInspect() {
            window.open('/inspect.html','_blank');
        }

        // æ•°å­—æ ¼å¼åŒ–ï¼ˆUSDTï¼‰
        function formatUSDT(val) {
            if (typeof val !== 'number' || !isFinite(val)) return 'â€”';
            const abs = Math.abs(val);
            if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'B USDT';
            if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'M USDT';
            if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'K USDT';
            return val.toFixed(2) + ' USDT';
        }

        // æ—¶é—´æ ¼å¼åŒ– HH:MM:SS
        function fmtTime(ts) {
            const d = new Date(ts);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        
        // è¯·æ±‚å·¥å…·ï¼šæ”¯æŒè¶…æ—¶ä¸æŒ‡æ•°é€€é¿é‡è¯•
        async function requestJsonWithRetry(url, options = {}, cfg = { retries: 2, timeoutMs: 5000, backoffMs: 600 }) {
            let attempt = 0;
            let lastErr;
            while (attempt <= (cfg.retries ?? 0)) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), cfg.timeoutMs ?? 5000);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    lastErr = e;
                    // æ›´æ–°å†…è”çŠ¶æ€ä¸ºé‡è¯•ä¸­
                    const st = document.getElementById('marketInlineStatus');
                    if (st) {
                        st.className = 'inline-status warn';
                        st.textContent = 'è¿æ¥ä¸ç¨³å®šï¼Œæ­£åœ¨é‡è¯•...';
                    }
                    if (attempt === (cfg.retries ?? 0)) break;
                    const delay = (cfg.backoffMs ?? 600) * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
                attempt++;
            }
            throw lastErr;
        }
        
        // FGI æ¸²æŸ“ï¼šæ ¹æ®æ•°å€¼åœ¨åŠåœ†ä¸Šå®šä½æŒ‡ç¤ºç‚¹ï¼Œå¹¶æ›´æ–°æ–‡æ¡ˆï¼ˆå«åŠ¨ç”»ä¸åˆ†æ®µé«˜äº®ï¼‰
        function renderFGI(value, label) {
            try {
                const pointer = document.getElementById('fgiDot');
                const valEl = document.getElementById('fgiValue');
                const labEl = document.getElementById('fgiLabel');
                if (!pointer || !valEl || !labEl) return;
                if (typeof value !== 'number' || !isFinite(value)) {
                    valEl.textContent = '--';
                    labEl.textContent = 'ææƒ§è´ªå©ªæŒ‡æ•°';
                    return;
                }
                const v = Math.max(0, Math.min(100, value));
                valEl.textContent = String(Math.round(v));
                // é˜ˆå€¼åˆ†ç±»ï¼š0-20 æåº¦ææƒ§ï¼Œ20-40 ææƒ§ï¼Œ40-60 ä¸­æ€§ï¼Œ60-80 è´ªå©ªï¼Œ80-100 æåº¦è´ªå©ªï¼ˆå·¦é—­å³å¼€ï¼Œæœ€åä¸€æ¡£å« 100ï¼‰
                const classify = (n) => (n < 20 ? 'æåº¦ææƒ§' : n < 40 ? 'ææƒ§' : n < 60 ? 'ä¸­æ€§' : n < 80 ? 'è´ªå©ª' : 'æåº¦è´ªå©ª');
                // ç»Ÿä¸€ä»¥æ•°å€¼é˜ˆå€¼æ˜ å°„ä¸ºå‡†ï¼Œé¿å…æ¥å£æ ‡ç­¾è¦†ç›–é€ æˆé”™åˆ¤ï¼ˆä¾‹å¦‚ 44 åº”æ˜¾ç¤ºâ€œä¸­æ€§â€ï¼‰
                labEl.textContent = classify(v);
                // åŠåœ†æ˜ å°„ï¼š0 -> Ï€, 100 -> 0
                const angle = Math.PI * (1 - v / 100);
                const r = 90;
                const cx = 100 + r * Math.cos(angle);
                const cy = 100 - r * Math.sin(angle);
                pointer.setAttribute('cx', cx.toFixed(2));
                pointer.setAttribute('cy', cy.toFixed(2));

                // ä¿æŒæ‰€æœ‰é¢œè‰²æ®µå›ºå®šæ˜¾ç¤ºï¼Œå–æ¶ˆåŠ¨æ€é«˜äº®ï¼Œä»…ç§»åŠ¨æŒ‡ç¤ºç‚¹
                // æŒ‡ç¤ºç‚¹æ ·å¼å·²é€šè¿‡ CSS å®šä¹‰ï¼Œè¿™é‡Œä¸ä¿®æ”¹é¢œè‰²
            } catch (e) {
                console.warn('æ¸²æŸ“FGIå¤±è´¥:', e);
            }
        }
        
        // åŠ è½½ FGI æ•°æ®ï¼ˆä½¿ç”¨æœ¬åœ°è¶…æ—¶æ§åˆ¶ï¼Œé¿å…å¤ç”¨å¸‚åœºæ•°æ®çš„å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadFGI() {
            const ctrl = new AbortController();
            const timer = setTimeout(() => ctrl.abort(), 8000);
            try {
                const res = await fetch('/api/sentiment/fgi', { signal: ctrl.signal, cache: 'no-store' });
                clearTimeout(timer);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                const payload = await res.json();
                const d = payload?.data ?? payload;
                const val = typeof d?.value === 'number' ? d.value : Number(d?.value);
                const label = d?.value_classification || d?.classification || null;
                renderFGI(val, label);
            } catch (err) {
                clearTimeout(timer);
                console.warn('åŠ è½½FGIå¤±è´¥:', err);
                renderFGI(NaN, null);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // ä¼˜å…ˆåŠ è½½â€œå¸‚åœºæ•°æ®â€ï¼Œæå‡é¦–å±æ„ŸçŸ¥é€Ÿåº¦
            loadMarketData();
            loadSystemStatus();
            loadLatestSignal();
            loadPerformanceData();
            loadTradeRecommendation();
            loadRecommendationHistory();
            loadFGI();
            
            // å¯åŠ¨è‡ªåŠ¨æ›´æ–°
            updateInterval = setInterval(() => {
                loadLatestSignal();
                loadMarketData();
                updateUptime();
                loadTradeRecommendation();
                loadRecommendationHistory();
                loadFGI();
            }, 30000); // 30ç§’æ›´æ–°ä¸€æ¬¡
        };
        
        // åŠ è½½ç³»ç»ŸçŠ¶æ€ï¼ˆå®¹é”™ï¼šå…ƒç´ ä¸å­˜åœ¨æ—¶è·³è¿‡ï¼‰
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/strategy/status');
                const data = await response.json();
                
                if (data.success) {
                    const el = document.getElementById('systemStatus');
                    if (el) {
                        el.textContent = data.data.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç³»ç»ŸçŠ¶æ€å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æœ€æ–°ä¿¡å·
        async function loadLatestSignal() {
            try {
                const response = await fetch('/api/strategy/analysis');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const s = data.data.signal || {};
                    const type = s.type || s.signal || (data.recommendation && data.recommendation.action) || 'â€”';
                    
                    // å…¼å®¹å¤šç§å¼ºåº¦ç»“æ„ï¼šæ•°å€¼(0-1)æˆ–å¯¹è±¡{ combined:0-100 }
                    let strengthVal = 0;
                    if (typeof s.strength === 'number') {
                        strengthVal = s.strength;
                    } else if (s.strength && typeof s.strength.combined === 'number') {
                        strengthVal = s.strength.combined;
                    }
                    if (strengthVal > 1) strengthVal = strengthVal / 100; // å½’ä¸€åŒ–åˆ°[0,1]
                    
                    // å…¼å®¹å¤šæ¥æºçš„ç½®ä¿¡åº¦
                    let confidence = null;
                    if (typeof s.confidence === 'number') {
                        confidence = s.confidence;
                    } else if (s.strength && typeof s.strength.confidence === 'number') {
                        confidence = s.strength.confidence;
                    } else if (data.recommendation && typeof data.recommendation.confidence === 'number') {
                        confidence = data.recommendation.confidence;
                    }
                    
                    // ä»·æ ¼ï¼šä¼˜å…ˆä½¿ç”¨ signal.price -> targetPrice -> market.price -> æ”¯æ’‘ä½
                    let price = null;
                    if (typeof s.price === 'number') {
                        price = s.price;
                    } else if (typeof s.targetPrice === 'number') {
                        price = s.targetPrice;
                    } else if (data.data.market && typeof data.data.market.price === 'number') {
                        price = data.data.market.price;
                    } else if (data.data.marketAnalysis && typeof data.data.marketAnalysis.support === 'number') {
                        price = data.data.marketAnalysis.support;
                    }
                    
                    const signalDiv = document.getElementById('currentSignal');
                    if (!signalDiv) return; // DOMå°šæœªæ¸²æŸ“ï¼Œç›´æ¥è·³è¿‡
                    const strengthPct = isFinite(strengthVal) ? (strengthVal * 100) : 0;
                    const priceText = typeof price === 'number' ? price.toFixed(2) : '--';
                    const confText = typeof confidence === 'number' ? (confidence * 100).toFixed(1) + '%' : '--';
                    
                    signalDiv.innerHTML = `
                        <div class="signal-strength">
                            <strong>${type}</strong>
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: ${Math.max(0, Math.min(100, strengthPct))}%"></div>
                            </div>
                            <span>${isFinite(strengthPct) ? strengthPct.toFixed(1) : '--'}%</span>
                        </div>
                        <p>ä»·æ ¼: $${priceText} | ç½®ä¿¡åº¦: ${confText}</p>
                    `;
                    
                    document.getElementById('signalStrength').textContent =
                        isFinite(strengthPct) ? strengthPct.toFixed(1) + '%' : '--';
                    document.getElementById('confidence').textContent = confText;
                        
                    // æ›´æ–°é£é™©ç®¡ç†æ•°æ®ï¼ˆå¸¦å¥å£®æ€§æ£€æŸ¥ï¼‰
                    if (data.data.riskManagement) {
                        const risk = data.data.riskManagement;
                        if (typeof risk.riskScore === 'number') document.getElementById('riskScore').textContent = risk.riskScore.toFixed(1);
                        document.getElementById('positionSize').textContent = confText;
                        if (typeof risk.stopLoss === 'number') document.getElementById('stopLoss').textContent = '$' + risk.stopLoss.toFixed(2);
                        if (typeof risk.takeProfit === 'number') document.getElementById('takeProfit').textContent = '$' + risk.takeProfit.toFixed(2);
                    }
                } else {
                    const el = document.getElementById('currentSignal');
                    if (el) el.innerHTML = 
                        '<div class="loading">æš‚æ— ä¿¡å·æ•°æ®</div>';
                }
            } catch (error) {
                console.error('åŠ è½½ä¿¡å·å¤±è´¥:', error);
                const el = document.getElementById('currentSignal');
                if (el) el.innerHTML = 
                    '<div class="error">ä¿¡å·åŠ è½½å¤±è´¥</div>';
            }
        }
        
        // åŠ è½½æ€§èƒ½æ•°æ®
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/strategy/performance');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const perf = data.data;
                    
                    // å®‰å…¨åœ°æ›´æ–°æ€»æ”¶ç›Šç‡
                    const totalReturnEl = document.getElementById('totalReturn');
                    if (totalReturnEl) {
                        totalReturnEl.textContent = typeof perf.totalPnlPercent === 'number' 
                            ? (perf.totalPnlPercent * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°èƒœç‡
                    const winRateEl = document.getElementById('winRate');
                    if (winRateEl) {
                        winRateEl.textContent = typeof perf.winRate === 'number' 
                            ? (perf.winRate * 100).toFixed(1) + '%' 
                            : '0.0%';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°å¤æ™®æ¯”ç‡
                    const sharpeRatioEl = document.getElementById('sharpeRatio');
                    if (sharpeRatioEl) {
                        sharpeRatioEl.textContent = typeof perf.sharpeRatio === 'number' 
                            ? perf.sharpeRatio.toFixed(2) 
                            : '0.00';
                    }
                    
                    // å®‰å…¨åœ°æ›´æ–°æœ€å¤§å›æ’¤
                    const maxDrawdownEl = document.getElementById('maxDrawdown');
                    if (maxDrawdownEl) {
                        maxDrawdownEl.textContent = typeof perf.maxDrawdown === 'number' 
                            ? (perf.maxDrawdown * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ€§èƒ½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½å¸‚åœºæ•°æ®ï¼ˆå¢åŠ é‡è¯•ä¸è¶…æ—¶å¤„ç† + å†…è”çŠ¶æ€æç¤ºï¼‰
        async function loadMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            // const changeEl = document.querySelector('#market-change'); // å·²ç§»é™¤
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const lowHighEl = document.getElementById('lowHigh24h');
            const fundingEl = document.getElementById('fundingRate');
            const statusEl = document.getElementById('marketInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            try {
                // é™ä½é¦–å±ç­‰å¾…ï¼šå°†è¶…æ—¶ä»5sé™åˆ°2.5sï¼Œé‡è¯•ä»2æ¬¡é™åˆ°1æ¬¡ï¼Œå¹¶å‡å°é€€é¿
                const data = await requestJsonWithRetry('/api/market/ticker?symbol=ETH-USDT-SWAP', {}, { retries: 1, timeoutMs: 2500, backoffMs: 500 });
                if (data.success && data.data) {
                    const market = data.data;
                    if (typeof market.price === 'number') priceEl.textContent = '$' + market.price.toFixed(2);
                    // ç»Ÿä¸€ä»…å±•ç¤º ä»Šæ—¥æ¶¨è·Œå¹…(UTC+8)
                    let sodPct = null;
                    if (typeof market.changeFromSodUtc8 === 'number') {
                        sodPct = market.changeFromSodUtc8; // é¦–é€‰ï¼šAPIå­—æ®µ
                    } else if (typeof market.sodUtc8 === 'number' && typeof market.last === 'number' && market.sodUtc8 > 0) {
                        sodPct = ((market.last - market.sodUtc8) / market.sodUtc8) * 100; // å›é€€ï¼šåŸºäºsodUtc8
                    }
                    if (changeElLegacy) {
                        if (sodPct === null || !isFinite(sodPct)) {
                            changeElLegacy.textContent = 'â€”';
                            changeElLegacy.style.color = '#6b7280';
                        } else {
                            changeElLegacy.textContent = sodPct.toFixed(2) + '%';
                            changeElLegacy.style.color = sodPct >= 0 ? '#10b981' : '#ef4444';
                        }
                    }
                    // 24hæœ€ä½/æœ€é«˜
                    if (lowHighEl) {
                        const h24 = Number(market.high24h);
                        const l24 = Number(market.low24h);
                        if (isFinite(h24) && isFinite(l24)) {
                            lowHighEl.textContent = `$${l24.toFixed(2)} / $${h24.toFixed(2)}`;
                        } else {
                            lowHighEl.textContent = '--';
                        }
                    }
                    const turnoverUSDT = (typeof market.volume === 'number' && typeof market.price === 'number') ? (market.volume * market.price * 0.1) : NaN;
                    volumeEl.textContent = formatUSDT(turnoverUSDT);

                    // 24h æŒ¯å¹…ï¼ˆé«˜ä½åŒºé—´/å½“å‰ä»·ï¼‰ï¼Œæ¯10åˆ†é’Ÿè®¡ç®—ä¸€æ¬¡ï¼Œå‡å°‘ç½‘ç»œè´Ÿæ‹…
                    if (typeof window.__ampVal === 'undefined') { window.__ampVal = null; window.__ampTs = 0; }
                    const now = Date.now();
                    const ttl = 10 * 60 * 1000; // 10åˆ†é’Ÿ
                    const canUseCache = (typeof window.__ampVal === 'number' && isFinite(window.__ampVal) && (now - (window.__ampTs || 0) < ttl));

                    if (canUseCache) {
                        volEl.textContent = window.__ampVal.toFixed(2) + '%';
                        volEl.classList.remove('loading-inline');
                    } else {
                        const h = Number(market.high24h);
                        const l = Number(market.low24h);
                        const p = Number(market.price ?? market.last);
                        if (isFinite(h) && isFinite(l) && isFinite(p) && p > 0 && h >= l) {
                            const amp = Math.max(0, ((h - l) / p) * 100);
                            window.__ampVal = amp;
                            window.__ampTs = now;
                            volEl.textContent = amp.toFixed(2) + '%';
                            volEl.classList.remove('loading-inline');
                        } else {
                            volEl.textContent = 'åŠ è½½ä¸­â€¦';
                            volEl.classList.add('loading-inline');
                        }
                    }
            
                    lastMarketOk = true;
                    lastMarketUpdate = Date.now();
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = 'åœ¨çº¿ Â· å·²æ›´æ–° ' + fmtTime(lastMarketUpdate);
                    }
                }
                // å¹¶è¡Œè¯·æ±‚èµ„é‡‘è´¹ç‡(8h)
                try {
                    const frRes = await fetch('/api/market/funding-rate?symbol=ETH-USDT-SWAP');
                    const frJson = await frRes.json();
                    const val = (typeof frJson?.data?.fundingRate === 'number') ? frJson.data.fundingRate : null;
                    if (fundingEl) {
                        fundingEl.textContent = (val === null || !isFinite(val)) ? '--' : (val * 100).toFixed(4) + '%';
                    }
                } catch (e) {
                    if (fundingEl) fundingEl.textContent = '--';
                }
            } catch (error) {
                console.error('åŠ è½½å¸‚åœºæ•°æ®å¤±è´¥:', error);
                // ä¸æ¸…ç©ºå·²æœ‰æ•°å€¼ï¼Œæ”¹ä¸ºæç¤ºç¦»çº¿å¹¶æä¾›é‡è¯•
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.innerHTML = 'ç¦»çº¿ Â· è·å–å¤±è´¥ï¼Œ<a href="#" onclick="refreshMarketData(); return false;">ç‚¹å‡»é‡è¯•</a>' + (lastMarketUpdate ? (' Â· ä¸Šæ¬¡æ›´æ–° ' + fmtTime(lastMarketUpdate)) : '');
                }
            }
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é—´
        function updateUptime() {
            // ç®€å•çš„è¿è¡Œæ—¶é—´è®¡ç®—
            const startTime = localStorage.getItem('systemStartTime');
            if (!startTime) {
                localStorage.setItem('systemStartTime', Date.now());
                return;
            }
            
            const uptime = Date.now() - parseInt(startTime);
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            const el = document.getElementById('uptime');
            if (el) el.textContent = `${hours}h ${minutes}m`;
        }
        
        // åˆ·æ–°ä¿¡å·
        function refreshSignal() {
            loadLatestSignal();
        }
        
        // åˆ·æ–°å¸‚åœºæ•°æ®
        function refreshMarketData() {
            loadMarketData();
        }
        
        // æŸ¥çœ‹æ€§èƒ½æŠ¥å‘Š
        function viewPerformance() {
            window.open('/api/strategy/performance', '_blank');
        }
        
        // æŸ¥çœ‹é£é™©ç®¡ç†
        function viewRiskManagement() {
            window.open('/api/risk/status', '_blank');
        }
        
        // æŸ¥çœ‹å›æµ‹å†å²
        function viewBacktestHistory() {
            alert('å›æµ‹å†å²åŠŸèƒ½å¼€å‘ä¸­...');
        }
        

        // åŠ è½½å¼€å•æ¨èï¼ˆè„šæœ¬å†…ï¼‰
        async function loadTradeRecommendation() {
            const container = document.getElementById('tradingRecommendation');
            if (!container) return;
            container.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>';
            try {
                // æ”¹ä¸ºä»…ä¾èµ– /api/active-recommendations
                const res = await fetch('/api/active-recommendations');
                const payload = await res.json();
                const d = payload?.data ?? payload;
                const list = Array.isArray(d?.recommendations)
                    ? d.recommendations
                    : Array.isArray(d)
                        ? d
                        : Array.isArray(d?.list)
                            ? d.list
                            : [];

                // æ— æ´»è·ƒæ¨èï¼šé¡¶éƒ¨çº¢è‰²æ¨ªå¹…æç¤ºï¼Œæ¨èå­—æ®µç½®ç©º
                const hasActive = Array.isArray(list) && list.length > 0;
                if (!hasActive) {
                    container.innerHTML = '<div class="error">æš‚æ— æ¨èæ“ä½œ</div>';
                    const actionEl = document.getElementById('recommendedAction');
                    const entryEl = document.getElementById('entryPrice');
                    const levEl = document.getElementById('recommendedLeverage');
                    const posEl = document.getElementById('positionSizeRecommend');
                    if (actionEl) actionEl.textContent = '';
                    if (entryEl) entryEl.textContent = '';
                    if (levEl) levEl.textContent = '';
                    if (posEl) posEl.textContent = '';
                    window.__lastRecommendation = null;
                    return;
                }

                // å­˜åœ¨æ´»è·ƒæ¨èï¼šæ¸²æŸ“è¯¦ç»†ä¿¡æ¯
                const latest = list
                    .slice()
                    .sort((a, b) => {
                        const ta = new Date(a?.updated_at || a?.created_at || 0).getTime();
                        const tb = new Date(b?.updated_at || b?.created_at || 0).getTime();
                        return tb - ta;
                    })[0] || list[0];

                const actionRaw = latest?.direction || latest?.action || '';
                const action = String(actionRaw).toUpperCase();

                const entryVal = (typeof latest?.entry_price === 'number')
                    ? latest.entry_price
                    : (typeof latest?.current_price === 'number' ? latest.current_price : null);
                const entry = (typeof entryVal === 'number') ? entryVal : '--';

                const levVal = (typeof latest?.leverage === 'number') ? latest.leverage : null;
                const leverage = (typeof levVal === 'number') ? (levVal + 'x') : '--';

                let posSize;
                if (typeof latest?.position_size === 'number') {
                    if (latest.position_size > 0 && latest.position_size <= 1) {
                        posSize = (latest.position_size * 100).toFixed(1) + '%';
                    } else {
                        posSize = String(latest.position_size);
                    }
                } else {
                    posSize = '--';
                }

                const tpVal = (typeof latest?.take_profit_price === 'number') ? latest.take_profit_price : (typeof latest?.take_profit === 'number' ? latest.take_profit : null);
                const slVal = (typeof latest?.stop_loss_price === 'number') ? latest.stop_loss_price : (typeof latest?.stop_loss === 'number' ? latest.stop_loss : null);
                const tp = (typeof tpVal === 'number') ? tpVal : '--';
                const sl = (typeof slVal === 'number') ? slVal : '--';

                const confRaw = (typeof latest?.confidence_score === 'number') ? latest.confidence_score : (typeof latest?.confidence === 'number' ? latest.confidence : null);
                const conf = (typeof confRaw === 'number') ? (((confRaw <= 1 ? confRaw * 100 : confRaw)).toFixed(1) + '%') : '--';

                container.innerHTML = `
                    <div class="row"><span class="key">æ¨èæ“ä½œ</span><span class="val">${action}</span></div>
                    <div class="row"><span class="key">å…¥åœºä»·ä½</span><span class="val">${typeof entry === 'number' ? '$' + entry.toFixed(2) : entry}</span></div>
                    <div class="row"><span class="key">æ¨èæ æ†</span><span class="val">${typeof leverage === 'number' ? leverage + 'x' : leverage}</span></div>
                    <div class="row"><span class="key">ç½®ä¿¡åº¦</span><span class="val">${conf}</span></div>
                    <div class="row"><span class="key">æ­¢ç›ˆ/æ­¢æŸ</span><span class="val">${typeof tp === 'number' ? '$' + tp.toFixed(2) : tp} / ${typeof sl === 'number' ? '$' + sl.toFixed(2) : sl}</span></div>
                `;

                const actionEl = document.getElementById('recommendedAction');
                const entryEl = document.getElementById('entryPrice');
                const levEl = document.getElementById('recommendedLeverage');
                const posEl = document.getElementById('positionSizeRecommend');
                if (actionEl) actionEl.textContent = action;
                if (entryEl) entryEl.textContent = (typeof entry === 'number') ? '$' + entry.toFixed(2) : String(entry);
                if (levEl) levEl.textContent = (typeof leverage === 'number') ? leverage + 'x' : String(leverage);
                if (posEl) posEl.textContent = conf;

                window.__lastRecommendation = { action, entry, leverage, tp, sl, conf };            } catch (err) {
                console.error('åŠ è½½å¼€å•æ¨èå¤±è´¥:', err);
                container.innerHTML = '<div class="error">æ¨èåŠ è½½å¤±è´¥</div>';
            }
        }

        // æ–°å¢ï¼šå¼€å¤š/å¼€ç©ºæŒ‰é’®ï¼ˆæ¼”ç¤ºæç¤ºï¼‰
        function openLongPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€å¤š:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}`);
        }
        function openShortPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`å‡†å¤‡å¼€ç©º:\nå…¥åœº: ${formatPrice(rec.entry)}\næ æ†: ${formatLev(rec.leverage)}\næ­¢ç›ˆ: ${formatPrice(rec.tp)} / æ­¢æŸ: ${formatPrice(rec.sl)}`);
        }
        function formatPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v || '--'); }
        function formatLev(v){ return (typeof v === 'number') ? (v + 'x') : (v || '--'); }
        
        // äº¤æ˜“æŒ‰é’®çŠ¶æ€æ§åˆ¶ï¼šNONE/LONG/SHORT
        function setTradeButtonsState(direction){
            try{
                const btnLong = document.getElementById('btnLong');
                const btnShort = document.getElementById('btnShort');
                const dir = String(direction||'NONE').toUpperCase();
                if(!btnLong || !btnShort){ return; }
                if(dir === 'LONG'){
                    btnLong.disabled = false;
                    btnShort.disabled = true;
                } else if(dir === 'SHORT'){
                    btnLong.disabled = true;
                    btnShort.disabled = false;
                } else {
                    btnLong.disabled = true;
                    btnShort.disabled = true;
                }
            }catch(e){ /* å¿½ç•¥ UI çŠ¶æ€å¼‚å¸¸ */ }
        }
        
        // æ¨èå†å²ç›¸å…³åŠŸèƒ½
        let recommendationData = [];
        let filteredRecommendations = [];
        // æ–°å¢ï¼šåˆ†é¡µçŠ¶æ€
        let currentPage = 1;
        let pageSize = 5; // é»˜è®¤æ¯é¡µ5æ¡
        const selectedRecommendationIds = new Set();
        // æ¥è‡ªåç«¯çš„çœŸå®æ€»æ•°ä¸æ´»è·ƒæ•°ï¼ˆä¼˜å…ˆç”¨äºç»Ÿè®¡å±•ç¤ºï¼‰
        let serverTotalRecommendations = null;
        let serverActiveRecommendationsCount = null;
        
        // æ–°å¢ï¼šè·å–å½“å‰é¡µå¯è§æ•°æ®
        function getVisiblePageItems(){
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages; // è¶Šç•Œå®¹é”™
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            return filteredRecommendations.slice(start, end);
        }

        function updateDeleteButtonState() {
            const btn = document.getElementById('deleteSelectedBtn');
            if (!btn) return;
            const count = selectedRecommendationIds.size;
            btn.disabled = count === 0;
            btn.textContent = `åˆ é™¤æ‰€é€‰(${count})`;
        }
        function resetHeaderCheckbox() {
            const headerCb = document.getElementById('selectAllRecs');
            if (!headerCb) return;
            const visibleIds = getVisiblePageItems().map(r => r.id).filter(Boolean);
            if (visibleIds.length === 0) {
                headerCb.checked = false;
                headerCb.indeterminate = false;
                return;
            }
            const selectedVisible = visibleIds.filter(id => selectedRecommendationIds.has(id));
            headerCb.checked = selectedVisible.length === visibleIds.length && visibleIds.length > 0;
            headerCb.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visibleIds.length;
        }
        function toggleSelectAll(cb){
            const shouldSelect = cb?.checked;
            getVisiblePageItems().forEach(rec => {
                if (!rec?.id) return;
                if (shouldSelect) {
                    selectedRecommendationIds.add(rec.id);
                } else {
                    selectedRecommendationIds.delete(rec.id);
                }
            });
            renderRecommendationList();
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        function onRowSelectChange(id, checked){
            if (!id) return;
            if (checked) selectedRecommendationIds.add(id); else selectedRecommendationIds.delete(id);
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        
        // åŠ è½½æ¨èå†å²
        async function loadRecommendationHistory() {
            const statusEl = document.getElementById('recommendationInlineStatus');
            const listEl = document.getElementById('recommendationList');
            
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨æ›´æ–°...';
            }
            
            try {
                const response = await fetch('/api/recommendations');
                const data = await response.json();
                
                // å…¼å®¹ä¸åŒå“åº”ç»“æ„ï¼š
                // 1) { success: true, data: [...] }
                // 2) { success: true, data: { list: [...] , total, ... } }
                // 3) { list: [...] }
                const list = Array.isArray(data)
                  ? data
                  : Array.isArray(data?.data)
                    ? data.data
                    : Array.isArray(data?.data?.recommendations)
                      ? data.data.recommendations
                      : Array.isArray(data?.data?.list)
                        ? data.data.list
                        : Array.isArray(data?.list)
                          ? data.list
                          : [];
                // è¯»å–åç«¯æ€»æ•°ï¼ˆå¦‚æœæä¾›ï¼‰
                serverTotalRecommendations =
                  (typeof data?.data?.total === 'number') ? data.data.total :
                  (typeof data?.total === 'number') ? data.total : null;
                
                if ((data?.success === true && list) || list.length > 0) {
                    recommendationData = list;
                    filteredRecommendations = [...recommendationData];
                    
                    // åº”ç”¨å½“å‰ç­›é€‰å’Œæ’åº
                    filterRecommendations();
                    sortRecommendations();
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    await updateRecommendationStats();
                    
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        // è‹¥åç«¯æä¾› totalï¼Œåˆ™æ˜¾ç¤º totalï¼Œå¦åˆ™æ˜¾ç¤ºå½“å‰æ‰¹æ¬¡æ¡æ•°
                        const shown = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
                        statusEl.textContent = `å·²åŠ è½½ ${shown} æ¡ï¼ˆå½“å‰æ‰¹æ¬¡ ${recommendationData.length}ï¼‰`;
                    }
                    // æ¸…ç©ºå ä½å†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (listEl && listEl.innerHTML && listEl.innerHTML.includes('æ­£åœ¨åŠ è½½æ¨èè®°å½•')) {
                        listEl.innerHTML = '';
                    }
                } else {
                    if (listEl) {
                        listEl.innerHTML = '<div class="error">æš‚æ— æ¨èè®°å½•</div>';
                    }
                    if (statusEl) {
                        statusEl.className = 'inline-status warn';
                        statusEl.textContent = 'æš‚æ— æ•°æ®';
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¨èå†å²å¤±è´¥:', error);
                if (listEl) {
                    listEl.innerHTML = '<div class="error">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
                }
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.textContent = 'åŠ è½½å¤±è´¥';
                }
            }
        }
        
        // æ¸²æŸ“æ¨èåˆ—è¡¨åˆ°è¡¨æ ¼ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function renderRecommendationList() {
            const tableBodyEl = document.getElementById('recommendationTableBody');
            if (!tableBodyEl) return;
            
            if (filteredRecommendations.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="10" class="loading">æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¨èè®°å½•</td></tr>';
                renderPagination();
                resetHeaderCheckbox();
                return;
            }
            const pageItems = getVisiblePageItems();
            if (pageItems.length === 0) {
                currentPage = Math.max(1, currentPage - 1);
                return renderRecommendationList();
            }
            
            const html = pageItems.map(rec => {
                const time = new Date(rec.created_at || rec.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const actionRaw = rec.direction || rec.action || 'HOLD';
                const action = String(actionRaw).toUpperCase();
                const status = rec.status || 'PENDING';
                const pnl = rec.pnl_percent || rec.pnl_percentage || 0;
                const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : '';
                const confidence = rec.confidence_score || rec.confidence || 0;
                const accent = action === 'LONG' ? 'accent-long' : (action === 'SHORT' ? 'accent-short' : 'accent-hold');
                const isChecked = rec.id ? selectedRecommendationIds.has(rec.id) : false;
                
                // çŠ¶æ€æ˜¾ç¤ºæ˜ å°„
                const statusMap = {
                    'PENDING': 'å¾…ç¡®è®¤',
                    'ACTIVE': 'è¿›è¡Œä¸­',
                    'CLOSED': 'å·²å¹³ä»“',
                    'EXPIRED': 'å·²è¿‡æœŸ'
                };
                
                return `
                    <tr class="recommendation-row ${status.toLowerCase()} ${accent}">
                        <td style="text-align:center"><input type="checkbox" ${isChecked ? 'checked' : ''} ${rec.id ? '' : 'disabled'} onchange="onRowSelectChange('${rec.id ?? ''}', this.checked)"/></td>
                        <td>${time}</td>
                        <td><span class="action-badge ${action.toLowerCase()}">${action}</span></td>
                        <td>${formatPrice(rec.entry_price)}</td>
                        <td>${formatLev(rec.leverage)}</td>
                        <td>${formatPrice(rec.take_profit_price || rec.take_profit)}</td>
                        <td>${formatPrice(rec.stop_loss_price || rec.stop_loss)}</td>
                        <td>${confidence ? (confidence * 100).toFixed(1) + '%' : '--'}</td>
                        <td><span class="status-badge ${status.toLowerCase()}">${statusMap[status] || status}</span></td>
                        <td><span class="pnl-value ${pnlClass}">${pnl ? (pnl > 0 ? '+' : '') + pnl.toFixed(2) + '%' : '--'}</span></td>
                    </tr>
                `;
            }).join('');
            
            tableBodyEl.innerHTML = html;
            renderPagination();
            resetHeaderCheckbox();
        }
        
        // ç­›é€‰æ¨èï¼ˆé‡ç½®åˆ°ç¬¬1é¡µï¼‰
        function filterRecommendations() {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            if (statusFilter === 'all') {
                filteredRecommendations = [...recommendationData];
            } else if (statusFilter === 'ACTIVE') {
                filteredRecommendations = recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'PENDING');
            } else {
                filteredRecommendations = recommendationData.filter(rec => rec.status === statusFilter);
            }
            currentPage = 1;
            renderRecommendationList();
        }
        
        // æ’åºæ¨èï¼ˆé‡ç½®åˆ°ç¬¬1é¡µï¼‰
        function sortRecommendations() {
            const sortBy = document.getElementById('sortBy')?.value || 'created_at';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            
            filteredRecommendations.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'created_at':
                        aVal = new Date(a.created_at || a.timestamp);
                        bVal = new Date(b.created_at || b.timestamp);
                        break;
                    case 'pnl_percent':
                        aVal = a.pnl_percent || a.pnl_percentage || 0;
                        bVal = b.pnl_percent || b.pnl_percentage || 0;
                        break;
                    case 'confidence_score':
                        aVal = a.confidence_score || a.confidence || 0;
                        bVal = b.confidence_score || b.confidence || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            currentPage = 1;
            renderRecommendationList();
        }
        
        // æ–°å¢ï¼šæ¸²æŸ“åˆ†é¡µ
        function renderPagination(){
            const el = document.getElementById('recommendationPagination');
            if (!el) return;
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const maxShown = 5;
            let start = Math.max(1, currentPage - Math.floor(maxShown/2));
            let end = Math.min(totalPages, start + maxShown - 1);
            start = Math.max(1, Math.min(start, Math.max(1, end - maxShown + 1)));

            const pageNumbers = [];
            for (let p = start; p <= end; p++) {
                pageNumbers.push(`<button class="page-number ${p===currentPage?'active':''}" onclick="goToPage(${p})">${p}</button>`);
            }

            el.innerHTML = `
                <button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage<=1?'disabled':''}>ä¸Šä¸€é¡µ</button>
                ${pageNumbers.join('')}
                <button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>ä¸‹ä¸€é¡µ</button>
                <span class="page-info">å…± ${total} æ¡ Â· æ¯é¡µ ${pageSize} æ¡ Â· ç¬¬ ${currentPage}/${totalPages} é¡µ</span>
            `;
        }

        // æ–°å¢ï¼šç¿»é¡µå‡½æ•°
        function goToPage(p){
            const totalPages = Math.max(1, Math.ceil(filteredRecommendations.length / pageSize));
            currentPage = Math.min(Math.max(1, p), totalPages);
            renderRecommendationList();
        }
        window.goToPage = goToPage;
        
        // æ›´æ–°æ¨èç»Ÿè®¡ï¼ˆä½¿ç”¨åç«¯çœŸå® total/activeã€ç»¼åˆç»Ÿè®¡ä¸­çš„èƒœç‡ä¸å¹³å‡æ”¶ç›Šï¼‰
        async function updateRecommendationStats() {
            const total = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
            // å¼‚æ­¥è·å–çœŸå®æ´»è·ƒæ•°ï¼ˆå…¼å®¹ {data:{recommendations, count}} ç»“æ„ï¼‰
            try {
                const res = await fetch('/api/active-recommendations');
                if (res.ok) {
                    const act = await res.json();
                    const payload = act?.data ?? act;
                    const arr = Array.isArray(payload?.recommendations)
                        ? payload.recommendations
                        : Array.isArray(payload)
                            ? payload
                            : Array.isArray(payload?.list)
                                ? payload.list
                                : [];
                    serverActiveRecommendationsCount = Array.isArray(arr) ? arr.length : null;
                }
            } catch(e) {
                console.warn('è·å–æ´»è·ƒæ¨èå¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°ç»Ÿè®¡', e);
            }
            const active = (typeof serverActiveRecommendationsCount === 'number')
                ? serverActiveRecommendationsCount
                : recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'active').length;

            // èƒœç‡ä¸å¹³å‡æ”¶ç›Šä¼˜å…ˆè¯»å–ç»¼åˆç»Ÿè®¡æ¥å£ï¼ˆå…¨é‡å·²å¹³ä»“å£å¾„ï¼‰ï¼Œå¤±è´¥å›é€€åˆ°æœ¬åœ°æ ·æœ¬
            let winRateFromServer = null;
            let avgPnlFromServer = null;
            try {
                const res2 = await fetch('/api/statistics/overall');
                if (res2.ok) {
                    const ov = await res2.json();
                    const d = ov?.data ?? ov;
                    if (typeof d?.overall_win_rate === 'number') winRateFromServer = d.overall_win_rate;
                    if (typeof d?.overall_avg_pnl === 'number') avgPnlFromServer = d.overall_avg_pnl;
                    // è‹¥æ­¤å‰æœªè·å¾— total/activeï¼Œå¯ä»ç»Ÿè®¡æ¥å£è¡¥é½
                    if (typeof serverTotalRecommendations !== 'number' && typeof d?.total_recommendations === 'number') {
                        serverTotalRecommendations = d.total_recommendations;
                    }
                    if (typeof serverActiveRecommendationsCount !== 'number' && typeof d?.active_recommendations === 'number') {
                        serverActiveRecommendationsCount = d.active_recommendations;
                    }
                }
            } catch (e) {
                console.warn('è·å–ç»¼åˆç»Ÿè®¡å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°æ ·æœ¬ç»Ÿè®¡', e);
            }

            const completed = recommendationData.filter(rec => rec.status === 'CLOSED' || rec.status === 'completed');
            const localWinRate = completed.length > 0 ? 
                (completed.filter(rec => (rec.pnl_percent || rec.pnl_percentage || 0) > 0).length / completed.length * 100) : 0;
            const localAvgPnl = completed.length > 0 ? 
                (completed.reduce((sum, rec) => sum + (rec.pnl_percent || rec.pnl_percentage || 0), 0) / completed.length) : 0;
            const winRate = (typeof winRateFromServer === 'number') ? winRateFromServer : localWinRate;
            const avgPnl = (typeof avgPnlFromServer === 'number') ? avgPnlFromServer : localAvgPnl;
            
            document.getElementById('totalRecommendations').textContent = total;
            document.getElementById('activeRecommendations').textContent = active;
            document.getElementById('winRateRecommendations').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('avgPnlRecommendations').textContent = `${avgPnl.toFixed(2)}%`;
        }
        
        // åˆ·æ–°æ¨èå†å²
        function refreshRecommendations() { loadRecommendationHistory(); }
        
        // æ‰¹é‡åˆ é™¤æ‰€é€‰æ¨è
        async function deleteSelectedRecommendations(){
            const ids = Array.from(selectedRecommendationIds);
            if (ids.length === 0) return;
            if (!confirm(`ç¡®è®¤åˆ é™¤é€‰ä¸­çš„ ${ids.length} æ¡è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;
            const statusEl = document.getElementById('recommendationInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = 'æ­£åœ¨åˆ é™¤...';
            }
            document.getElementById('deleteSelectedBtn')?.setAttribute('disabled','true');
            // é€ä¸ªè°ƒç”¨åç«¯åˆ é™¤æ¥å£
            const results = await Promise.allSettled(ids.map(id => fetch(`/api/recommendations/${id}`, { method: 'DELETE' })));
            let ok = 0, fail = 0;
            for (const r of results) {
                if (r.status === 'fulfilled' && r.value?.ok) ok++; else fail++;
            }
            // æ¸…ç†é€‰æ‹© & åˆ·æ–°
            selectedRecommendationIds.clear();
            updateDeleteButtonState();
            await loadRecommendationHistory();
            // ç¡®ä¿ç»Ÿè®¡åŒæ­¥æœåŠ¡ç«¯
            await updateRecommendationStats();
            if (statusEl) {
                statusEl.className = fail === 0 ? 'inline-status ok' : 'inline-status warn';
                statusEl.textContent = fail === 0 ? 'åˆ é™¤å®Œæˆ' : `éƒ¨åˆ†åˆ é™¤å¤±è´¥ (${ok}/${ids.length})`;
            }
            if (fail > 0) {
                alert(`åˆ é™¤å®Œæˆï¼šæˆåŠŸ ${ok} æ¡ï¼Œå¤±è´¥ ${fail} æ¡ã€‚`);
            }
        }
        
        // å¯åŠ¨ç­–ç•¥
        async function startStrategy() {
            try {
                const response = await fetch('/api/strategy/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å¯åŠ¨æˆåŠŸï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥å¯åŠ¨å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // åœæ­¢ç­–ç•¥
        async function stopStrategy() {
            try {
                const response = await fetch('/api/strategy/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('ç­–ç•¥å·²åœæ­¢ï¼');
                    loadSystemStatus();
                } else {
                    alert('ç­–ç•¥åœæ­¢å¤±è´¥: ' + data.error);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        // é‡å¯ç­–ç•¥
        async function restartStrategy() {
            if (confirm('ç¡®å®šè¦é‡å¯ç­–ç•¥å—ï¼Ÿ')) {
                await stopStrategy();
                setTimeout(() => {
                    startStrategy();
                }, 2000);
            }
        }
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
    <script>
    (function(){
      if (window.__ACTIVE_UI_PATCHED__) return; // é˜²é‡å¤æ³¨å…¥
      window.__ACTIVE_UI_PATCHED__ = true;
      if (typeof window.loadTradeRecommendation === 'function') {
        window.__legacyLoadTradeRecommendation = window.loadTradeRecommendation;
      }
      const AUTO_MS_DEFAULT = 30000;
      function ensureActiveStyles(){
        if(document.getElementById('active-styles')) return;
        const style=document.createElement('style');
        style.id='active-styles';
        style.textContent = `
        .active-bar{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border:1px solid #e8e8e8;border-radius:8px;background:#fafafa;margin-bottom:10px}
        .active-bar .left{display:flex;align-items:center;gap:8px}
        .active-bar .right{display:flex;align-items:center;gap:8px}
        .active-bar .label{color:#555}
        .active-bar .strong{font-weight:600}
        .active-bar .muted{color:#888}
        .active-bar .sep{color:#ddd}
        .active-bar .countdown{font-variant-numeric:tabular-nums;color:#333}
        .active-bar .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
        .active-bar .dot.on{background:#2ecc71}
        .active-bar .dot.off{background:#e74c3c}
        .btn.small{padding:6px 10px;font-size:12px;border-radius:6px;border:1px solid #ddd;background:#fff;cursor:pointer;color:#2980b9}
.btn.small:hover{background:#f4f4f4}
        .btn.danger{border-color:#ffb4b4;color:#c0392b}
        .btn.danger:hover{background:#ffecec}
        .rec-list{display:flex;flex-direction:column;gap:16px}
        .rec-item{display:flex;align-items:stretch;justify-content:space-between;gap:16px;border:1px solid #eaeaea;border-radius:12px;padding:14px 16px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,0.03)}
        .rec-item .col.main{flex:1}
        .rec-item .col.side{width:168px;padding-left:12px;border-left:1px dashed #eee;display:flex;flex-direction:column;align-items:flex-end;justify-content:center}
        .rec-item .title{display:flex;align-items:center;gap:10px;margin-bottom:10px}
        .rec-item .symbol{font-weight:600}
        .rec-item .muted{color:#888;font-size:12px}
        .rec-item .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px 14px}
        .rec-item .k{color:#666;margin-right:6px}
        .rec-item .v{font-variant-numeric:tabular-nums;line-height:1.5}
        .rec-item .ttl{color:#666;font-size:12px;margin-bottom:4px}
        .rec-item .ttl-val{font-variant-numeric:tabular-nums;font-weight:600;margin:8px 0;font-size:14px}
        .rec-item.skeleton{min-height:140px}
        .rec-item.skeleton .v{color:#bbb}
        .badge{padding:2px 6px;border-radius:6px;background:#eef;border:1px solid #dde;font-size:12px}
        .badge.long{background:#eafff3;border-color:#c4f2d8;color:#1e874b}
        .badge.short{background:#fff0f0;border-color:#ffd6d6;color:#b03a2e}
        .diff-blink{animation: diffFlash 1.2s ease-in-out 1}
        @keyframes diffFlash{0%{background:transparent}30%{background:#fff6cc}100%{background:transparent}}
        .empty-tip{padding:10px 12px;color:#666}
        @media (max-width: 560px){.rec-item{flex-direction:column}.rec-item .col.side{width:100%;align-items:flex-start;border-left:0;border-top:1px dashed #eee;margin-top:8px;padding-top:8px}}
        .loading{padding:8px 10px;color:#666}
        .error{padding:8px 10px;color:#b03a2e}
        .alert{padding:10px 12px;border-radius:8px;margin:10px 0;font-size:14px}
        .alert-danger{background:#fff0f0;border:1px solid #ffd6d6;color:#b03a2e}
        `;
        document.head.appendChild(style);
      }
      function renderTopBar(count){
        const nextAt = Date.now() + (window.__AUTO_REFRESH_INTERVAL_MS||AUTO_MS_DEFAULT);
        window.__nextAutoRefreshAt = nextAt;
        return `<div class="active-bar" id="activeSignalBar">
          <div class="left">
            <span class="dot ${count>0?'on':'off'}"></span>
            <span class="label">æ´»è·ƒä¿¡å·</span>
            <span class="strong" id="activeSignalCount">${count}</span>
            <span class="sep">|</span>
            <span class="muted">ä¸‹æ¬¡è‡ªåŠ¨åˆ·æ–°</span>
            <span class="countdown" id="nextRefreshCountdown">${Math.round((nextAt-Date.now())/1000)}s</span>
          </div>
          <div class="right">
            <button id="btnManualRefresh" class="btn small">åˆ·æ–°</button>
          </div>
        </div>`;
      }
      function ensureAutoRefreshTicker(){
        if (window.__autoRefreshTickTimer) clearInterval(window.__autoRefreshTickTimer);
        window.__autoRefreshTickTimer = setInterval(()=>{
          const el = document.getElementById('nextRefreshCountdown');
          if(!el||!window.__nextAutoRefreshAt) return;
          const remain=Math.max(0,Math.round((window.__nextAutoRefreshAt-Date.now())/1000));
          el.textContent = `${remain}s`;
        },1000);
      }
      function scheduleAutoRefresh(){
        const ms = window.__AUTO_REFRESH_INTERVAL_MS||AUTO_MS_DEFAULT;
        if (window.__nextRefreshTimer) clearTimeout(window.__nextRefreshTimer);
        window.__nextRefreshTimer = setTimeout(()=>{
          try { window.loadTradeRecommendation(); } catch(e){}
        }, ms);
      }
      function parseActiveList(d){
        const list = Array.isArray(d?.recommendations) ? d.recommendations : Array.isArray(d) ? d : Array.isArray(d?.list) ? d.list : [];
        return Array.isArray(list) ? list.filter(Boolean) : [];
      }
      function fmtPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v ?? '--'); }
      function fmtLev(v){ return (typeof v === 'number') ? (v + 'x') : (v ?? '--'); }
      function fmtPct(v){ if (typeof v === 'number') return `${v<=1?(v*100).toFixed(1):v.toFixed(1)}%`; if (typeof v === 'string' && v.endsWith('%')) return v; return '--'; }
      function formatRelative(ts){ if (!ts) return '--'; const t = (ts instanceof Date) ? ts.getTime() : new Date(ts).getTime(); if (!Number.isFinite(t)) return '--'; const s = Math.max(0, Math.floor((Date.now()-t)/1000)); if (s<60) return `${s}så‰`; const m=Math.floor(s/60); if(m<60) return `${m}åˆ†é’Ÿå‰`; const h=Math.floor(m/60); if(h<24) return `${h}å°æ—¶å‰`; const d=Math.floor(h/24); return `${d}å¤©å‰`; }
      function clearItemTimers(){ const map = window.__activeCountdownTimers||{}; Object.keys(map).forEach(k=>{ try{clearInterval(map[k]);}catch(e){} delete map[k]; }); }
      function startItemCountdown(id, createdAt){ const ttlEl = document.getElementById(`ttl-${id}`); if(!ttlEl) return; const base = (createdAt instanceof Date)?createdAt.getTime():new Date(createdAt).getTime(); const deadline = base + 24*60*60*1000; const tick=()=>{ const leftMs=Math.max(0,deadline-Date.now()); const s=Math.floor(leftMs/1000); const h=Math.floor(s/3600); const m=Math.floor((s%3600)/60); const ss=s%60; ttlEl.textContent = `${h}h ${m}m ${ss}s`; }; tick(); const timer=setInterval(tick,1000); if(!window.__activeCountdownTimers) window.__activeCountdownTimers={}; window.__activeCountdownTimers[id]=timer; }
      function diffHighlight(id,current){ const prev = (window.__lastActiveSnapshot||{})[id]; if(!window.__lastActiveSnapshot) window.__lastActiveSnapshot={}; window.__lastActiveSnapshot[id] = { direction: current.direction, entry_price: current.entry_price, take_profit_price: current.take_profit_price ?? current.take_profit, stop_loss_price: current.stop_loss_price ?? current.stop_loss, leverage: current.leverage, position_size: current.position_size }; if(!prev) return; ['direction','entry_price','take_profit_price','stop_loss_price','leverage','position_size'].forEach(k=>{ const pv=prev[k], cv=window.__lastActiveSnapshot[id][k]; if(String(pv)!==String(cv)){ const el=document.querySelector(`[data-field="${k}-${id}"]`); if(el){ el.classList.add('diff-blink'); setTimeout(()=>el.classList.remove('diff-blink'),1600); } } }); }

      window.loadTradeRecommendation = async function(){
        const container = document.getElementById('tradingRecommendation');
        if (!container) return;
        ensureActiveStyles();
        if (typeof window.__AUTO_REFRESH_INTERVAL_MS !== 'number') window.__AUTO_REFRESH_INTERVAL_MS = AUTO_MS_DEFAULT;
        container.innerHTML = '<div class="loading">æ­£åœ¨è·å–æ¨èä¿¡å·...</div>';
        try {
          const res = await fetch('/api/active-recommendations',{cache:'no-store'});
          const payload = await res.json();
          const d = payload?.data ?? payload;
          const list = parseActiveList(d);
          const hasActive = list.length>0;
          const topBar = renderTopBar(list.length);
          if(!hasActive){
            clearItemTimers(); ensureAutoRefreshTicker(); scheduleAutoRefresh();
            const a=document.getElementById('recommendedAction');
            const e=document.getElementById('entryPrice');
            const l=document.getElementById('recommendedLeverage');
            const p=document.getElementById('positionSizeRecommend');
            if(a) a.textContent=''; if(e) e.textContent=''; if(l) l.textContent=''; if(p) p.textContent=''; window.__lastRecommendation=null;
            container.innerHTML = `${topBar}<div class="alert alert-danger">å½“å‰ä»·æ ¼æš‚æ— å¼€å•æ¨è</div><div class="rec-list" id="activeSignalList"><div class="rec-item skeleton"><div class="col main"><div class="title"><span class="badge">--</span><span class="symbol">--</span></div><div class="grid"><div><span class="k">å»ºè®®åŠ¨ä½œ</span> <span class="v">--</span></div><div><span class="k">å…¥åœº</span> <span class="v">--</span></div><div><span class="k">æ æ†</span> <span class="v">--</span></div><div><span class="k">æ­¢ç›ˆ</span> <span class="v">--</span></div><div><span class="k">æ­¢æŸ</span> <span class="v">--</span></div><div><span class="k">ç½®ä¿¡åº¦</span> <span class="v">--</span></div></div></div><div class="col side"><div class="ttl">åˆ°æœŸå€’è®¡æ—¶</div><div class="ttl-val">--</div></div></div></div>`;
            try{ setTradeButtonsState('NONE'); }catch(_){ }
            const btn=document.getElementById('btnManualRefresh'); if(btn) btn.onclick=()=>{ window.loadTradeRecommendation(); };
            return;
          }
          const sorted = list.slice().sort((a,b)=>{ const ta=new Date(a?.updated_at||a?.created_at||0).getTime(); const tb=new Date(b?.updated_at||b?.created_at||0).getTime(); return tb-ta; });
          const itemsHtml = sorted.slice(0,1).map(rec=>{ const id=rec.id||rec._id||rec.uuid||''; const symbol=rec.symbol||'ETH-USDT-SWAP'; const direction=String(rec.direction||rec.action||'').toUpperCase(); const entry=(typeof rec.entry_price==='number')?rec.entry_price:(typeof rec.current_price==='number'?rec.current_price:null); const lev=(typeof rec.leverage==='number')?rec.leverage:null; const confRaw=(typeof rec.confidence_score==='number')?rec.confidence_score:(typeof rec.confidence==='number'?rec.confidence:null); const conf=(typeof confRaw==='number')?((confRaw<=1?confRaw*100:confRaw)):null; const tp=(typeof rec.take_profit_price==='number')?rec.take_profit_price:(typeof rec.take_profit==='number'?rec.take_profit:null); const sl=(typeof rec.stop_loss_price==='number')?rec.stop_loss_price:(typeof rec.stop_loss==='number'?rec.stop_loss:null); const cAt=rec.created_at||rec.createdAt||rec.create_time||null; const uAt=rec.updated_at||rec.updatedAt||null; const tag = direction==='LONG'?'åšå¤š':(direction==='SHORT'?'åšç©º':(direction||'--')); const baseEr=(typeof entry==='number' && typeof tp==='number')?(direction==='LONG'?((tp-entry)/entry):((entry-tp)/entry)):null; const erL=(typeof baseEr==='number')?(baseEr * (typeof lev==='number' && lev>0 ? lev : 1) * 100):null; return `<div class=\"rec-item\" id=\"rec-${id}\"><div class=\"col main\"><div class=\"title\"><span class=\"badge ${direction==='LONG'?'long':(direction==='SHORT'?'short':'')}\">${tag}</span><span class=\"symbol\">${symbol}</span><span class=\"muted\">åˆ›å»º ${formatRelative(cAt)}</span>${uAt?`<span class=\"muted\">æ›´æ–° ${formatRelative(uAt)}</span>`:''}</div><div class=\"grid\"><div><span class=\"k\">å…¥åœº</span> <span class=\"v\" data-field=\"entry_price-${id}\">${fmtPrice(entry)}</span></div><div><span class=\"k\">æ æ†</span> <span class=\"v\" data-field=\"leverage-${id}\">${fmtLev(lev)}</span></div><div><span class=\"k\">æ­¢ç›ˆ</span> <span class=\"v\" data-field=\"take_profit_price-${id}\">${fmtPrice(tp)}</span></div><div><span class=\"k\">æ­¢æŸ</span> <span class=\"v\" data-field=\"stop_loss_price-${id}\">${fmtPrice(sl)}</span></div><div><span class=\"k\">é¢„æœŸæ”¶ç›Š</span> <span class=\"v\">${fmtPct(erL)}</span></div><div><span class=\"k\">ç½®ä¿¡åº¦</span> <span class=\"v\">${fmtPct(conf)}</span></div></div></div><div class=\"col side\"><div class=\"ttl\">åˆ°æœŸå€’è®¡æ—¶</div><div class=\"ttl-val\" id=\"ttl-${id}\">--</div></div></div>`; }).join('');
          container.innerHTML = `${topBar}<div class="rec-list" id="activeSignalList">${itemsHtml}</div>`;
          const btn=document.getElementById('btnManualRefresh'); if(btn) btn.onclick=()=>{ window.loadTradeRecommendation(); window.loadRecommendationHistory?.(); window.updateRecommendationStats?.(); };
          clearItemTimers(); ensureAutoRefreshTicker(); scheduleAutoRefresh();
          sorted.slice(0,1).forEach(rec=>{ const id=rec.id||rec._id||rec.uuid||''; startItemCountdown(id, rec.created_at||rec.createdAt||rec.create_time); diffHighlight(id,rec); });
          document.querySelectorAll('[data-close-id]').forEach(el=>{ el.addEventListener('click', async()=>{ const id=el.getAttribute('data-close-id'); if(!id) return; if(el instanceof HTMLButtonElement){ el.disabled=true; el.textContent='å…³é—­ä¸­...'; } try{ const resp=await fetch(`/api/recommendations/${id}/close`,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reason:'USER_CLOSED'}) }); if(!resp.ok) throw new Error(`å…³é—­å¤±è´¥: ${resp.status}`); await window.loadTradeRecommendation(); window.updateRecommendationStats?.(); window.loadRecommendationHistory?.(); }catch(e){ alert('å…³é—­å¤±è´¥ï¼š'+(e?.message||e)); if(el instanceof HTMLButtonElement){ el.disabled=false; el.textContent='å…³é—­'; } } }); });
          // åŒæ­¥æ—§ç‰ˆå­—æ®µ
          const latest=sorted[0];
          const actionRaw=latest?.direction||latest?.action||''; const action=String(actionRaw).toUpperCase();
          const entryVal=(typeof latest?.entry_price==='number')?latest.entry_price:(typeof latest?.current_price==='number'?latest.current_price:null);
          const levVal=(typeof latest?.leverage==='number')?latest.leverage:null;
          const tpVal=(typeof latest?.take_profit_price==='number')?latest.take_profit_price:(typeof latest?.take_profit==='number'?latest.take_profit:null);
          const slVal=(typeof latest?.stop_loss_price==='number')?latest.stop_loss_price:(typeof latest?.stop_loss==='number'?latest.stop_loss:null);
          const confRaw=(typeof latest?.confidence_score==='number')?latest.confidence_score:(typeof latest?.confidence==='number'?latest.confidence:null);
          const conf=(typeof confRaw==='number')?(((confRaw<=1?confRaw*100:confRaw)).toFixed(1)+'%'):'--';
          const a=document.getElementById('recommendedAction'); const e=document.getElementById('entryPrice'); const l=document.getElementById('recommendedLeverage'); const p=document.getElementById('positionSizeRecommend');
          if(a) a.textContent=action; if(e) e.textContent=(typeof entryVal==='number')?'$'+entryVal.toFixed(2):String(entryVal??'--'); if(l) l.textContent=(typeof levVal==='number')?(levVal+'x'):'--'; if(p) p.textContent=conf;
          window.__lastRecommendation={action, entry:entryVal, leverage:levVal, tp:tpVal, sl:slVal, conf};
          try{ setTradeButtonsState(action); }catch(_){ }
        } catch(err) {
          console.error('åŠ è½½å¼€å•æ¨èå¤±è´¥:', err);
          const container = document.getElementById('tradingRecommendation');
          if (container) container.innerHTML = `${renderTopBar?.(0)||''}<div class=\"error\">æ¨èåŠ è½½å¤±è´¥</div>`;
          ensureAutoRefreshTicker(); scheduleAutoRefresh();
        }
      };
      // é¦–æ¬¡è£…è½½
      window.addEventListener('load', function(){ try{ window.loadTradeRecommendation(); }catch(e){} });
    })();
    </script>
</body>
</html>
