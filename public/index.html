<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH合约策略分析系统</title>
    <link rel="icon" type="image/svg+xml" href="/eth-logo.svg" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1680px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .header p {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 30px;
        }
        
        .status-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(102, 126, 234, 0.2);
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 30px;
            max-width: 1680px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        .card h2 {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .card-icon {
            width: 22px;
            height: 22px;
            display: inline-block;
            vertical-align: -4px;
            background: url('/eth-logo.svg') no-repeat center/contain;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        /* 顶部右侧诊断面板按钮 */
        .inspect-fab {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .signal-display {
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .signal-strength {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .strength-bar {
            flex: 1;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60 0%, #f39c12 50%, #e74c3c 100%);
            transition: width 0.3s;
        }
        
        .footer {
            text-align: center;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-top: 30px;
        }
        
        .footer p {
            color: #7f8c8d;
            margin-bottom: 15px;
        }
        
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .footer-links a {
            color: #3498db;
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s;
        }
        
        .footer-links a:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }
        
        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        /* 新增：推荐卡片样式 */
        .trading-recommendation {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 1px solid #eef2f7;
        }
        .trading-recommendation .row {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 14px;
            color: #555;
        }
        .trading-recommendation .key { color: #7f8c8d; }
        .trading-recommendation .val { color: #2c3e50; font-weight: 600; }
        .trading-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        
        /* 推荐历史样式 */
        .recommendation-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .recommendation-controls select {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
        }
        
        .recommendation-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .recommendation-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            transition: all 0.2s;
        }
        
        .recommendation-item:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* 推荐表格样式 */
        .recommendation-table-container {
            overflow-x: auto;
            margin-bottom: 20px;
        }
        
        .recommendation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .recommendation-table th,
        .recommendation-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .recommendation-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
            position: sticky;
            top: 0;
        }
        
        .recommendation-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .recommendation-row.pending {
            background-color: #fff3cd;
        }
        
        .recommendation-row.active {
            background-color: #d1ecf1;
        }
        
        .recommendation-row.closed {
            background-color: #d4edda;
        }
        
        .recommendation-row.expired {
            background-color: #f8d7da;
        }
        
        .action-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-badge.long {
            background-color: #d4edda;
            color: #155724;
        }
        
        .action-badge.short {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .action-badge.hold {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-badge.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-badge.active {
            background-color: #cce5ff;
            color: #004085;
        }
        
        .status-badge.closed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.expired {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .pnl-value.positive {
            color: #28a745;
            font-weight: 600;
        }
        
        .pnl-value.negative {
            color: #dc3545;
            font-weight: 600;
        }
        
        .recommendation-item.active {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .recommendation-item.completed {
            border-color: #10b981;
            background: #ecfdf5;
        }
        
        .recommendation-item.stopped {
            border-color: #ef4444;
            background: #fef2f2;
        }
        
        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .recommendation-action {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .recommendation-action.LONG {
            background: #dcfce7;
            color: #166534;
        }
        
        .recommendation-action.SHORT {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .recommendation-action.HOLD {
            background: #f3f4f6;
            color: #374151;
        }
        
        .recommendation-time {
            font-size: 12px;
            color: #6b7280;
        }
        
        .recommendation-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            font-size: 13px;
        }
        
        .recommendation-detail {
            display: flex;
            justify-content: space-between;
        }
        
        .recommendation-detail .label {
            color: #6b7280;
        }
        
        .recommendation-detail .value {
            font-weight: 500;
        }
        
        .recommendation-pnl {
            font-weight: 600;
        }
        
        .recommendation-pnl.positive {
            color: #10b981;
        }
        
        .recommendation-pnl.negative {
            color: #ef4444;
        }
        
        .recommendation-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .stat-label {
            display: block;
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        /* 新增：行情卡片内联状态提示 */
        .inline-status { display: inline-block; font-size: 12px; color: #7f8c8d; margin-top: 8px; }
        .inline-status.ok { color: #27ae60; }
        .inline-status.warn { color: #f39c12; }
        .inline-status.err { color: #e74c3c; }
        .card h2 .inline-status { margin-left: auto; margin-top: 0; }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                gap: 15px;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .metric-grid {
                grid-template-columns: 1fr;
            }
        }
        /* 分页样式 */
        .pagination{display:flex;align-items:center;gap:8px;justify-content:flex-end;margin:8px 0 16px}
        .pagination .page-btn,.pagination .page-number{padding:6px 10px;border:1px solid #d1d5db;background:#fff;border-radius:6px;cursor:pointer;font-size:13px}
        .pagination .page-number.active{background:#3498db;color:#fff;border-color:#3498db}
        .pagination .page-btn[disabled]{opacity:.5;cursor:not-allowed}
        .pagination .page-info{margin-left:8px;color:#6b7280;font-size:12px}
    </style>
</head>
<body>
    <div class="inspect-fab">
        <button class="btn" onclick="openInspect()">数据与指标诊断面板</button>
    </div>
    <div class="container">
        <div class="header">
            <h1 style="display:flex;align-items:center;gap:10px;justify-content:center">
                <img src="/eth-logo.svg" alt="ETH" width="36" height="36" style="transform: translateY(4px);"/>
                 ETH合约策略分析系统
             </h1>
            <p>基于机器学习的智能量化交易策略分析平台</p>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>系统运行中</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>策略引擎</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>ML分析</span>
                </div>
                <div class="status-item">
                    <div class="status-dot"></div>
                    <span>风险管理</span>
                </div>
            </div>
        </div>
        
        <div class="main-grid">
            <!-- 市场数据 -->
            <div class="card">
                <h2><span class="card-icon">💹</span>市场数据 <span id="marketInlineStatus" class="inline-status warn">正在初始化...</span></h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="currentPrice">--</div>
                        <div class="metric-label">当前价格</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="priceChange">--</div>
                        <div class="metric-label">今日涨跌幅(UTC+8)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volume">--</div>
                        <div class="metric-label">24h成交额(USDT)</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="volatility">--</div>
                        <div class="metric-label">波动率</div>
                    </div>
                    
                </div>
            </div>
            <!-- 开单推荐 -->
            <div class="card">
                <h2><span class="card-icon">🎯</span>开单推荐</h2>
                <div class="trading-recommendation" id="tradingRecommendation">
                    <div class="loading">正在获取推荐信号...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="recommendedAction">--</div>
                        <div class="metric-label">推荐操作</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="entryPrice">--</div>
                        <div class="metric-label">入场价位</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="recommendedLeverage">--</div>
                        <div class="metric-label">推荐杠杆</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSizeRecommend">--</div>
                        <div class="metric-label">建议仓位</div>
                    </div>
                </div>
                <div class="trading-buttons">
                    <button class="btn btn-success" onclick="openLongPosition()">📈 做多 (LONG)</button>
                    <button class="btn btn-danger" onclick="openShortPosition()">📉 做空 (SHORT)</button>
                </div>
                <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
                    建议仅供参考，请注意风险控制
                </div>
            </div>

            <!-- 推荐历史 -->
            <div class="card">
                <h2><span class="card-icon">📋</span>推荐历史 <span id="recommendationInlineStatus" class="inline-status warn">正在加载...</span></h2>
                
                <!-- 筛选和排序控件 -->
                <div class="recommendation-controls">
                    <select id="statusFilter" onchange="filterRecommendations()">
                        <option value="all">全部状态</option>
                        <option value="ACTIVE">进行中</option>
                        <option value="CLOSED">已平仓</option>
                    </select>
                    
                    <select id="sortBy" onchange="sortRecommendations()">
                        <option value="created_at">按时间排序</option>
                        <option value="pnl_percent">按收益排序</option>
                        <option value="confidence_score">按置信度排序</option>
                    </select>
                    
                    <select id="sortOrder" onchange="sortRecommendations()">
                        <option value="desc">降序</option>
                        <option value="asc">升序</option>
                    </select>
                    
                    <button class="btn btn-sm" onclick="refreshRecommendations()">刷新</button>
                    <button id="deleteSelectedBtn" class="btn btn-sm btn-danger" onclick="deleteSelectedRecommendations()" disabled>删除所选(0)</button>
                </div>
                
                <div class="recommendation-table-container">
                    <table class="recommendation-table" id="recommendationTable">
                        <thead>
                            <tr>
                                <th style="width:36px;text-align:center"><input type="checkbox" id="selectAllRecs" onclick="toggleSelectAll(this)"/></th>
                                <th>时间</th>
                                <th>操作</th>
                                <th>入场价</th>
                                <th>杠杆</th>
                                <th>止盈</th>
                                <th>止损</th>
                                <th>置信度</th>
                                <th>状态</th>
                                <th>收益</th>
                            </tr>
                        </thead>
                        <tbody id="recommendationTableBody">
                            <tr>
                                <td colspan="10" class="loading">正在加载推荐记录...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="recommendationPagination" class="pagination"></div>
                <div class="recommendation-stats" id="recommendationStats">
                    <div class="stat-item">
                        <span class="stat-value" id="totalRecommendations">--</span>
                        <span class="stat-label">总推荐数</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="activeRecommendations">--</span>
                        <span class="stat-label">活跃中</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="winRateRecommendations">--</span>
                        <span class="stat-label">胜率</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="avgPnlRecommendations">--</span>
                        <span class="stat-label">平均收益</span>
                    </div>
                </div>
            </div>
            
            <!-- 策略性能 -->
            <div class="card">
                <h2><span class="card-icon">📈</span>策略性能</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="totalReturn">--</div>
                        <div class="metric-label">总收益率</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="winRate">--</div>
                        <div class="metric-label">胜率</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="sharpeRatio">--</div>
                        <div class="metric-label">夏普比率</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="maxDrawdown">--</div>
                        <div class="metric-label">最大回撤</div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="viewPerformance()">📊 详细报告</button>
            </div>
            
            <!-- 风险管理 --><!-- 删除 -->
            
            <!-- 实时策略分析 --><!-- 删除 -->
            
            <!-- 回测分析 --><!-- 删除 -->
            <div class="card">
                <h2><span class="card-icon">🛡️</span>风险管理</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="riskScore">--</div>
                        <div class="metric-label">风险评分</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="positionSize">--</div>
                        <div class="metric-label">建议仓位</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="stopLoss">--</div>
                        <div class="metric-label">止损价位</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="takeProfit">--</div>
                        <div class="metric-label">止盈价位</div>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="viewRiskManagement()">⚙️ 风险设置</button>
            </div>
            
            <!-- 实时策略分析 -->
            <div class="card">
                <h2><span class="card-icon">📊</span>实时策略分析</h2>
                <div id="currentSignal" class="signal-display">
                    <div class="loading">正在获取最新信号...</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="signalStrength">--</div>
                        <div class="metric-label">信号强度</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="confidence">--</div>
                        <div class="metric-label">置信度</div>
                    </div>
                </div>
                <button class="btn" onclick="refreshSignal()">🔄 刷新信号</button>
            </div>

            <!-- 回测分析 -->
            <div class="card">
                <h2><span class="card-icon">🔬</span>回测分析</h2>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value">历史验证</div>
                        <div class="metric-label">策略有效性</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value">多维分析</div>
                        <div class="metric-label">性能评估</div>
                    </div>
                </div>
                <a href="/backtest" class="btn"><img src="/eth-logo.svg" alt="ETH" width="16" height="16" style="vertical-align:-3px;margin-right:6px"/> 开始回测</a>
                <button class="btn btn-success" onclick="viewBacktestHistory()">📋 历史记录</button>
            </div>
        </div>
        
        <div class="footer">
            <p>ETH合约策略分析系统 - 基于机器学习的智能量化交易平台</p>
            <div class="footer-links">
                <a href="/api/strategy/status">API状态</a>
                <a href="/api/risk/status">风险管理</a>
                <a href="/backtest">回测分析</a>
                <a href="/api/config">系统配置</a>
            </div>
        </div>
    </div>
    
    <script>
        // 页面初始化后的UI调整：删除三个板块并重排顺序
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const grid = document.querySelector('.main-grid');
                if (!grid) return;
                const getCardByTitle = (title) => {
                    const cards = Array.from(grid.querySelectorAll('.card'));
                    return cards.find(c => {
                        const h = c.querySelector('h2');
                        return h && h.textContent && h.textContent.includes(title);
                    });
                };
                // 删除不需要的三个板块
                ['风险管理','实时策略分析','回测分析'].forEach(t => {
                    const el = getCardByTitle(t);
                    if (el && el.parentElement === grid) el.remove();
                });
                // 确保“策略性能”在前，“推荐历史”在其后
                const perf = getCardByTitle('策略性能');
                const rec = getCardByTitle('推荐历史');
                if (grid && perf && rec && rec.previousElementSibling !== perf) {
                    grid.insertBefore(rec, perf.nextSibling);
                }
            } catch (e) {
                console.warn('UI auto adjust failed:', e);
            }
        });
        let updateInterval;
        let lastMarketOk = false;
        let lastMarketUpdate = 0;

        // 写操作后：拦截 fetch，针对关键写接口（/api/recommendations、/api/strategy/start|stop 等）
        // 在请求成功后触发一次“立即刷新”（带去抖，避免批量删除触发多次）
        (function(){
            const _origFetch = window.fetch.bind(window);
            let _refreshTimer = null;
            function scheduleImmediateRefresh(){
                if (_refreshTimer) clearTimeout(_refreshTimer);
                _refreshTimer = setTimeout(async () => {
                    try {
                        await loadRecommendationHistory();
                        await updateRecommendationStats();
                    } catch (e) {
                        console.warn('即时刷新失败：', e);
                    }
                }, 150); // 150ms 去抖
            }
            function shouldTriggerImmediateRefresh(url, method){
                // 统一为大写方法
                const m = String(method || 'GET').toUpperCase();
                // 推荐相关：新增/修改/删除/关闭
                if ((m === 'POST' || m === 'PUT' || m === 'DELETE') && /\/api\/recommendations(\b|\/)/.test(url)) return true;
                // 策略启停：可能影响后续推荐生成，刷新列表/统计更直观
                if (m === 'POST' && /\/api\/strategy\/(start|stop)(\b|\/)/.test(url)) return true;
                return false;
            }
            window.fetch = async function(input, init){
                const url = (typeof input === 'string') ? input : (input && input.url ? input.url : '');
                const method = (init && init.method) || (typeof input === 'object' && input && input.method) || 'GET';
                const res = await _origFetch(input, init);
                try {
                    if (res && res.ok && shouldTriggerImmediateRefresh(url, method)) scheduleImmediateRefresh();
                } catch (_) { /* ignore */ }
                return res;
            };
        })();

        // 工具函数：打开诊断页
        function openInspect() {
            window.open('/inspect.html','_blank');
        }

        // 数字格式化（USDT）
        function formatUSDT(val) {
            if (typeof val !== 'number' || !isFinite(val)) return '—';
            const abs = Math.abs(val);
            if (abs >= 1e9) return (val / 1e9).toFixed(2) + 'B USDT';
            if (abs >= 1e6) return (val / 1e6).toFixed(2) + 'M USDT';
            if (abs >= 1e3) return (val / 1e3).toFixed(2) + 'K USDT';
            return val.toFixed(2) + ' USDT';
        }

        // 时间格式化 HH:MM:SS
        function fmtTime(ts) {
            const d = new Date(ts);
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }
        
        // 请求工具：支持超时与指数退避重试
        async function requestJsonWithRetry(url, options = {}, cfg = { retries: 2, timeoutMs: 5000, backoffMs: 600 }) {
            let attempt = 0;
            let lastErr;
            while (attempt <= (cfg.retries ?? 0)) {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), cfg.timeoutMs ?? 5000);
                try {
                    const res = await fetch(url, { ...options, signal: controller.signal, cache: 'no-store' });
                    clearTimeout(timeout);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return await res.json();
                } catch (e) {
                    clearTimeout(timeout);
                    lastErr = e;
                    // 更新内联状态为重试中
                    const st = document.getElementById('marketInlineStatus');
                    if (st) {
                        st.className = 'inline-status warn';
                        st.textContent = '连接不稳定，正在重试...';
                    }
                    if (attempt === (cfg.retries ?? 0)) break;
                    const delay = (cfg.backoffMs ?? 600) * Math.pow(2, attempt);
                    await new Promise(r => setTimeout(r, delay));
                }
                attempt++;
            }
            throw lastErr;
        }
        
        // 页面加载时初始化
        window.onload = function() {
            // 优先加载“市场数据”，提升首屏感知速度
            loadMarketData();
            loadSystemStatus();
            loadLatestSignal();
            loadPerformanceData();
            loadTradeRecommendation();
            loadRecommendationHistory();
            
            // 启动自动更新
            updateInterval = setInterval(() => {
                loadLatestSignal();
                loadMarketData();
                updateUptime();
                loadTradeRecommendation();
                loadRecommendationHistory();
            }, 30000); // 30秒更新一次
        };
        
        // 加载系统状态（容错：元素不存在时跳过）
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/strategy/status');
                const data = await response.json();
                
                if (data.success) {
                    const el = document.getElementById('systemStatus');
                    if (el) {
                        el.textContent = data.data.isRunning ? '运行中' : '已停止';
                    }
                }
            } catch (error) {
                console.error('加载系统状态失败:', error);
            }
        }
        
        // 加载最新信号
        async function loadLatestSignal() {
            try {
                const response = await fetch('/api/strategy/analysis');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const s = data.data.signal || {};
                    const type = s.type || s.signal || (data.recommendation && data.recommendation.action) || '—';
                    
                    // 兼容多种强度结构：数值(0-1)或对象{ combined:0-100 }
                    let strengthVal = 0;
                    if (typeof s.strength === 'number') {
                        strengthVal = s.strength;
                    } else if (s.strength && typeof s.strength.combined === 'number') {
                        strengthVal = s.strength.combined;
                    }
                    if (strengthVal > 1) strengthVal = strengthVal / 100; // 归一化到[0,1]
                    
                    // 兼容多来源的置信度
                    let confidence = null;
                    if (typeof s.confidence === 'number') {
                        confidence = s.confidence;
                    } else if (s.strength && typeof s.strength.confidence === 'number') {
                        confidence = s.strength.confidence;
                    } else if (data.recommendation && typeof data.recommendation.confidence === 'number') {
                        confidence = data.recommendation.confidence;
                    }
                    
                    // 价格：优先使用 signal.price -> targetPrice -> market.price -> 支撑位
                    let price = null;
                    if (typeof s.price === 'number') {
                        price = s.price;
                    } else if (typeof s.targetPrice === 'number') {
                        price = s.targetPrice;
                    } else if (data.data.market && typeof data.data.market.price === 'number') {
                        price = data.data.market.price;
                    } else if (data.data.marketAnalysis && typeof data.data.marketAnalysis.support === 'number') {
                        price = data.data.marketAnalysis.support;
                    }
                    
                    const signalDiv = document.getElementById('currentSignal');
                    if (!signalDiv) return; // DOM尚未渲染，直接跳过
                    const strengthPct = isFinite(strengthVal) ? (strengthVal * 100) : 0;
                    const priceText = typeof price === 'number' ? price.toFixed(2) : '--';
                    const confText = typeof confidence === 'number' ? (confidence * 100).toFixed(1) + '%' : '--';
                    
                    signalDiv.innerHTML = `
                        <div class="signal-strength">
                            <strong>${type}</strong>
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: ${Math.max(0, Math.min(100, strengthPct))}%"></div>
                            </div>
                            <span>${isFinite(strengthPct) ? strengthPct.toFixed(1) : '--'}%</span>
                        </div>
                        <p>价格: $${priceText} | 置信度: ${confText}</p>
                    `;
                    
                    document.getElementById('signalStrength').textContent =
                        isFinite(strengthPct) ? strengthPct.toFixed(1) + '%' : '--';
                    document.getElementById('confidence').textContent = confText;
                        
                    // 更新风险管理数据（带健壮性检查）
                    if (data.data.riskManagement) {
                        const risk = data.data.riskManagement;
                        if (typeof risk.riskScore === 'number') document.getElementById('riskScore').textContent = risk.riskScore.toFixed(1);
                        if (typeof risk.positionSize === 'number') document.getElementById('positionSize').textContent = 
                            (risk.positionSize * 100).toFixed(1) + '%';
                        if (typeof risk.stopLoss === 'number') document.getElementById('stopLoss').textContent = '$' + risk.stopLoss.toFixed(2);
                        if (typeof risk.takeProfit === 'number') document.getElementById('takeProfit').textContent = '$' + risk.takeProfit.toFixed(2);
                    }
                } else {
                    const el = document.getElementById('currentSignal');
                    if (el) el.innerHTML = 
                        '<div class="loading">暂无信号数据</div>';
                }
            } catch (error) {
                console.error('加载信号失败:', error);
                const el = document.getElementById('currentSignal');
                if (el) el.innerHTML = 
                    '<div class="error">信号加载失败</div>';
            }
        }
        
        // 加载性能数据
        async function loadPerformanceData() {
            try {
                const response = await fetch('/api/strategy/performance');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const perf = data.data;
                    
                    // 安全地更新总收益率
                    const totalReturnEl = document.getElementById('totalReturn');
                    if (totalReturnEl) {
                        totalReturnEl.textContent = typeof perf.totalPnlPercent === 'number' 
                            ? (perf.totalPnlPercent * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                    
                    // 安全地更新胜率
                    const winRateEl = document.getElementById('winRate');
                    if (winRateEl) {
                        winRateEl.textContent = typeof perf.winRate === 'number' 
                            ? (perf.winRate * 100).toFixed(1) + '%' 
                            : '0.0%';
                    }
                    
                    // 安全地更新夏普比率
                    const sharpeRatioEl = document.getElementById('sharpeRatio');
                    if (sharpeRatioEl) {
                        sharpeRatioEl.textContent = typeof perf.sharpeRatio === 'number' 
                            ? perf.sharpeRatio.toFixed(2) 
                            : '0.00';
                    }
                    
                    // 安全地更新最大回撤
                    const maxDrawdownEl = document.getElementById('maxDrawdown');
                    if (maxDrawdownEl) {
                        maxDrawdownEl.textContent = typeof perf.maxDrawdown === 'number' 
                            ? (perf.maxDrawdown * 100).toFixed(2) + '%' 
                            : '0.00%';
                    }
                }
            } catch (error) {
                console.error('加载性能数据失败:', error);
            }
        }
        
        // 加载市场数据（增加重试与超时处理 + 内联状态提示）
        async function loadMarketData() {
            const priceEl = document.getElementById('currentPrice');
            const changeElLegacy = document.getElementById('priceChange');
            const changeSodEl = document.getElementById('marketChangeSod');
            // const changeEl = document.querySelector('#market-change'); // 已移除
            const volumeEl = document.getElementById('volume');
            const volEl = document.getElementById('volatility');
            const statusEl = document.getElementById('marketInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = '正在更新...';
            }
            try {
                // 降低首屏等待：将超时从5s降到2.5s，重试从2次降到1次，并减小退避
                const data = await requestJsonWithRetry('/api/market/ticker?symbol=ETH-USDT-SWAP', {}, { retries: 1, timeoutMs: 2500, backoffMs: 500 });
                if (data.success && data.data) {
                    const market = data.data;
                    if (typeof market.price === 'number') priceEl.textContent = '$' + market.price.toFixed(2);
                    // 统一仅展示 今日涨跌幅(UTC+8)
                    let sodPct = null;
                    if (typeof market.changeFromSodUtc8 === 'number') {
                        sodPct = market.changeFromSodUtc8; // 首选：API字段
                    } else if (typeof market.sodUtc8 === 'number' && typeof market.last === 'number' && market.sodUtc8 > 0) {
                        sodPct = ((market.last - market.sodUtc8) / market.sodUtc8) * 100; // 回退：基于sodUtc8
                    }
                    if (changeElLegacy) {
                        if (sodPct === null || !isFinite(sodPct)) {
                            changeElLegacy.textContent = '—';
                            changeElLegacy.style.color = '#6b7280';
                            changeElLegacy.title = '今日涨跌幅(UTC+8)暂无数据';
                        } else {
                            changeElLegacy.textContent = sodPct.toFixed(2) + '%';
                            changeElLegacy.style.color = sodPct >= 0 ? '#10b981' : '#ef4444';
                            changeElLegacy.title = '今日涨跌幅(UTC+8)：优先使用API字段changeFromSodUtc8；回退(last-sodUtc8)/sodUtc8。';
                        }
                    }
                    const turnoverUSDT = (typeof market.volume === 'number' && typeof market.price === 'number') ? (market.volume * market.price * 0.1) : NaN;
                    volumeEl.textContent = formatUSDT(turnoverUSDT);
                    const volText = (typeof market.volatility === 'number') ? (market.volatility * 100).toFixed(2) + '%' : '—';
                    volEl.textContent = volText;
            
                    lastMarketOk = true;
                    lastMarketUpdate = Date.now();
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        statusEl.textContent = '在线 · 已更新 ' + fmtTime(lastMarketUpdate);
                    }
                }
            } catch (error) {
                console.error('加载市场数据失败:', error);
                // 不清空已有数值，改为提示离线并提供重试
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.innerHTML = '离线 · 获取失败，<a href="#" onclick="refreshMarketData(); return false;">点击重试</a>' + (lastMarketUpdate ? (' · 上次更新 ' + fmtTime(lastMarketUpdate)) : '');
                }
            }
        }
        
        // 更新运行时间
        function updateUptime() {
            // 简单的运行时间计算
            const startTime = localStorage.getItem('systemStartTime');
            if (!startTime) {
                localStorage.setItem('systemStartTime', Date.now());
                return;
            }
            
            const uptime = Date.now() - parseInt(startTime);
            const hours = Math.floor(uptime / (1000 * 60 * 60));
            const minutes = Math.floor((uptime % (1000 * 60 * 60)) / (1000 * 60));
            const el = document.getElementById('uptime');
            if (el) el.textContent = `${hours}h ${minutes}m`;
        }
        
        // 刷新信号
        function refreshSignal() {
            loadLatestSignal();
        }
        
        // 刷新市场数据
        function refreshMarketData() {
            loadMarketData();
        }
        
        // 查看性能报告
        function viewPerformance() {
            window.open('/api/strategy/performance', '_blank');
        }
        
        // 查看风险管理
        function viewRiskManagement() {
            window.open('/api/risk/status', '_blank');
        }
        
        // 查看回测历史
        function viewBacktestHistory() {
            alert('回测历史功能开发中...');
        }
        

        // 加载开单推荐（脚本内）
        async function loadTradeRecommendation() {
            const container = document.getElementById('tradingRecommendation');
            if (!container) return;
            container.innerHTML = '<div class="loading">正在获取推荐信号...</div>';
            try {
                // 改为仅依赖 /api/active-recommendations
                const res = await fetch('/api/active-recommendations');
                const payload = await res.json();
                const d = payload?.data ?? payload;
                const list = Array.isArray(d?.recommendations)
                    ? d.recommendations
                    : Array.isArray(d)
                        ? d
                        : Array.isArray(d?.list)
                            ? d.list
                            : [];

                // 无活跃推荐：顶部红色横幅提示，推荐字段置空
                const hasActive = Array.isArray(list) && list.length > 0;
                if (!hasActive) {
                    container.innerHTML = '<div class="error">暂无推荐操作</div>';
                    const actionEl = document.getElementById('recommendedAction');
                    const entryEl = document.getElementById('entryPrice');
                    const levEl = document.getElementById('recommendedLeverage');
                    const posEl = document.getElementById('positionSizeRecommend');
                    if (actionEl) actionEl.textContent = '';
                    if (entryEl) entryEl.textContent = '';
                    if (levEl) levEl.textContent = '';
                    if (posEl) posEl.textContent = '';
                    window.__lastRecommendation = null;
                    return;
                }

                // 存在活跃推荐：渲染详细信息
                const latest = list
                    .slice()
                    .sort((a, b) => {
                        const ta = new Date(a?.updated_at || a?.created_at || 0).getTime();
                        const tb = new Date(b?.updated_at || b?.created_at || 0).getTime();
                        return tb - ta;
                    })[0] || list[0];

                const actionRaw = latest?.direction || latest?.action || '';
                const action = String(actionRaw).toUpperCase();

                const entryVal = (typeof latest?.entry_price === 'number')
                    ? latest.entry_price
                    : (typeof latest?.current_price === 'number' ? latest.current_price : null);
                const entry = (typeof entryVal === 'number') ? entryVal : '--';

                const levVal = (typeof latest?.leverage === 'number') ? latest.leverage : null;
                const leverage = (typeof levVal === 'number') ? (levVal + 'x') : '--';

                let posSize;
                if (typeof latest?.position_size === 'number') {
                    if (latest.position_size > 0 && latest.position_size <= 1) {
                        posSize = (latest.position_size * 100).toFixed(1) + '%';
                    } else {
                        posSize = String(latest.position_size);
                    }
                } else {
                    posSize = '--';
                }

                const tpVal = (typeof latest?.take_profit_price === 'number') ? latest.take_profit_price : (typeof latest?.take_profit === 'number' ? latest.take_profit : null);
                const slVal = (typeof latest?.stop_loss_price === 'number') ? latest.stop_loss_price : (typeof latest?.stop_loss === 'number' ? latest.stop_loss : null);
                const tp = (typeof tpVal === 'number') ? tpVal : '--';
                const sl = (typeof slVal === 'number') ? slVal : '--';

                const confRaw = (typeof latest?.confidence_score === 'number') ? latest.confidence_score : (typeof latest?.confidence === 'number' ? latest.confidence : null);
                const conf = (typeof confRaw === 'number') ? (((confRaw <= 1 ? confRaw * 100 : confRaw)).toFixed(1) + '%') : '--';

                container.innerHTML = `
                    <div class="row"><span class="key">推荐操作</span><span class="val">${action}</span></div>
                    <div class="row"><span class="key">入场价位</span><span class="val">${typeof entry === 'number' ? '$' + entry.toFixed(2) : entry}</span></div>
                    <div class="row"><span class="key">推荐杠杆</span><span class="val">${typeof leverage === 'number' ? leverage + 'x' : leverage}</span></div>
                    <div class="row"><span class="key">建议仓位</span><span class="val">${posSize}</span></div>
                    <div class="row"><span class="key">止盈/止损</span><span class="val">${typeof tp === 'number' ? '$' + tp.toFixed(2) : tp} / ${typeof sl === 'number' ? '$' + sl.toFixed(2) : sl}</span></div>
                    <div class="row"><span class="key">置信度</span><span class="val">${conf}</span></div>
                `;

                const actionEl = document.getElementById('recommendedAction');
                const entryEl = document.getElementById('entryPrice');
                const levEl = document.getElementById('recommendedLeverage');
                const posEl = document.getElementById('positionSizeRecommend');
                if (actionEl) actionEl.textContent = action;
                if (entryEl) entryEl.textContent = (typeof entry === 'number') ? '$' + entry.toFixed(2) : String(entry);
                if (levEl) levEl.textContent = (typeof leverage === 'number') ? leverage + 'x' : String(leverage);
                if (posEl) posEl.textContent = posSize;

                window.__lastRecommendation = { action, entry, leverage, posSize, tp, sl, conf };            } catch (err) {
                console.error('加载开单推荐失败:', err);
                container.innerHTML = '<div class="error">推荐加载失败</div>';
            }
        }

        // 新增：开多/开空按钮（演示提示）
        function openLongPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`准备开多:\n入场: ${formatPrice(rec.entry)}\n杠杆: ${formatLev(rec.leverage)}\n止盈: ${formatPrice(rec.tp)} / 止损: ${formatPrice(rec.sl)}\n仓位: ${rec.posSize || '--'}`);
        }
        function openShortPosition() {
            const rec = window.__lastRecommendation || {};
            alert(`准备开空:\n入场: ${formatPrice(rec.entry)}\n杠杆: ${formatLev(rec.leverage)}\n止盈: ${formatPrice(rec.tp)} / 止损: ${formatPrice(rec.sl)}\n仓位: ${rec.posSize || '--'}`);
        }
        function formatPrice(v){ return (typeof v === 'number') ? ('$' + v.toFixed(2)) : (v || '--'); }
        function formatLev(v){ return (typeof v === 'number') ? (v + 'x') : (v || '--'); }
        
        // 推荐历史相关功能
        let recommendationData = [];
        let filteredRecommendations = [];
        // 新增：分页状态
        let currentPage = 1;
        let pageSize = 5; // 默认每页5条
        const selectedRecommendationIds = new Set();
        // 来自后端的真实总数与活跃数（优先用于统计展示）
        let serverTotalRecommendations = null;
        let serverActiveRecommendationsCount = null;
        
        // 新增：获取当前页可见数据
        function getVisiblePageItems(){
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if (currentPage > totalPages) currentPage = totalPages; // 越界容错
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            return filteredRecommendations.slice(start, end);
        }

        function updateDeleteButtonState() {
            const btn = document.getElementById('deleteSelectedBtn');
            if (!btn) return;
            const count = selectedRecommendationIds.size;
            btn.disabled = count === 0;
            btn.textContent = `删除所选(${count})`;
        }
        function resetHeaderCheckbox() {
            const headerCb = document.getElementById('selectAllRecs');
            if (!headerCb) return;
            const visibleIds = getVisiblePageItems().map(r => r.id).filter(Boolean);
            if (visibleIds.length === 0) {
                headerCb.checked = false;
                headerCb.indeterminate = false;
                return;
            }
            const selectedVisible = visibleIds.filter(id => selectedRecommendationIds.has(id));
            headerCb.checked = selectedVisible.length === visibleIds.length && visibleIds.length > 0;
            headerCb.indeterminate = selectedVisible.length > 0 && selectedVisible.length < visibleIds.length;
        }
        function toggleSelectAll(cb){
            const shouldSelect = cb?.checked;
            getVisiblePageItems().forEach(rec => {
                if (!rec?.id) return;
                if (shouldSelect) {
                    selectedRecommendationIds.add(rec.id);
                } else {
                    selectedRecommendationIds.delete(rec.id);
                }
            });
            renderRecommendationList();
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        function onRowSelectChange(id, checked){
            if (!id) return;
            if (checked) selectedRecommendationIds.add(id); else selectedRecommendationIds.delete(id);
            updateDeleteButtonState();
            resetHeaderCheckbox();
        }
        
        // 加载推荐历史
        async function loadRecommendationHistory() {
            const statusEl = document.getElementById('recommendationInlineStatus');
            const listEl = document.getElementById('recommendationList');
            
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = '正在更新...';
            }
            
            try {
                const response = await fetch('/api/recommendations');
                const data = await response.json();
                
                // 兼容不同响应结构：
                // 1) { success: true, data: [...] }
                // 2) { success: true, data: { list: [...] , total, ... } }
                // 3) { list: [...] }
                const list = Array.isArray(data)
                  ? data
                  : Array.isArray(data?.data)
                    ? data.data
                    : Array.isArray(data?.data?.recommendations)
                      ? data.data.recommendations
                      : Array.isArray(data?.data?.list)
                        ? data.data.list
                        : Array.isArray(data?.list)
                          ? data.list
                          : [];
                // 读取后端总数（如果提供）
                serverTotalRecommendations =
                  (typeof data?.data?.total === 'number') ? data.data.total :
                  (typeof data?.total === 'number') ? data.total : null;
                
                if ((data?.success === true && list) || list.length > 0) {
                    recommendationData = list;
                    filteredRecommendations = [...recommendationData];
                    
                    // 应用当前筛选和排序
                    filterRecommendations();
                    sortRecommendations();
                    
                    // 更新统计信息
                    await updateRecommendationStats();
                    
                    if (statusEl) {
                        statusEl.className = 'inline-status ok';
                        // 若后端提供 total，则显示 total，否则显示当前批次条数
                        const shown = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
                        statusEl.textContent = `已加载 ${shown} 条（当前批次 ${recommendationData.length}）`;
                    }
                    // 清空占位内容（如果存在）
                    if (listEl && listEl.innerHTML && listEl.innerHTML.includes('正在加载推荐记录')) {
                        listEl.innerHTML = '';
                    }
                } else {
                    if (listEl) {
                        listEl.innerHTML = '<div class="error">暂无推荐记录</div>';
                    }
                    if (statusEl) {
                        statusEl.className = 'inline-status warn';
                        statusEl.textContent = '暂无数据';
                    }
                }
            } catch (error) {
                console.error('加载推荐历史失败:', error);
                if (listEl) {
                    listEl.innerHTML = '<div class="error">加载失败，请稍后重试</div>';
                }
                if (statusEl) {
                    statusEl.className = 'inline-status err';
                    statusEl.textContent = '加载失败';
                }
            }
        }
        
        // 渲染推荐列表到表格（支持分页）
        function renderRecommendationList() {
            const tableBodyEl = document.getElementById('recommendationTableBody');
            if (!tableBodyEl) return;
            
            if (filteredRecommendations.length === 0) {
                tableBodyEl.innerHTML = '<tr><td colspan="10" class="loading">暂无符合条件的推荐记录</td></tr>';
                renderPagination();
                resetHeaderCheckbox();
                return;
            }
            const pageItems = getVisiblePageItems();
            if (pageItems.length === 0) {
                currentPage = Math.max(1, currentPage - 1);
                return renderRecommendationList();
            }
            
            const html = pageItems.map(rec => {
                const time = new Date(rec.created_at || rec.timestamp).toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const actionRaw = rec.direction || rec.action || 'HOLD';
                const action = String(actionRaw).toUpperCase();
                const status = rec.status || 'PENDING';
                const pnl = rec.pnl_percent || rec.pnl_percentage || 0;
                const pnlClass = pnl > 0 ? 'positive' : pnl < 0 ? 'negative' : '';
                const confidence = rec.confidence_score || rec.confidence || 0;
                const accent = action === 'LONG' ? 'accent-long' : (action === 'SHORT' ? 'accent-short' : 'accent-hold');
                const isChecked = rec.id ? selectedRecommendationIds.has(rec.id) : false;
                
                // 状态显示映射
                const statusMap = {
                    'PENDING': '待确认',
                    'ACTIVE': '进行中',
                    'CLOSED': '已平仓',
                    'EXPIRED': '已过期'
                };
                
                return `
                    <tr class="recommendation-row ${status.toLowerCase()} ${accent}">
                        <td style="text-align:center"><input type="checkbox" ${isChecked ? 'checked' : ''} ${rec.id ? '' : 'disabled'} onchange="onRowSelectChange('${rec.id ?? ''}', this.checked)"/></td>
                        <td>${time}</td>
                        <td><span class="action-badge ${action.toLowerCase()}">${action}</span></td>
                        <td>${formatPrice(rec.entry_price)}</td>
                        <td>${formatLev(rec.leverage)}</td>
                        <td>${formatPrice(rec.take_profit_price || rec.take_profit)}</td>
                        <td>${formatPrice(rec.stop_loss_price || rec.stop_loss)}</td>
                        <td>${confidence ? (confidence * 100).toFixed(1) + '%' : '--'}</td>
                        <td><span class="status-badge ${status.toLowerCase()}">${statusMap[status] || status}</span></td>
                        <td><span class="pnl-value ${pnlClass}">${pnl ? (pnl > 0 ? '+' : '') + pnl.toFixed(2) + '%' : '--'}</span></td>
                    </tr>
                `;
            }).join('');
            
            tableBodyEl.innerHTML = html;
            renderPagination();
            resetHeaderCheckbox();
        }
        
        // 筛选推荐（重置到第1页）
        function filterRecommendations() {
            const statusFilter = document.getElementById('statusFilter')?.value || 'all';
            
            if (statusFilter === 'all') {
                filteredRecommendations = [...recommendationData];
            } else if (statusFilter === 'ACTIVE') {
                filteredRecommendations = recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'PENDING');
            } else {
                filteredRecommendations = recommendationData.filter(rec => rec.status === statusFilter);
            }
            currentPage = 1;
            renderRecommendationList();
        }
        
        // 排序推荐（重置到第1页）
        function sortRecommendations() {
            const sortBy = document.getElementById('sortBy')?.value || 'created_at';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';
            
            filteredRecommendations.sort((a, b) => {
                let aVal, bVal;
                
                switch (sortBy) {
                    case 'created_at':
                        aVal = new Date(a.created_at || a.timestamp);
                        bVal = new Date(b.created_at || b.timestamp);
                        break;
                    case 'pnl_percent':
                        aVal = a.pnl_percent || a.pnl_percentage || 0;
                        bVal = b.pnl_percent || b.pnl_percentage || 0;
                        break;
                    case 'confidence_score':
                        aVal = a.confidence_score || a.confidence || 0;
                        bVal = b.confidence_score || b.confidence || 0;
                        break;
                    default:
                        return 0;
                }
                
                if (sortOrder === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
            currentPage = 1;
            renderRecommendationList();
        }
        
        // 新增：渲染分页
        function renderPagination(){
            const el = document.getElementById('recommendationPagination');
            if (!el) return;
            const total = filteredRecommendations.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const maxShown = 5;
            let start = Math.max(1, currentPage - Math.floor(maxShown/2));
            let end = Math.min(totalPages, start + maxShown - 1);
            start = Math.max(1, Math.min(start, Math.max(1, end - maxShown + 1)));

            const pageNumbers = [];
            for (let p = start; p <= end; p++) {
                pageNumbers.push(`<button class="page-number ${p===currentPage?'active':''}" onclick="goToPage(${p})">${p}</button>`);
            }

            el.innerHTML = `
                <button class="page-btn" onclick="goToPage(${currentPage-1})" ${currentPage<=1?'disabled':''}>上一页</button>
                ${pageNumbers.join('')}
                <button class="page-btn" onclick="goToPage(${currentPage+1})" ${currentPage>=totalPages?'disabled':''}>下一页</button>
                <span class="page-info">共 ${total} 条 · 每页 ${pageSize} 条 · 第 ${currentPage}/${totalPages} 页</span>
            `;
        }

        // 新增：翻页函数
        function goToPage(p){
            const totalPages = Math.max(1, Math.ceil(filteredRecommendations.length / pageSize));
            currentPage = Math.min(Math.max(1, p), totalPages);
            renderRecommendationList();
        }
        window.goToPage = goToPage;
        
        // 更新推荐统计（使用后端真实 total/active、综合统计中的胜率与平均收益）
        async function updateRecommendationStats() {
            const total = (typeof serverTotalRecommendations === 'number') ? serverTotalRecommendations : recommendationData.length;
            // 异步获取真实活跃数（兼容 {data:{recommendations, count}} 结构）
            try {
                const res = await fetch('/api/active-recommendations');
                if (res.ok) {
                    const act = await res.json();
                    const payload = act?.data ?? act;
                    const arr = Array.isArray(payload?.recommendations)
                        ? payload.recommendations
                        : Array.isArray(payload)
                            ? payload
                            : Array.isArray(payload?.list)
                                ? payload.list
                                : [];
                    serverActiveRecommendationsCount = Array.isArray(arr) ? arr.length : null;
                }
            } catch(e) {
                console.warn('获取活跃推荐失败，回退到本地统计', e);
            }
            const active = (typeof serverActiveRecommendationsCount === 'number')
                ? serverActiveRecommendationsCount
                : recommendationData.filter(rec => rec.status === 'ACTIVE' || rec.status === 'active').length;

            // 胜率与平均收益优先读取综合统计接口（全量已平仓口径），失败回退到本地样本
            let winRateFromServer = null;
            let avgPnlFromServer = null;
            try {
                const res2 = await fetch('/api/statistics/overall');
                if (res2.ok) {
                    const ov = await res2.json();
                    const d = ov?.data ?? ov;
                    if (typeof d?.overall_win_rate === 'number') winRateFromServer = d.overall_win_rate;
                    if (typeof d?.overall_avg_pnl === 'number') avgPnlFromServer = d.overall_avg_pnl;
                    // 若此前未获得 total/active，可从统计接口补齐
                    if (typeof serverTotalRecommendations !== 'number' && typeof d?.total_recommendations === 'number') {
                        serverTotalRecommendations = d.total_recommendations;
                    }
                    if (typeof serverActiveRecommendationsCount !== 'number' && typeof d?.active_recommendations === 'number') {
                        serverActiveRecommendationsCount = d.active_recommendations;
                    }
                }
            } catch (e) {
                console.warn('获取综合统计失败，回退到本地样本统计', e);
            }

            const completed = recommendationData.filter(rec => rec.status === 'CLOSED' || rec.status === 'completed');
            const localWinRate = completed.length > 0 ? 
                (completed.filter(rec => (rec.pnl_percent || rec.pnl_percentage || 0) > 0).length / completed.length * 100) : 0;
            const localAvgPnl = completed.length > 0 ? 
                (completed.reduce((sum, rec) => sum + (rec.pnl_percent || rec.pnl_percentage || 0), 0) / completed.length) : 0;
            const winRate = (typeof winRateFromServer === 'number') ? winRateFromServer : localWinRate;
            const avgPnl = (typeof avgPnlFromServer === 'number') ? avgPnlFromServer : localAvgPnl;
            
            document.getElementById('totalRecommendations').textContent = total;
            document.getElementById('activeRecommendations').textContent = active;
            document.getElementById('winRateRecommendations').textContent = `${winRate.toFixed(1)}%`;
            document.getElementById('avgPnlRecommendations').textContent = `${avgPnl.toFixed(2)}%`;
        }
        
        // 刷新推荐历史
        function refreshRecommendations() { loadRecommendationHistory(); }
        
        // 批量删除所选推荐
        async function deleteSelectedRecommendations(){
            const ids = Array.from(selectedRecommendationIds);
            if (ids.length === 0) return;
            if (!confirm(`确认删除选中的 ${ids.length} 条记录？此操作不可撤销。`)) return;
            const statusEl = document.getElementById('recommendationInlineStatus');
            if (statusEl) {
                statusEl.className = 'inline-status warn';
                statusEl.textContent = '正在删除...';
            }
            document.getElementById('deleteSelectedBtn')?.setAttribute('disabled','true');
            // 逐个调用后端删除接口
            const results = await Promise.allSettled(ids.map(id => fetch(`/api/recommendations/${id}`, { method: 'DELETE' })));
            let ok = 0, fail = 0;
            for (const r of results) {
                if (r.status === 'fulfilled' && r.value?.ok) ok++; else fail++;
            }
            // 清理选择 & 刷新
            selectedRecommendationIds.clear();
            updateDeleteButtonState();
            await loadRecommendationHistory();
            // 确保统计同步服务端
            await updateRecommendationStats();
            if (statusEl) {
                statusEl.className = fail === 0 ? 'inline-status ok' : 'inline-status warn';
                statusEl.textContent = fail === 0 ? '删除完成' : `部分删除失败 (${ok}/${ids.length})`;
            }
            if (fail > 0) {
                alert(`删除完成：成功 ${ok} 条，失败 ${fail} 条。`);
            }
        }
        
        // 启动策略
        async function startStrategy() {
            try {
                const response = await fetch('/api/strategy/start', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('策略启动成功！');
                    loadSystemStatus();
                } else {
                    alert('策略启动失败: ' + data.error);
                }
            } catch (error) {
                alert('请求失败: ' + error.message);
            }
        }
        
        // 停止策略
        async function stopStrategy() {
            try {
                const response = await fetch('/api/strategy/stop', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    alert('策略已停止！');
                    loadSystemStatus();
                } else {
                    alert('策略停止失败: ' + data.error);
                }
            } catch (error) {
                alert('请求失败: ' + error.message);
            }
        }
        
        // 重启策略
        async function restartStrategy() {
            if (confirm('确定要重启策略吗？')) {
                await stopStrategy();
                setTimeout(() => {
                    startStrategy();
                }, 2000);
            }
        }
        
        // 页面卸载时清理
        window.onbeforeunload = function() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        };
    </script>
</body>
</html>
